{"version":3,"file":"freedom-for-chrome.js","sources":["node_modules/freedom/providers/core/peerconnection.unprivileged.js","node_modules/es6-promise/dist/promise-1.0.0.js","node_modules/freedom/src/apis.js","node_modules/freedom/src/entry.js","node_modules/freedom/src/hub.js","node_modules/freedom/src/link.js","node_modules/freedom/src/policy.js","node_modules/freedom/src/port-debug.js","node_modules/freedom/src/port-manager.js","node_modules/freedom/src/port-module.js","node_modules/freedom/src/port-moduleinternal.js","node_modules/freedom/src/port-provider.js","node_modules/freedom/src/port-proxy.js","node_modules/freedom/src/resource.js","node_modules/freedom/src/util.js","node_modules/freedom/src/link/direct.js","node_modules/freedom/src/link/frame.js","node_modules/freedom/src/link/worker.js","node_modules/freedom/src/proxy/apiInterface.js","node_modules/freedom/src/proxy/eventInterface.js","node_modules/freedom/interface/core.js","node_modules/freedom/interface/social.js","node_modules/freedom/interface/storage.js","node_modules/freedom/interface/transport.js","node_modules/freedom/providers/core/core.unprivileged.js","node_modules/freedom/providers/core/echo.unprivileged.js","node_modules/freedom/providers/core/websocket.unprivileged.js","node_modules/freedom/providers/core/view.unprivileged.js","providers/storage.js","providers/tcpsocket.js","providers/udpsocket.js"],"names":["SimpleDataPeer","peerName","stunServers","dataChannelCallbacks","mocks","constraints","config","i","this","channels","onConnectedQueue","RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","Error","RTCSessionDescription","mozRTCSessionDescription","RTCIceCandidate","mozRTCIceCandidate","optional","DtlsSrtpKeyAgreement","sendSignalMessage","pc","iceServers","length","push","url","addEventListener","onIceCallback","bind","onNegotiationNeeded","onDataChannel","signalingState","pcState","SimpleDataPeerState","CONNECTED","map","callback","DISCONNECTED","PeerConnection","portModule","dispatchEvent","Math","random","freedomModule","signallingChannel","peer","once","Core","core","emit","controlChannel","type","request","define","requireModule","require","requirejs","registry","seen","name","deps","resolve","child","charAt","parts","split","parentBase","slice","l","part","pop","join","_eak_seen","exports","mod","reified","value","apply","__dependency1__","__exports__","all","promises","Promise","isArray","TypeError","reject","resolver","index","resolveAll","results","remaining","promise","isFunction","then","useNextTick","process","nextTick","flush","useMutationObserver","iterations","observer","BrowserMutationObserver","node","document","createTextNode","observe","characterData","data","useSetTimeout","local","setTimeout","queue","tuple","arg","asap","scheduleFlush","browserGlobal","window","MutationObserver","WebKitMutationObserver","global","undefined","toString","call","configure","arguments","instrument","__dependency2__","polyfill","self","es6PromiseSupport","r","RSVPPromise","__dependency3__","__dependency4__","__dependency5__","__dependency6__","__dependency7__","_subscribers","invokeResolver","resolvePromise","rejectPromise","reason","e","invokeCallback","settled","detail","error","succeeded","failed","hasCallback","handleThenable","FULFILLED","REJECTED","subscribe","parent","onFulfillment","onRejection","subscribers","publish","_detail","resolved","objectOrFunction","val","fulfill","_state","PENDING","SEALED","async","publishFulfillment","publishRejection","now","race","staticResolve","staticReject","prototype","constructor","thenPromise","callbacks","catch","x","Object","Date","getTime","fdom","Api","apis","providers","waiters","get","api","definition","set","register","getCore","from","debug","warn","setup","freedom_src","port","Debug","link","hub","Hub","site_cfg","stayLocal","portType","moduleContext","isModule","util","isModuleContext","manager","Manager","external","Proxy","proxy","EventInterface","mixin","src","createLink","advertise","eachReverse","scripts","script","manifest","getAttribute","source","textContent","trim","JSON","parse","resources","location","protocol","host","pathname","policy","Policy","root_mod","err","console","getInterface","route","round","apps","routes","unbound","handleEvents","on","onMessage","message","destination","app","quiet","action","log","flow","getDestination","getSource","id","force","deregister","install","generateRoute","uninstall","off","Link","deliverMessage","channel","start","emitMessage","runtimes","policies","add","defaultPolicy","background","interactive","defaultConstraints","isolation","placement","lineage","loadManifest","portId","overlay","runtime","findDestination","isRunning","getPort","Module","fullMatch","okay","j","modules","indexOf","getContents","manifestId","info","modFingerprint","splice","base","ret","emitChannel","format","severity","args","alist","msg","stringify","print","Boolean","arr","substr","unshift","__mozillaConsole__","toUpperCase","controlFlows","dataFlows","reverseFlowMap","delegate","toDelegate","origin","reverseFlow","to","overrideDest","exposeManager","service","addResolver","addRetriever","destroy","removeLink","reverse","destName","toDest","outgoingName","outgoing","rflow","forgetFlow","cb","manifestURL","creator","concat","externalPortMap","internalPortMap","started","stop","deregisterFlow","provides","modInternal","internal","key","loadLinks","reply","appId","dep","finishLink","provider","provideAsynchronous","permissions","Provider","dependencies","eachProp","desc","updateEnv","metadata","icon","description","serialize","ModuleInternal","manifests","pendingPorts","requests","defaultProvider","updateManifest","externalChannel","objects","mapProxies","loadScripts","exp","freedom","attach","getProxyInterface","items","def","ApiInterface","CoreProv","setId","obj","proxies","safe","importer","importScripts","urls","outstanding","load","tryLoad","createElement","body","appendChild","stack","nextId","mode","synchronous","iface","providerCls","providerInstances","asynchronous","close","portableToMessage","getProvider","provideSynchronous","prov","providePromises","prop","defineProperty","recursiveFreezeObject","writable","func","p","ifaces","candidate","teardown","onClose","handler","handlers","identifier","BoundClass","instance","events","ev","streams","messageToPortable","text","binary","reqId","Array","interfaceCls","closeHandlers","errorHandlers","emits","doClose","Iface","getInterfaceConstructor","onError","binder","doEmit","Resource","files","resolvers","httpResolver","nullResolver","contentRetrievers","http","xhrRetriever","https","chrome-extension","resource","chrome","file","manifestRetriever","address","hasOwnProperty","values","proto","retriever","hasScheme","protocols","dirname","protocolIdx","pathIdx","path","lastIndexOf","ref","XMLHttpRequest","readyState","responseText","status","overrideMimeType","open","send","ary","hasProp","target","getId","buffer","guid","domain","crypto","Uint8Array","getRandomValues","n","ceil","filter","eventState","multiple","maybemultiple","single","maybesingle","list","predicate","item","forceModuleContext","blob","idx","funcidx","getBlob","getURL","Blob","WebKitBlobBuilder","builder","append","URL","webkitURL","createObjectURL","freedomcfg","getElementsByTagName","Direct","directLink","other","Frame","DEBUG","setupListener","setupFrame","onMsg","removeEventListener","frame","makeFrame","inject","contentWindow","removeChild","loader","extra","replace","postMessage","Worker","setupWorker","worker","inflight","emitter","thisReq","template","externals","conform","separate","String","Number","makeArrayBuffer","thing","ArrayBuffer","DataView","k","enumerable","createChannel","bindChannel","code","show","keys","remove","clear","getInfo","connected","localAddress","localPort","peerAddress","peerPort","errcode","onDisconnect","connect","write","onData","listen","onConnection","socket","sendTo","resultCode","createApp","needFile","channelLabel","onReceived","openDataChannel","closeDataChannel","onOpenDataChannel","channelId","onCloseDataChannel","getBufferedAmount","getReadyState","onOpen","wasClean","ERRCODE","SUCCESS","UNKNOWN","OFFLINE","LOGIN_BADCREDENTIALS","LOGIN_FAILEDCONNECTION","LOGIN_ALREADYONLINE","SEND_INVALIDDESTINATION","STATUS","ONLINE","ONLINE_WITH_OTHER_APP","login","agent","version","rememberLogin","userId","clientId","timestamp","clearCachedCredentials","getClients","getUsers","sendMessage","logout","onUserProfile","imageData","onClientState","scope","SESSION","DEVICE_LOCAL","USER_LOCAL","SHARED","tag","Core_unprivileged","unboundChannels","contextId","continuation","chan","getChannel","remote","toBind","newSource","Echo_unprivileged","m","str","CONNECTING","runWhenConnected","dataChannel","createDataChannel","onopen","addDataChannel","onerror","negotiateConnection","closeChannel","bufferedAmount","setSendSignalMessage","sendSignalMessageFn","handleSignalMessage","messageText","json","sdp","setRemoteDescription","remoteDescription","createAnswer","onDescription","ice_candidate","addIceCandidate","createOffer","onOpenFn","label","onclose","onCloseFn","onmessage","onMessageFn","onErrorFn","setLocalDescription","logSuccess","logFail","localDescription","event","onSignalingStateChange","signallingChannelId","sendInfo","objToSend","WS","module","WSImplementation","WebSocket","websocket","SyntaxError","toSend","errorCode","View_unprivileged","win","what","style","width","height","display","root","container","views","getElementById","setAttribute","fname","finishOpen","border","parentNode","Storage_chrome","dispatch","dispatchEvents","storage","diff","Socket_chrome","read","hostname","create","createInfo","socketId","result","ERROR_MAP","-1","-2","-3","-4","-5","-7","-13","-15","-21","-23","-100","-101","-102","-103","-104","-105","-106","loop","doRead","checkReadResult","readInfo","accept","acceptCallback","acceptInfo","disconnect","UdpSocket_chrome","createResult","bindResult","recvFrom","recvFromInfo","writeInfo","bytesWritten"],"mappings":"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","sourcesContent":["/*globals fdom:true, console, RTCPeerConnection, webkitRTCPeerConnection */\n/*globals mozRTCPeerConnection, RTCSessionDescription, RTCIceCandidate */\n/*globals mozRTCSessionDescription, mozRTCIceCandidate */\n/*globals ArrayBuffer */\n/*jslint indent:2,sloppy:true */\n/**\n * DataPeer - a class that wraps peer connections and data channels.\n */\n// TODO: check that Handling of pranswer is treated appropriately.\nvar SimpleDataPeerState = {\n  DISCONNECTED: 'DISCONNECTED',\n  CONNECTING: 'CONNECTING',\n  CONNECTED: 'CONNECTED'\n};\n\nfunction SimpleDataPeer(peerName, stunServers, dataChannelCallbacks, mocks) {\n  var constraints,\n      config,\n      i;\n  this.peerName = peerName;\n  this.channels = {};\n  this.dataChannelCallbacks = dataChannelCallbacks;\n  this.onConnectedQueue = [];\n\n  if (typeof mocks.RTCPeerConnection !== \"undefined\") {\n    this.RTCPeerConnection = mocks.RTCPeerConnection;\n  } else if (typeof webkitRTCPeerConnection !== \"undefined\") {\n    this.RTCPeerConnection = webkitRTCPeerConnection;\n  } else if (typeof mozRTCPeerConnection !== \"undefined\") {\n    this.RTCPeerConnection = mozRTCPeerConnection;\n  } else {\n    throw new Error(\"This environment does not appear to support RTCPeerConnection\");\n  }\n\n  if (typeof mocks.RTCSessionDescription !== \"undefined\") {\n    this.RTCSessionDescription = mocks.RTCSessionDescription;\n  } else if (typeof RTCSessionDescription !== \"undefined\"){\n    this.RTCSessionDescription = RTCSessionDescription;\n  } else if (typeof mozRTCSessionDescription !== \"undefined\") {\n    this.RTCSessionDescription = mozRTCSessionDescription;\n  } else {\n    throw new Error(\"This environment does not appear to support RTCSessionDescription\");\n  }\n\n  if (typeof mocks.RTCIceCandidate !== \"undefined\") {\n    this.RTCIceCandidate = mocks.RTCIceCandidate;\n  } else if (typeof RTCIceCandidate !== \"undefined\"){\n    this.RTCIceCandidate = RTCIceCandidate;\n  } else if (typeof  mozRTCIceCandidate !== \"undefined\") {\n    this.RTCIceCandidate = mozRTCIceCandidate;\n  } else {\n    throw new Error(\"This environment does not appear to support RTCIceCandidate\");\n  }\n\n\n  constraints = {\n    optional: [{DtlsSrtpKeyAgreement: true}]\n  };\n  // A way to speak to the peer to send SDP headers etc.\n  this.sendSignalMessage = null;\n\n  this.pc = null;  // The peer connection.\n  // Get TURN servers for the peer connection.\n  config = {iceServers: []};\n  for (i = 0; i < stunServers.length; i += 1) {\n    config.iceServers.push({\n      'url' : stunServers[i]\n    });\n  }\n  this.pc = new this.RTCPeerConnection(config, constraints);\n  // Add basic event handlers.\n  this.pc.addEventListener(\"icecandidate\",\n                            this.onIceCallback.bind(this));\n  this.pc.addEventListener(\"negotiationneeded\",\n                            this.onNegotiationNeeded.bind(this));\n  this.pc.addEventListener(\"datachannel\",\n                            this.onDataChannel.bind(this));\n  this.pc.addEventListener(\"signalingstatechange\", function () {\n    if (this.pc.signalingState === \"stable\") {\n      this.pcState = SimpleDataPeerState.CONNECTED;\n      this.onConnectedQueue.map(function(callback) { callback(); });\n    }\n  }.bind(this));\n  // This state variable is used to fake offer/answer when they are wrongly\n  // requested and we really just need to reuse what we already have.\n  this.pcState = SimpleDataPeerState.DISCONNECTED;\n\n  // Note: to actually do something with data channels opened by a peer, we\n  // need someone to manage \"datachannel\" event.\n}\n\nSimpleDataPeer.prototype.runWhenConnected = function (func) {\n  if (this.pcState === SimpleDataPeerState.CONNECTED) {\n    func();\n  } else {\n    this.onConnectedQueue.push(func);\n  }\n};\n\nSimpleDataPeer.prototype.send = function (channelId, message, continuation) {\n  this.channels[channelId].send(message);\n  continuation();\n};\n\nSimpleDataPeer.prototype.openDataChannel = function (channelId, continuation) {\n  var dataChannel = this.pc.createDataChannel(channelId, {});\n  dataChannel.onopen = function () {\n    this.addDataChannel(channelId, dataChannel);\n    continuation();\n  }.bind(this);\n  dataChannel.onerror = function(err) {\n    //@(ryscheng) todo - replace with errors that work across the interface\n    console.error(err);\n    continuation(undefined, err);\n  };\n  // Firefox does not fire \"negotiationneeded\", so we need to\n  // negotate here if we are not connected.\n  // See https://bugzilla.mozilla.org/show_bug.cgi?id=840728\n  if (typeof mozRTCPeerConnection !== \"undefined\" &&\n      this.pcState === SimpleDataPeerState.DISCONNECTED) {\n    this.negotiateConnection();\n  }\n};\n\nSimpleDataPeer.prototype.closeChannel = function (channelId) {\n  if (this.channels[channelId] !== undefined) {\n    this.channels[channelId].close();\n    delete this.channels[channelId];\n  }\n};\n\nSimpleDataPeer.prototype.getBufferedAmount = function (channelId,\n                                                       continuation) {\n  if (this.channels[channelId] !== undefined) {\n    var dataChannel = this.channels[channelId];\n    return dataChannel.bufferedAmount;\n  }\n  throw new Error(\"No channel with id: \" + channelId);\n};\n\nSimpleDataPeer.prototype.setSendSignalMessage = function (sendSignalMessageFn) {\n  this.sendSignalMessage = sendSignalMessageFn;\n};\n\n// Handle a message send on the signalling channel to this peer.\nSimpleDataPeer.prototype.handleSignalMessage = function (messageText) {\n  //console.log(this.peerName + \": \" + \"handleSignalMessage: \\n\" + messageText);\n  var json = JSON.parse(messageText);\n\n  // TODO: If we are offering and they are also offerring at the same time,\n  // pick the one who has the lower randomId?\n  // (this.pc.signalingState == \"have-local-offer\" && json.sdp &&\n  //    json.sdp.type == \"offer\" && json.sdp.randomId < this.localRandomId)\n  if (json.sdp) {\n    // Set the remote description.\n    this.pc.setRemoteDescription(\n      new this.RTCSessionDescription(json.sdp),\n      // Success\n      function () {\n        //console.log(this.peerName + \": setRemoteDescription succeeded\");\n        if (this.pc.remoteDescription.type === \"offer\") {\n          this.pc.createAnswer(this.onDescription.bind(this),\n                               console.error);\n        }\n      }.bind(this),\n      // Failure\n      function (e) {\n        console.error(this.peerName + \": \" +\n            \"setRemoteDescription failed:\", e);\n      }.bind(this)\n    );\n  } else if (json.candidate) {\n    // Add remote ice candidate.\n    //console.log(this.peerName + \": Adding ice candidate: \" + JSON.stringify(json.candidate));\n    var ice_candidate = new this.RTCIceCandidate(json.candidate);\n    this.pc.addIceCandidate(ice_candidate);\n  } else {\n    console.warn(this.peerName + \": \" +\n        \"handleSignalMessage got unexpected message: \", messageText);\n  }\n};\n\n// Connect to the peer by the signalling channel.\nSimpleDataPeer.prototype.negotiateConnection = function () {\n  this.pcState = SimpleDataPeerState.CONNECTING;\n  this.pc.createOffer(\n    this.onDescription.bind(this),\n    function (e) {\n      console.error(this.peerName + \": \" +\n          \"createOffer failed: \", e.toString());\n      this.pcState = SimpleDataPeerState.DISCONNECTED;\n    }.bind(this)\n  );\n};\n\nSimpleDataPeer.prototype.close = function () {\n  if (this.pc.signalingState !== \"closed\") {\n    this.pc.close();\n  }\n  //console.log(this.peerName + \": \" + \"Closed peer connection.\");\n};\n\nSimpleDataPeer.prototype.addDataChannel = function (channelId, channel) {\n  var callbacks = this.dataChannelCallbacks;\n  this.channels[channelId] = channel;\n\n  if (channel.readyState === \"connecting\") {\n    channel.onopen = callbacks.onOpenFn.bind(this, channel, {label: channelId});\n  }\n\n  channel.onclose = callbacks.onCloseFn.bind(this, channel, {label: channelId});\n\n  channel.onmessage = callbacks.onMessageFn.bind(this, channel,\n                                                 {label: channelId});\n\n  channel.onerror = callbacks.onErrorFn.bind(this, channel, {label: channel});\n};\n\n// When we get our description, we set it to be our local description and\n// send it to the peer.\nSimpleDataPeer.prototype.onDescription = function (description) {\n  if (this.sendSignalMessage) {\n    this.pc.setLocalDescription(\n      description,\n      function () {\n        //console.log(this.peerName + \": setLocalDescription succeeded\");\n        this.sendSignalMessage(JSON.stringify({'sdp': description}));\n      }.bind(this),\n      function (e) {\n        console.error(this.peerName + \": \" +\n            \"setLocalDescription failed:\", e);\n      }.bind(this)\n    );\n  } else {\n    console.error(this.peerName + \": \" +\n        \"_onDescription: _sendSignalMessage is not set, so we did not \" +\n            \"set the local description. \");\n  }\n};\n\nSimpleDataPeer.prototype.onNegotiationNeeded = function (e) {\n  //console.log(this.peerName + \": \" + \"onNegotiationNeeded\", this._pc, e);\n  if (this.pcState !== SimpleDataPeerState.DISCONNECTED) {\n    // Negotiation messages are falsely requested for new data channels.\n    //   https://code.google.com/p/webrtc/issues/detail?id=2431\n    // This code is a hack to simply reset the same local and remote\n    // description which will trigger the appropriate data channel open event.\n    // TODO: fix/remove this when Chrome issue is fixed.\n    var logSuccess = function (op) {\n      return function () {\n        //console.log(this.peerName + \": \" + op + \" succeeded \");\n      }.bind(this);\n    }.bind(this),\n      logFail = function (op) {\n        return function (e) {\n          //console.log(this.peerName + \": \" + op + \" failed: \" + e);\n        }.bind(this);\n      }.bind(this);\n    if (this.pc.localDescription && this.pc.remoteDescription &&\n        this.pc.localDescription.type === \"offer\") {\n      this.pc.setLocalDescription(this.pc.localDescription,\n                                   logSuccess(\"setLocalDescription\"),\n                                   logFail(\"setLocalDescription\"));\n      this.pc.setRemoteDescription(this.pc.remoteDescription,\n                                    logSuccess(\"setRemoteDescription\"),\n                                    logFail(\"setRemoteDescription\"));\n    } else if (this.pc.localDescription && this.pc.remoteDescription &&\n        this.pc.localDescription.type === \"answer\") {\n      this.pc.setRemoteDescription(this.pc.remoteDescription,\n                                    logSuccess(\"setRemoteDescription\"),\n                                    logFail(\"setRemoteDescription\"));\n      this.pc.setLocalDescription(this.pc.localDescription,\n                                   logSuccess(\"setLocalDescription\"),\n                                   logFail(\"setLocalDescription\"));\n    }\n    return;\n  }\n  this.negotiateConnection();\n};\n\nSimpleDataPeer.prototype.onIceCallback = function (event) {\n  if (event.candidate) {\n    // Send IceCandidate to peer.\n    //console.log(this.peerName + \": \" + \"ice callback with candidate\", event);\n    if (this.sendSignalMessage) {\n      this.sendSignalMessage(JSON.stringify({'candidate': event.candidate}));\n    } else {\n      console.warn(this.peerName + \": \" + \"_onDescription: _sendSignalMessage is not set.\");\n    }\n  }\n};\n\nSimpleDataPeer.prototype.onSignalingStateChange = function () {\n  //console.log(this.peerName + \": \" + \"onSignalingStateChange: \", this._pc.signalingState);\n  if (this.pc.signalingState === \"stable\") {\n    this.pcState = SimpleDataPeerState.CONNECTED;\n    this.onConnectedQueue.map(function(callback) { callback(); });\n  }\n};\n\nSimpleDataPeer.prototype.onDataChannel = function (event) {\n  this.addDataChannel(event.channel.label, event.channel);\n  // RTCDataChannels created by a RTCDataChannelEvent have an initial\n  // state of open, so the onopen event for the channel will not\n  // fire. We need to fire the onOpenDataChannel event here\n  // http://www.w3.org/TR/webrtc/#idl-def-RTCDataChannelState\n\n  // Firefox channels do not have an initial state of \"open\"\n  // See https://bugzilla.mozilla.org/show_bug.cgi?id=1000478\n  if (event.channel.readyState === \"open\") {\n    this.dataChannelCallbacks.onOpenFn(event.channel,\n                                       {label: event.channel.label});\n  }\n};\n\n// _signallingChannel is a channel for emitting events back to the freedom Hub.\nfunction PeerConnection(portModule, dispatchEvent,\n                        RTCPeerConnection, RTCSessionDescription,\n                        RTCIceCandidate) {\n  // Channel for emitting events to consumer.\n  this.dispatchEvent = dispatchEvent;\n\n  // a (hopefully unique) ID for debugging.\n  this.peerName = \"p\" + Math.random();\n\n  // This is the portApp (defined in freedom/src/port-app.js). A way to speak\n  // to freedom.\n  this.freedomModule = portModule;\n\n  // For tests we may mock out the PeerConnection and\n  // SessionDescription implementations\n  this.RTCPeerConnection = RTCPeerConnection;\n  this.RTCSessionDescription = RTCSessionDescription;\n  this.RTCIceCandidate = RTCIceCandidate;\n\n  // This is the a channel to send signalling messages.\n  this.signallingChannel = null;\n\n  // The DataPeer object for talking to the peer.\n  this.peer = null;\n\n  // The Core object for managing channels.\n  this.freedomModule.once('core', function (Core) {\n    this.core = new Core();\n  }.bind(this));\n  this.freedomModule.emit(this.freedomModule.controlChannel, {\n    type: 'core request delegated to peerconnection',\n    request: 'core'\n  });\n}\n\n// Start a peer connection using the given freedomChannelId as the way to\n// communicate with the peer. The argument |freedomChannelId| is a way to speak\n// to an identity provide to send them SDP headers negotiate the address/port to\n// setup the peer to peerConnection.\n//\n// options: {\n//   peerName: string,   // For pretty printing messages about this peer.\n//   debug: boolean           // should we add extra\n// }\nPeerConnection.prototype.setup = function (signallingChannelId, peerName,\n                                            stunServers, continuation) {\n\n  this.peerName = peerName;\n  var mocks = {RTCPeerConnection: this.RTCPeerConnection,\n               RTCSessionDescription: this.RTCSessionDescription,\n               RTCIceCandidate: this.RTCIceCandidate};\n  var self = this;\n  var dataChannelCallbacks = {\n    // onOpenFn is called at the point messages will actually get through.\n    onOpenFn: function (dataChannel, info) {\n      self.dispatchEvent(\"onOpenDataChannel\",\n                         info.label);\n    },\n    onCloseFn: function (dataChannel, info) {\n      self.dispatchEvent(\"onCloseDataChannel\",\n                         { channelId: info.label});\n    },\n    // Default on real message prints it to console.\n    onMessageFn: function (dataChannel, info, event) {\n      if (event.data instanceof ArrayBuffer) {\n        self.dispatchEvent('onReceived', {\n          'channelLabel': info.label,\n          'buffer': event.data\n        });\n      } else if (event.data instanceof Blob) {\n        self.dispatchEvent('onReceived', {\n          'channelLabel': info.label,\n          'binary': event.data\n        });\n      } else if (typeof (event.data) === 'string') {\n        self.dispatchEvent('onReceived', {\n          'channelLabel': info.label,\n          'text': event.data\n        });\n      }\n    },\n    // Default on error, prints it.\n    onErrorFn: function (dataChannel, info, err) {\n      console.error(dataChannel.peerName + \": dataChannel(\" +\n                    dataChannel.dataChannel.label + \"): error: \", err);\n    }\n  };\n\n  this.peer = new SimpleDataPeer(this.peerName, stunServers,\n                                 dataChannelCallbacks, mocks);\n\n  // Setup link between Freedom messaging and _peer's signalling.\n  // Note: the signalling channel should only be sending receiveing strings.\n  this.core.bindChannel(signallingChannelId, function (channel) {\n    this.signallingChannel = channel;\n    this.peer.setSendSignalMessage(function (msg) {\n      this.signallingChannel.emit('message', msg);\n    }.bind(this));\n    this.signallingChannel.on('message',\n        this.peer.handleSignalMessage.bind(this.peer));\n    this.signallingChannel.emit('ready');\n    this.peer.runWhenConnected(continuation);\n  }.bind(this));\n\n};\n\n// TODO: delay continuation until the open callback from _peer is called.\nPeerConnection.prototype.openDataChannel = function (channelId, continuation) {\n  this.peer.openDataChannel(channelId, continuation);\n};\n\nPeerConnection.prototype.closeDataChannel = function (channelId, continuation) {\n  this.peer.closeChannel(channelId);\n  continuation();\n};\n\n// Called to send a message over the given datachannel to a peer. If the data\n// channel doesn't already exist, the DataPeer creates it.\nPeerConnection.prototype.send = function (sendInfo, continuation) {\n  var objToSend = sendInfo.text || sendInfo.buffer || sendInfo.binary;\n  if (typeof objToSend === 'undefined') {\n    console.error(\"No valid data to send has been provided.\", sendInfo);\n    return;\n  }\n  //DEBUG\n  // objToSend = new ArrayBuffer(4);\n  //DEBUG\n  this.peer.send(sendInfo.channelLabel, objToSend, continuation);\n};\n\nPeerConnection.prototype.getBufferedAmount = function (channelId, continuation) {\n  continuation(this.peer.getBufferedAmount(channelId));\n};\n\nPeerConnection.prototype.close = function (continuation) {\n  this.peer.close();\n  continuation();\n  this.dispatchEvent(\"onClose\");\n};\n\nfdom.apis.register('core.peerconnection', PeerConnection);\n","(function() {\nvar define, requireModule, require, requirejs;\n\n(function() {\n  var registry = {}, seen = {};\n\n  define = function(name, deps, callback) {\n    registry[name] = { deps: deps, callback: callback };\n  };\n\n  requirejs = require = requireModule = function(name) {\n  requirejs._eak_seen = registry;\n\n    if (seen[name]) { return seen[name]; }\n    seen[name] = {};\n\n    if (!registry[name]) {\n      throw new Error(\"Could not find module \" + name);\n    }\n\n    var mod = registry[name],\n        deps = mod.deps,\n        callback = mod.callback,\n        reified = [],\n        exports;\n\n    for (var i=0, l=deps.length; i<l; i++) {\n      if (deps[i] === 'exports') {\n        reified.push(exports = {});\n      } else {\n        reified.push(requireModule(resolve(deps[i])));\n      }\n    }\n\n    var value = callback.apply(this, reified);\n    return seen[name] = exports || value;\n\n    function resolve(child) {\n      if (child.charAt(0) !== '.') { return child; }\n      var parts = child.split(\"/\");\n      var parentBase = name.split(\"/\").slice(0, -1);\n\n      for (var i=0, l=parts.length; i<l; i++) {\n        var part = parts[i];\n\n        if (part === '..') { parentBase.pop(); }\n        else if (part === '.') { continue; }\n        else { parentBase.push(part); }\n      }\n\n      return parentBase.join(\"/\");\n    }\n  };\n})();\n\ndefine(\"promise/all\", \n  [\"./utils\",\"exports\"],\n  function(__dependency1__, __exports__) {\n    \"use strict\";\n    /* global toString */\n\n    var isArray = __dependency1__.isArray;\n    var isFunction = __dependency1__.isFunction;\n\n    /**\n      Returns a promise that is fulfilled when all the given promises have been\n      fulfilled, or rejected if any of them become rejected. The return promise\n      is fulfilled with an array that gives all the values in the order they were\n      passed in the `promises` array argument.\n\n      Example:\n\n      ```javascript\n      var promise1 = RSVP.resolve(1);\n      var promise2 = RSVP.resolve(2);\n      var promise3 = RSVP.resolve(3);\n      var promises = [ promise1, promise2, promise3 ];\n\n      RSVP.all(promises).then(function(array){\n        // The array here would be [ 1, 2, 3 ];\n      });\n      ```\n\n      If any of the `promises` given to `RSVP.all` are rejected, the first promise\n      that is rejected will be given as an argument to the returned promises's\n      rejection handler. For example:\n\n      Example:\n\n      ```javascript\n      var promise1 = RSVP.resolve(1);\n      var promise2 = RSVP.reject(new Error(\"2\"));\n      var promise3 = RSVP.reject(new Error(\"3\"));\n      var promises = [ promise1, promise2, promise3 ];\n\n      RSVP.all(promises).then(function(array){\n        // Code here never runs because there are rejected promises!\n      }, function(error) {\n        // error.message === \"2\"\n      });\n      ```\n\n      @method all\n      @for RSVP\n      @param {Array} promises\n      @param {String} label\n      @return {Promise} promise that is fulfilled when all `promises` have been\n      fulfilled, or rejected if any of them become rejected.\n    */\n    function all(promises) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      if (!isArray(promises)) {\n        throw new TypeError('You must pass an array to all.');\n      }\n\n      return new Promise(function(resolve, reject) {\n        var results = [], remaining = promises.length,\n        promise;\n\n        if (remaining === 0) {\n          resolve([]);\n        }\n\n        function resolver(index) {\n          return function(value) {\n            resolveAll(index, value);\n          };\n        }\n\n        function resolveAll(index, value) {\n          results[index] = value;\n          if (--remaining === 0) {\n            resolve(results);\n          }\n        }\n\n        for (var i = 0; i < promises.length; i++) {\n          promise = promises[i];\n\n          if (promise && isFunction(promise.then)) {\n            promise.then(resolver(i), reject);\n          } else {\n            resolveAll(i, promise);\n          }\n        }\n      });\n    }\n\n    __exports__.all = all;\n  });\ndefine(\"promise/asap\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    var browserGlobal = (typeof window !== 'undefined') ? window : {};\n    var BrowserMutationObserver = browserGlobal.MutationObserver || browserGlobal.WebKitMutationObserver;\n    var local = (typeof global !== 'undefined') ? global : (this === undefined? window:this);\n\n    // node\n    function useNextTick() {\n      return function() {\n        process.nextTick(flush);\n      };\n    }\n\n    function useMutationObserver() {\n      var iterations = 0;\n      var observer = new BrowserMutationObserver(flush);\n      var node = document.createTextNode('');\n      observer.observe(node, { characterData: true });\n\n      return function() {\n        node.data = (iterations = ++iterations % 2);\n      };\n    }\n\n    function useSetTimeout() {\n      return function() {\n        local.setTimeout(flush, 1);\n      };\n    }\n\n    var queue = [];\n    function flush() {\n      for (var i = 0; i < queue.length; i++) {\n        var tuple = queue[i];\n        var callback = tuple[0], arg = tuple[1];\n        callback(arg);\n      }\n      queue = [];\n    }\n\n    var scheduleFlush;\n\n    // Decide what async method to use to triggering processing of queued callbacks:\n    if (typeof process !== 'undefined' && {}.toString.call(process) === '[object process]') {\n      scheduleFlush = useNextTick();\n    } else if (BrowserMutationObserver) {\n      scheduleFlush = useMutationObserver();\n    } else {\n      scheduleFlush = useSetTimeout();\n    }\n\n    function asap(callback, arg) {\n      var length = queue.push([callback, arg]);\n      if (length === 1) {\n        // If length is 1, that means that we need to schedule an async flush.\n        // If additional callbacks are queued before the queue is flushed, they\n        // will be processed by this flush that we are scheduling.\n        scheduleFlush();\n      }\n    }\n\n    __exports__.asap = asap;\n  });\ndefine(\"promise/config\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    var config = {\n      instrument: false\n    };\n\n    function configure(name, value) {\n      if (arguments.length === 2) {\n        config[name] = value;\n      } else {\n        return config[name];\n      }\n    }\n\n    __exports__.config = config;\n    __exports__.configure = configure;\n  });\ndefine(\"promise/polyfill\", \n  [\"./promise\",\"./utils\",\"exports\"],\n  function(__dependency1__, __dependency2__, __exports__) {\n    \"use strict\";\n    /*global self*/\n    var RSVPPromise = __dependency1__.Promise;\n    var isFunction = __dependency2__.isFunction;\n\n    function polyfill() {\n      var local;\n\n      if (typeof global !== 'undefined') {\n        local = global;\n      } else if (typeof window !== 'undefined' && window.document) {\n        local = window;\n      } else {\n        local = self;\n      }\n\n      var es6PromiseSupport = \n        \"Promise\" in local &&\n        // Some of these methods are missing from\n        // Firefox/Chrome experimental implementations\n        \"resolve\" in local.Promise &&\n        \"reject\" in local.Promise &&\n        \"all\" in local.Promise &&\n        \"race\" in local.Promise &&\n        // Older version of the spec had a resolver object\n        // as the arg rather than a function\n        (function() {\n          var resolve;\n          new local.Promise(function(r) { resolve = r; });\n          return isFunction(resolve);\n        }());\n\n      if (!es6PromiseSupport) {\n        local.Promise = RSVPPromise;\n      }\n    }\n\n    __exports__.polyfill = polyfill;\n  });\ndefine(\"promise/promise\", \n  [\"./config\",\"./utils\",\"./all\",\"./race\",\"./resolve\",\"./reject\",\"./asap\",\"exports\"],\n  function(__dependency1__, __dependency2__, __dependency3__, __dependency4__, __dependency5__, __dependency6__, __dependency7__, __exports__) {\n    \"use strict\";\n    var config = __dependency1__.config;\n    var configure = __dependency1__.configure;\n    var objectOrFunction = __dependency2__.objectOrFunction;\n    var isFunction = __dependency2__.isFunction;\n    var now = __dependency2__.now;\n    var all = __dependency3__.all;\n    var race = __dependency4__.race;\n    var staticResolve = __dependency5__.resolve;\n    var staticReject = __dependency6__.reject;\n    var asap = __dependency7__.asap;\n\n    var counter = 0;\n\n    config.async = asap; // default async is asap;\n\n    function Promise(resolver) {\n      if (!isFunction(resolver)) {\n        throw new TypeError('You must pass a resolver function as the first argument to the promise constructor');\n      }\n\n      if (!(this instanceof Promise)) {\n        throw new TypeError(\"Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.\");\n      }\n\n      this._subscribers = [];\n\n      invokeResolver(resolver, this);\n    }\n\n    function invokeResolver(resolver, promise) {\n      function resolvePromise(value) {\n        resolve(promise, value);\n      }\n\n      function rejectPromise(reason) {\n        reject(promise, reason);\n      }\n\n      try {\n        resolver(resolvePromise, rejectPromise);\n      } catch(e) {\n        rejectPromise(e);\n      }\n    }\n\n    function invokeCallback(settled, promise, callback, detail) {\n      var hasCallback = isFunction(callback),\n          value, error, succeeded, failed;\n\n      if (hasCallback) {\n        try {\n          value = callback(detail);\n          succeeded = true;\n        } catch(e) {\n          failed = true;\n          error = e;\n        }\n      } else {\n        value = detail;\n        succeeded = true;\n      }\n\n      if (handleThenable(promise, value)) {\n        return;\n      } else if (hasCallback && succeeded) {\n        resolve(promise, value);\n      } else if (failed) {\n        reject(promise, error);\n      } else if (settled === FULFILLED) {\n        resolve(promise, value);\n      } else if (settled === REJECTED) {\n        reject(promise, value);\n      }\n    }\n\n    var PENDING   = void 0;\n    var SEALED    = 0;\n    var FULFILLED = 1;\n    var REJECTED  = 2;\n\n    function subscribe(parent, child, onFulfillment, onRejection) {\n      var subscribers = parent._subscribers;\n      var length = subscribers.length;\n\n      subscribers[length] = child;\n      subscribers[length + FULFILLED] = onFulfillment;\n      subscribers[length + REJECTED]  = onRejection;\n    }\n\n    function publish(promise, settled) {\n      var child, callback, subscribers = promise._subscribers, detail = promise._detail;\n\n      for (var i = 0; i < subscribers.length; i += 3) {\n        child = subscribers[i];\n        callback = subscribers[i + settled];\n\n        invokeCallback(settled, child, callback, detail);\n      }\n\n      promise._subscribers = null;\n    }\n\n    Promise.prototype = {\n      constructor: Promise,\n\n      _state: undefined,\n      _detail: undefined,\n      _subscribers: undefined,\n\n      then: function(onFulfillment, onRejection) {\n        var promise = this;\n\n        var thenPromise = new this.constructor(function() {});\n\n        if (this._state) {\n          var callbacks = arguments;\n          config.async(function invokePromiseCallback() {\n            invokeCallback(promise._state, thenPromise, callbacks[promise._state - 1], promise._detail);\n          });\n        } else {\n          subscribe(this, thenPromise, onFulfillment, onRejection);\n        }\n\n        return thenPromise;\n      },\n\n      'catch': function(onRejection) {\n        return this.then(null, onRejection);\n      }\n    };\n\n    Promise.all = all;\n    Promise.race = race;\n    Promise.resolve = staticResolve;\n    Promise.reject = staticReject;\n\n    function handleThenable(promise, value) {\n      var then = null,\n      resolved;\n\n      try {\n        if (promise === value) {\n          throw new TypeError(\"A promises callback cannot return that same promise.\");\n        }\n\n        if (objectOrFunction(value)) {\n          then = value.then;\n\n          if (isFunction(then)) {\n            then.call(value, function(val) {\n              if (resolved) { return true; }\n              resolved = true;\n\n              if (value !== val) {\n                resolve(promise, val);\n              } else {\n                fulfill(promise, val);\n              }\n            }, function(val) {\n              if (resolved) { return true; }\n              resolved = true;\n\n              reject(promise, val);\n            });\n\n            return true;\n          }\n        }\n      } catch (error) {\n        if (resolved) { return true; }\n        reject(promise, error);\n        return true;\n      }\n\n      return false;\n    }\n\n    function resolve(promise, value) {\n      if (promise === value) {\n        fulfill(promise, value);\n      } else if (!handleThenable(promise, value)) {\n        fulfill(promise, value);\n      }\n    }\n\n    function fulfill(promise, value) {\n      if (promise._state !== PENDING) { return; }\n      promise._state = SEALED;\n      promise._detail = value;\n\n      config.async(publishFulfillment, promise);\n    }\n\n    function reject(promise, reason) {\n      if (promise._state !== PENDING) { return; }\n      promise._state = SEALED;\n      promise._detail = reason;\n\n      config.async(publishRejection, promise);\n    }\n\n    function publishFulfillment(promise) {\n      publish(promise, promise._state = FULFILLED);\n    }\n\n    function publishRejection(promise) {\n      publish(promise, promise._state = REJECTED);\n    }\n\n    __exports__.Promise = Promise;\n  });\ndefine(\"promise/race\", \n  [\"./utils\",\"exports\"],\n  function(__dependency1__, __exports__) {\n    \"use strict\";\n    /* global toString */\n    var isArray = __dependency1__.isArray;\n\n    /**\n      `RSVP.race` allows you to watch a series of promises and act as soon as the\n      first promise given to the `promises` argument fulfills or rejects.\n\n      Example:\n\n      ```javascript\n      var promise1 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 1\");\n        }, 200);\n      });\n\n      var promise2 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 2\");\n        }, 100);\n      });\n\n      RSVP.race([promise1, promise2]).then(function(result){\n        // result === \"promise 2\" because it was resolved before promise1\n        // was resolved.\n      });\n      ```\n\n      `RSVP.race` is deterministic in that only the state of the first completed\n      promise matters. For example, even if other promises given to the `promises`\n      array argument are resolved, but the first completed promise has become\n      rejected before the other promises became fulfilled, the returned promise\n      will become rejected:\n\n      ```javascript\n      var promise1 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 1\");\n        }, 200);\n      });\n\n      var promise2 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          reject(new Error(\"promise 2\"));\n        }, 100);\n      });\n\n      RSVP.race([promise1, promise2]).then(function(result){\n        // Code here never runs because there are rejected promises!\n      }, function(reason){\n        // reason.message === \"promise2\" because promise 2 became rejected before\n        // promise 1 became fulfilled\n      });\n      ```\n\n      @method race\n      @for RSVP\n      @param {Array} promises array of promises to observe\n      @param {String} label optional string for describing the promise returned.\n      Useful for tooling.\n      @return {Promise} a promise that becomes fulfilled with the value the first\n      completed promises is resolved with if the first completed promise was\n      fulfilled, or rejected with the reason that the first completed promise\n      was rejected with.\n    */\n    function race(promises) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      if (!isArray(promises)) {\n        throw new TypeError('You must pass an array to race.');\n      }\n      return new Promise(function(resolve, reject) {\n        var results = [], promise;\n\n        for (var i = 0; i < promises.length; i++) {\n          promise = promises[i];\n\n          if (promise && typeof promise.then === 'function') {\n            promise.then(resolve, reject);\n          } else {\n            resolve(promise);\n          }\n        }\n      });\n    }\n\n    __exports__.race = race;\n  });\ndefine(\"promise/reject\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    /**\n      `RSVP.reject` returns a promise that will become rejected with the passed\n      `reason`. `RSVP.reject` is essentially shorthand for the following:\n\n      ```javascript\n      var promise = new RSVP.Promise(function(resolve, reject){\n        reject(new Error('WHOOPS'));\n      });\n\n      promise.then(function(value){\n        // Code here doesn't run because the promise is rejected!\n      }, function(reason){\n        // reason.message === 'WHOOPS'\n      });\n      ```\n\n      Instead of writing the above, your code now simply becomes the following:\n\n      ```javascript\n      var promise = RSVP.reject(new Error('WHOOPS'));\n\n      promise.then(function(value){\n        // Code here doesn't run because the promise is rejected!\n      }, function(reason){\n        // reason.message === 'WHOOPS'\n      });\n      ```\n\n      @method reject\n      @for RSVP\n      @param {Any} reason value that the returned promise will be rejected with.\n      @param {String} label optional string for identifying the returned promise.\n      Useful for tooling.\n      @return {Promise} a promise that will become rejected with the given\n      `reason`.\n    */\n    function reject(reason) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      return new Promise(function (resolve, reject) {\n        reject(reason);\n      });\n    }\n\n    __exports__.reject = reject;\n  });\ndefine(\"promise/resolve\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    function resolve(value) {\n      /*jshint validthis:true */\n      if (value && typeof value === 'object' && value.constructor === this) {\n        return value;\n      }\n\n      var Promise = this;\n\n      return new Promise(function(resolve) {\n        resolve(value);\n      });\n    }\n\n    __exports__.resolve = resolve;\n  });\ndefine(\"promise/utils\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    function objectOrFunction(x) {\n      return isFunction(x) || (typeof x === \"object\" && x !== null);\n    }\n\n    function isFunction(x) {\n      return typeof x === \"function\";\n    }\n\n    function isArray(x) {\n      return Object.prototype.toString.call(x) === \"[object Array]\";\n    }\n\n    // Date.now is not available in browsers < IE9\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/now#Compatibility\n    var now = Date.now || function() { return new Date().getTime(); };\n\n\n    __exports__.objectOrFunction = objectOrFunction;\n    __exports__.isFunction = isFunction;\n    __exports__.isArray = isArray;\n    __exports__.now = now;\n  });\nrequireModule('promise/polyfill').polyfill();\n}());","/*globals fdom:true, Promise */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\n\n/**\n * The API registry for FreeDOM.  Used to look up requested APIs,\n * and provides a bridge for core APIs to act like normal APIs.\n * @Class API\n * @constructor\n */\nvar Api = function() {\n  this.apis = {};\n  this.providers = {};\n  this.waiters = {};\n};\n\n/**\n * Get an API.\n * @method get\n * @param {String} api The API name to get.\n * @returns {{name:String, definition:API}} The API if registered.\n */\nApi.prototype.get = function(api) {\n  if (!this.apis[api]) {\n    return false;\n  }\n  return {\n    name: api,\n    definition: this.apis[api]\n  };\n};\n\n/**\n * Set an API to a definition.\n * @method set\n * @param {String} name The API name.\n * @param {API} definition The JSON object defining the API.\n */\nApi.prototype.set = function(name, definition) {\n  this.apis[name] = definition;\n};\n\n/**\n * Register a core API provider.\n * @method register\n * @param {String} name the API name.\n * @param {Function} constructor the function to create a provider for the API.\n */\nApi.prototype.register = function(name, constructor) {\n  var i;\n\n  this.providers[name] = constructor;\n\n  if (this.waiters[name]) {\n    for (i = 0; i < this.waiters[name].length; i += 1) {\n      this.waiters[name][i][0](constructor.bind({},\n          this.waiters[name][i][2]));\n    }\n    delete this.waiters[name];\n  }\n};\n\n/**\n * Get a core API connected to a given FreeDOM module.\n * @method getCore\n * @param {String} name the API to retrieve.\n * @param {port.App} from The instantiating App.\n * @returns {Promise} A promise of a fdom.App look-alike matching\n * a local API definition.\n */\nApi.prototype.getCore = function(name, from) {\n  return new Promise(function(resolve, reject) {\n    if (this.apis[name]) {\n      if (this.providers[name]) {\n        resolve(this.providers[name].bind({}, from));\n      } else {\n        if (!this.waiters[name]) {\n          this.waiters[name] = [];\n        }\n        this.waiters[name].push([resolve, reject, from]);\n      }\n    } else {\n      fdom.debug.warn('Api.getCore asked for unknown core: ' + name);\n      reject(null);\n    }\n  }.bind(this));\n};\n\n/**\n * Defines fdom.apis for fdom module registry and core provider registation.\n */\nfdom.apis = new Api();\n","/*globals fdom:true, Promise, document, location, console */\r\n/*jslint indent:2,sloppy:true */\r\n\r\n/**\r\n * @module freedom\r\n */\r\nif (typeof fdom === 'undefined') {\r\n  fdom = {};\r\n}\r\n\r\n/**\r\n * External freedom Setup.  global.freedom is set to the value returned by\r\n * setup (see preamble.js and postamble.js for that mechanism).  As a result,\r\n * this is the primary entry function for the freedom library.\r\n * @for util\r\n * @method setup\r\n * @param {Object} global The window / frame / worker context freedom is in.\r\n * @param {String} freedom_src The textual code of freedom, for replication.\r\n * @param {Object} config Overriding config for freedom.js\r\n * @static\r\n */\r\nfdom.setup = function (global, freedom_src, config) {\r\n  fdom.debug = new fdom.port.Debug();\r\n\r\n  var hub = new fdom.Hub(),\r\n    site_cfg = {\r\n      'debug': true,\r\n      'stayLocal': false,\r\n      'portType': 'Worker',\r\n      'moduleContext': (!config || typeof (config.isModule) === \"undefined\") ?\r\n          fdom.util.isModuleContext() :\r\n          config.isModule\r\n    },\r\n    manager = new fdom.port.Manager(hub),\r\n    external = new fdom.port.Proxy(fdom.proxy.EventInterface),\r\n    link;\r\n\r\n  manager.setup(external);\r\n\r\n  if (site_cfg.moduleContext) {\r\n    if (config) {\r\n      fdom.util.mixin(site_cfg, config, true);\r\n    }\r\n    site_cfg.global = global;\r\n    site_cfg.src = freedom_src;\r\n    link = new fdom.link[site_cfg.portType]();\r\n    manager.setup(link);\r\n    manager.createLink(external, 'default', link);\r\n\r\n    // Delay debug messages until delegation to the parent context is setup.\r\n    manager.once('delegate', manager.setup.bind(manager, fdom.debug));\r\n  } else {\r\n    manager.setup(fdom.debug);\r\n    fdom.util.advertise(config ? config.advertise : undefined);\r\n    \r\n    // Configure against data-manifest.\r\n    if (typeof document !== 'undefined') {\r\n      fdom.util.eachReverse(fdom.util.scripts(global), function (script) {\r\n        var manifest = script.getAttribute('data-manifest'),\r\n          source = script.src;\r\n        if (manifest) {\r\n          site_cfg.source = source;\r\n          site_cfg.manifest = manifest;\r\n          if (script.textContent.trim().length) {\r\n            try {\r\n              fdom.util.mixin(site_cfg, JSON.parse(script.textContent), true);\r\n            } catch (e) {\r\n              fdom.debug.warn(\"Failed to parse configuration: \" + e);\r\n            }\r\n          }\r\n          return true;\r\n        }\r\n      });\r\n    }\r\n\r\n    site_cfg.global = global;\r\n    site_cfg.src = freedom_src;\r\n    site_cfg.resources = fdom.resources;\r\n    if (config) {\r\n      fdom.util.mixin(site_cfg, config, true);\r\n    }\r\n\r\n    if (typeof location !== 'undefined') {\r\n      site_cfg.location = location.protocol + \"//\" + location.host + location.pathname;\r\n    }\r\n    site_cfg.policy = new fdom.Policy(manager, site_cfg);\r\n\r\n    fdom.resources.get(site_cfg.location, site_cfg.manifest).then(function (root_mod) {\r\n      site_cfg.policy.get([], root_mod)\r\n          .then(manager.createLink.bind(manager, external, 'default'));\r\n    }, function (err) {\r\n      fdom.debug.error('Failed to retrieve manifest: ' + err);\r\n    });\r\n  }\r\n  hub.emit('config', site_cfg);\r\n\r\n  // Enable console.log from worker contexts.\r\n  if (typeof global.console === 'undefined') {\r\n    global.console = fdom.debug;\r\n  }\r\n  \r\n  return external.getInterface();\r\n};\r\n","/*globals fdom:true */\r\n/*jslint indent:2,white:true,node:true,sloppy:true */\r\nif (typeof fdom === 'undefined') {\r\n  fdom = {};\r\n}\r\n\r\n/**\r\n * Defines fdom.Hub, the core message hub between freedom modules.\r\n * Incomming messages from apps are sent to hub.onMessage()\r\n * @class Hub\r\n * @constructor\r\n */\r\nfdom.Hub = function() {\r\n  this.route = Math.round(Math.random() * 1000000);\r\n  this.config = {};\r\n  this.apps = {};\r\n  this.routes = {};\r\n  this.unbound = [];\r\n\r\n  fdom.util.handleEvents(this);\r\n  this.on('config', function(config) {\r\n    fdom.util.mixin(this.config, config);\r\n  }.bind(this));\r\n};\r\n\r\n/**\r\n * Handle an incoming message from a freedom app.\r\n * @method onMessage\r\n * @param {String} source The identifiying source of the message.\r\n * @param {Object} message The sent message.\r\n */\r\nfdom.Hub.prototype.onMessage = function(source, message) {\r\n  var destination = this.routes[source], type;\r\n  if (!destination || !destination.app) {\r\n    fdom.debug.warn(\"Message dropped from unregistered source \" + source);\r\n    return;\r\n  }\r\n\r\n  if(!this.apps[destination.app]) {\r\n    fdom.debug.warn(\"Message dropped to destination \" + destination.app);\r\n    return;\r\n  }\r\n\r\n  if (!message.quiet) {\r\n    type = message.type;\r\n    if (message.type === 'message' && message.message &&\r\n        message.message.action === 'method') {\r\n      type = 'method.' + message.message.type;\r\n    } else if (message.type === 'method' && message.message &&\r\n        message.message.type === 'method') {\r\n      type = 'return.' + message.message.name;\r\n    } else if (message.type === 'message' && message.message &&\r\n        message.message.type === 'event') {\r\n      type = 'event.' + message.message.name;\r\n    }\r\n    fdom.debug.log(this.apps[destination.source].toString() +\r\n        \" -\" + type + \"-> \" +\r\n        this.apps[destination.app].toString() + \".\" + destination.flow);\r\n  }\r\n\r\n  this.apps[destination.app].onMessage(destination.flow, message);\r\n};\r\n\r\n/**\r\n * Get the local destination port of a flow.\r\n * @method getDestination\r\n * @param {String} source The flow to retrieve.\r\n * @return {Port} The destination port.\r\n */\r\nfdom.Hub.prototype.getDestination = function(source) {\r\n  var destination = this.routes[source];\r\n  if (!destination) {\r\n    return null;\r\n  }\r\n  return this.apps[destination.app];\r\n};\r\n\r\n/**\r\n * Get the local source port of a flow.\r\n * @method getSource\r\n * @param {Port} source The flow identifier to retrieve.\r\n * @return {Port} The source port.\r\n */\r\nfdom.Hub.prototype.getSource = function(source) {\r\n  if (!source) {\r\n    return false;\r\n  }\r\n  if (!this.apps[source.id]) {\r\n    fdom.debug.warn(\"No registered source '\" + source.id + \"'\");\r\n    return false;\r\n  }\r\n  return this.apps[source.id];\r\n};\r\n\r\n/**\r\n * Register a destination for messages with this hub.\r\n * @method register\r\n * @param {Port} app The Port to register.\r\n * @param {Boolean} [force] Whether to override an existing port.\r\n * @return {Boolean} Whether the app was registered.\r\n */\r\nfdom.Hub.prototype.register = function(app, force) {\r\n  if (!this.apps[app.id] || force) {\r\n    this.apps[app.id] = app;\r\n    return true;\r\n  } else {\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * Deregister a destination for messages with the hub.\r\n * Note: does not remove associated routes. As such, deregistering will\r\n * prevent the installation of new routes, but will not distrupt existing\r\n * hub routes.\r\n * @method deregister\r\n * @param {Port} app The Port to deregister\r\n * @return {Boolean} Whether the app was deregistered.\r\n */\r\nfdom.Hub.prototype.deregister = function(app) {\r\n  if(!this.apps[app.id]) {\r\n    return false;\r\n  }\r\n  delete this.apps[app.id];\r\n  return true;\r\n};\r\n\r\n/**\r\n * Install a new route in the hub.\r\n * @method install\r\n * @param {Port} source The source of the route.\r\n * @param {Port} destination The destination of the route.\r\n * @param {String} flow The flow where the destination will receive messages.\r\n * @return {String} A routing source identifier for sending messages.\r\n */\r\nfdom.Hub.prototype.install = function(source, destination, flow) {\r\n  source = this.getSource(source);\r\n  if (!source) {\r\n    return;\r\n  }\r\n  if (!destination) {\r\n    fdom.debug.warn(\"Unwilling to generate blackhole flow from \" + source.id);\r\n    return;\r\n  }\r\n\r\n  var route = this.generateRoute();\r\n  this.routes[route] = {\r\n    app: destination,\r\n    flow: flow,\r\n    source: source.id\r\n  };\r\n  if (typeof source.on === 'function') {\r\n    source.on(route, this.onMessage.bind(this, route));\r\n  }\r\n\r\n  return route;\r\n};\r\n\r\n/**\r\n * Uninstall a hub route.\r\n * @method uninstall\r\n * @param {Port} source The source of the route.\r\n * @param {String} flow The route to uninstall.\r\n * @return {Boolean} Whether the route was able to be uninstalled.\r\n */\r\nfdom.Hub.prototype.uninstall = function(source, flow) {\r\n  source = this.getSource(source);\r\n  if (!source) {\r\n    return;\r\n  }\r\n\r\n  var route = this.routes[flow];\r\n  if (!route) {\r\n    return false;\r\n  } else if (route.source !== source.id) {\r\n    fdom.debug.warn(\"Flow \" + flow + \" does not belong to port \" + source.id);\r\n    return false;\r\n  }\r\n\r\n  delete this.routes[flow];\r\n  if (typeof source.off === 'function') {\r\n    source.off(route);\r\n  }\r\n  return true;\r\n};\r\n\r\n/**\r\n * Generate a unique routing identifier.\r\n * @method generateRoute\r\n * @return {String} a routing source identifier.\r\n * @private\r\n */\r\nfdom.Hub.prototype.generateRoute = function() {\r\n  return (this.route += 1);\r\n};\r\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\n\n/**\n * A link connects two freedom hubs. This is an abstract class\n * providing common functionality of translating control channels,\n * and integrating config information.\n * @class Link\n * @extends Port\n * @constructor\n */\nfdom.Link = function() {\n  this.id = 'Link' + Math.random();\n  this.config = {};\n  this.src = null;\n\n  fdom.util.handleEvents(this);\n  fdom.util.mixin(this, fdom.Link.prototype);\n};\n\n/**\n * Receive messages from the hub to this port.\n * Manages startup, and passes others to 'deliverMessage' implemented\n * in derived classes.\n * @method onMessage\n * @param {String} flow the channel/flow of the message.\n * @param {Object} message The Message.\n */\nfdom.Link.prototype.onMessage = function(flow, message) {\n  if (flow === 'control' && !this.controlChannel) {\n    if (!this.controlChannel && message.channel) {\n      this.controlChannel = message.channel;\n      fdom.util.mixin(this.config, message.config);\n      this.start();\n    }\n  } else {\n    this.deliverMessage(flow, message);\n  }\n};\n\n/**\n * Emit messages to the the hub, mapping control channels.\n * @method emitMessage\n * @param {String} flow the flow to emit the message on.\n * @param {Object} messgae The message to emit.\n */\nfdom.Link.prototype.emitMessage = function(flow, message) {\n  if (flow === 'control' && this.controlChannel) {\n    flow = this.controlChannel;\n  }\n  this.emit(flow, message);\n};\n","/*globals fdom:true, XMLHttpRequest, Promise */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\n\n/**\n * The Policy registry for freedom.js.  Used to look up modules and provide\n * migration and coallesing of execution.\n * @Class Policy\n * @constructor\n */\nfdom.Policy = function(manager, config) {\n  this.location = config.location;\n  this.config = config;\n  this.runtimes = [];\n  this.policies = [];\n\n  this.add(manager, config.policy);\n  this.runtimes[0].local = true;\n};\n\n/**\n * The policy a runtime is expected to have unless it specifies\n * otherwise.\n * TODO: consider making static\n * @property defaultPolicy\n */\nfdom.Policy.prototype.defaultPolicy = {\n  background: false, // Can this runtime run 'background' modules?\n  interactive: true // Is there a view associated with this runtime?\n  // TODO: remaining runtime policy.\n};\n\n/**\n * The constraints a code modules is expected to have unless it specifies\n * otherwise.\n * TODO: consider making static\n * @property defaultConstraints\n */\nfdom.Policy.prototype.defaultConstraints = {\n  isolation: \"always\", // values: always, app, never\n  placement: \"local\" // values: local, stable, redundant\n  // TODO: remaining constraints, express platform-specific dependencies.\n};\n\n/**\n * Resolve a module from its canonical URL.\n * Reponds with the promise of a port representing the module, \n * @method get\n * @param {String[]} lineage The lineage of the requesting module.\n * @param {String} id The canonical ID of the module to get.\n * @returns {Promise} A promise for the local port towards the module.\n */\nfdom.Policy.prototype.get = function(lineage, id) {\n  return this.loadManifest(id).then(function(manifest) {\n    var constraints = this.overlay(this.defaultConstraints, manifest.constraints),\n        runtime = this.findDestination(lineage, id, constraints),\n        portId;\n    if (runtime.local) {\n      portId = this.isRunning(runtime, id, lineage,\n                             constraints.isolation !== 'never');\n      if(constraints.isolation !== 'always' && portId) {\n        fdom.debug.log('Reused port ' + portId);\n        return runtime.manager.getPort(portId);\n      } else {\n        return new fdom.port.Module(id, manifest, lineage);\n      }\n    } else {\n      // TODO: Create a port to go to the remote runtime.\n      fdom.debug.error('Unexpected location selected for module placement');\n      return false;\n    }\n  }.bind(this), function(err) {\n    fdom.debug.error('Policy Error Resolving ' + id, err);\n    return false;\n  });\n};\n\n/**\n * Find the runtime destination for a module given its constraints and the\n * module creating it.\n * @method findDestination\n * @param {String[]} lineage The identity of the module creating this module.\n * @param {String] id The canonical url of the module\n * @param {Object} constraints Constraints for the module.\n * @returns {Object} The element of this.runtimes where the module should run.\n */\nfdom.Policy.prototype.findDestination = function(lineage, id, constraints) {\n  var i;\n\n  // Step 1: if an instance already exists, the m\n  if (constraints.isolation !== 'always') {\n    for (i = 0; i < this.policies.length; i += 1) {\n      if (this.isRunning(this.runtimes[i], id, lineage,\n                         constraints.isolation !== 'never')) {\n        return this.runtimes[i];\n      }\n    }\n  }\n\n  // Step 2: if the module wants stability, it may need to be remote.\n  if (constraints.placement === 'local') {\n    return this.runtimes[0];\n  } else if (constraints.placement === 'stable') {\n    for (i = 0; i < this.policies.length; i += 1) {\n      if (this.policies[i].background) {\n        return this.runtimes[i];\n      }\n    }\n  }\n\n  // Step 3: if the module needs longevity / interactivity, it may want to be remote.\n  return this.runtimes[0];\n};\n\n/**\n * Determine if a known runtime is running an appropriate instance of a module.\n * @method isRunning\n * @param {Object} runtime The runtime to check.\n * @param {String} id The module to look for.\n * @param {String[]} from The identifier of the requesting module.\n * @param {Boolean} fullMatch If the module needs to be in the same app.\n * @returns {String|Boolean} The Module id if it is running, or false if not.\n */\nfdom.Policy.prototype.isRunning = function(runtime, id, from, fullMatch) {\n  var i = 0, j = 0, okay;\n  for (i = 0; i < runtime.modules.length; i += 1) {\n    if (fullMatch && runtime.modules[i].length === from.length + 1) {\n      okay = true;\n      for (j = 0; j < from.length; j += 1) {\n        if (runtime.modules[i][j + 1].indexOf(from[j]) !== 0) {\n          okay = false;\n          break;\n        }\n      }\n      if (runtime.modules[i][0].indexOf(id) !== 0) {\n        okay = false;\n      }\n\n      if (okay) {\n        return runtime.modules[i][0];\n      }\n    } else if (!fullMatch && runtime.modules[i][0].indexOf(id) === 0) {\n      return runtime.modules[i][0];\n    }\n  }\n  return false;\n};\n\n/**\n * Get a promise of the manifest for a module ID.\n * @method loadManifest\n * @param {String} manifest The canonical ID of the manifest\n * @returns {Promise} Promise for the json contents of the manifest.\n */\nfdom.Policy.prototype.loadManifest = function(manifest) {\n  return fdom.resources.getContents(manifest).then(function(data) {\n    var resp = {};\n    try {\n      return JSON.parse(data);\n    } catch(err) {\n      fdom.debug.warn(\"Failed to load \" + this.manifestId + \": \" + err);\n      return {};\n    }\n  });\n};\n\n/**\n * Add a runtime to keep track of in this policy.\n * @method add\n * @param {fdom.port} port The port to use for module lifetime info\n * @param {Object} policy The policy of the runtime.\n */\nfdom.Policy.prototype.add = function(port, policy) {\n  var runtime = {\n    manager: port,\n    modules: []\n  };\n  this.runtimes.push(runtime);\n  this.policies.push(this.overlay(this.defaultPolicy, policy));\n\n  port.on('moduleAdd', function(runtime, info) {\n    var lineage = info.lineage;\n    lineage[0] = info.id;\n    runtime.modules.push(lineage);\n  }.bind(this, runtime));\n  port.on('moduleRemove', function(runtime, info) {\n    var lineage = info.lineage, i, modFingerprint;\n    lineage[0] = info.id;\n    modFingerprint = lineage.toString();\n\n    for (i = 0; i < runtime.modules.length; i += 1) {\n      if (runtime.modules[i].toString() === modFingerprint) {\n        runtime.modules.splice(i, 1);\n        return;\n      }\n    }\n    fdom.debug.warn('Unknown module to remove: ', info.id);\n  }.bind(this, runtime));\n};\n\n/**\n * Overlay a specific policy or constraint instance on default settings.\n * TODO: consider making static.\n * @method overlay\n * @private\n * @param {Object} base The default object\n * @param {Object} overlay The superceeding object\n * @returns {Object} A new object with base parameters when not set in overlay.\n */\nfdom.Policy.prototype.overlay = function(base, overlay) {\n  var ret = {};\n\n  fdom.util.mixin(ret, base);\n  if (overlay) {\n    fdom.util.mixin(ret, overlay, true);\n  }\n  return ret;\n};\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * A freedom port providing debugging output to the console.\n * @uses handleEvents\n * @extends Port\n * @constructor\n */\nfdom.port.Debug = function() {\n  this.id = 'debug';\n  this.emitChannel = false;\n  this.console = null;\n  this.config = false;\n  fdom.util.handleEvents(this);\n};\n\n/**\n * Provide a textual description of this port.\n * @method toString\n * @return {String} the textual description.\n */\nfdom.port.Debug.prototype.toString = function() {\n  return '[Console]';\n};\n\n/**\n * Handler for receiving messages sent to the debug port.\n * These messages are used to retreive config for exposing console.\n * @method onMessage\n * @param {String} source the source identifier for the message.\n * @param {Object} message the received message.\n */\nfdom.port.Debug.prototype.onMessage = function(source, message) {\n  if (source === 'control' && message.channel && !this.emitChannel) {\n    this.emitChannel = message.channel;\n    this.config = message.config.debug;\n    this.console = message.config.global.console;\n    this.emit('ready');\n  }\n};\n\n/**\n * Dispatch a debug message with arbitrary severity.\n * @method format\n * @param {String} severity the severity of the message.\n * @param {String} source The location of message.\n * @param {String[]} args The contents of the message.\n * @private\n */\nfdom.port.Debug.prototype.format = function(severity, source, args) {\n  var i, alist = [];\n  if (typeof args === \"string\") {\n    alist.push(args);\n  } else {\n    for (i = 0; i < args.length; i += 1) {\n      alist.push(args[i]);\n    }\n  }\n  if (!this.emitChannel) {\n    this.on('ready', this.format.bind(this, severity, source, alist));\n    return;\n  }\n  this.emit(this.emitChannel, {\n    severity: severity,\n    source: source,\n    quiet: true,\n    request: 'debug',\n    msg: JSON.stringify(alist)\n  });\n};\n\n/**\n * Print received messages on the console.\n * @method print\n * @param {Object} message The message emitted by {@see format} to print.\n */\nfdom.port.Debug.prototype.print = function(message) {\n  var debug = Boolean(this.config), args, arr = [], i = 0;\n  if (typeof this.config === 'string') {\n    debug = false;\n    args = this.config.split(' ');\n    for (i = 0; i < args.length; i += 1) {\n      if (args[i].indexOf('source:') === 0) {\n        if (message.source === undefined ||\n            message.source.indexOf(args[i].substr(7)) > -1) {\n          debug = true;\n          break;\n        }\n      } else {\n        if (message.msg.indexOf(args[i]) > -1) {\n          debug = true;\n          break;\n        }\n      }\n    }\n  }\n  if (!debug) {\n    return;\n  }\n  if (typeof this.console !== 'undefined' && this.console !== this) {\n    args = JSON.parse(message.msg);\n    if (typeof args === \"string\") {\n      arr.push(args);\n    } else {\n      while (args[i] !== undefined) {\n        arr.push(args[i]);\n        i += 1;\n      }\n    }\n\n    if (typeof process !== 'undefined' && message.source) {\n      arr.unshift('\\x1B[39m');\n      arr.unshift('\\x1B[31m' + message.source);\n    } else if (this.console.__mozillaConsole__ && message.source) {\n      arr.unshift(message.source.toUpperCase());\n    } else if (message.source) {\n      arr.unshift('color: red');\n      arr.unshift('%c ' + message.source);\n    }\n    if (!this.console[message.severity] && this.console.log) {\n      message.severity = 'log';\n    }\n    this.console[message.severity].apply(this.console, arr);\n  }\n};\n\n/**\n * Print a log message to the console.\n * @method log\n */\nfdom.port.Debug.prototype.log = function() {\n  this.format('log', undefined, arguments);\n};\n\n/**\n * Print a warning message to the console.\n * @method warn\n */\nfdom.port.Debug.prototype.warn = function() {\n  this.format('warn', undefined, arguments);\n};\n\n/**\n * Print an error message to the console.\n * @method error\n */\nfdom.port.Debug.prototype.error = function() {\n  this.format('error', undefined, arguments);\n  if (this.console) {\n    this.console.error.apply(this.console, arguments);\n  }\n};\n","/*globals fdom:true */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * A freedom port which manages the control plane of of changing hub routes.\n * @class Manager\n * @extends Port\n * @param {Hub} hub The routing hub to control.\n * @constructor\n */\nfdom.port.Manager = function(hub) {\n  this.id = 'control';\n  this.config = {};\n  this.controlFlows = {};\n  this.dataFlows = {};\n  this.dataFlows[this.id] = [];\n  this.reverseFlowMap = {};\n  this.hub = hub;\n  this.delegate = null;\n  this.toDelegate = {};\n  \n  this.hub.on('config', function(config) {\n    fdom.util.mixin(this.config, config);\n    this.emit('config');\n  }.bind(this));\n  \n  fdom.util.handleEvents(this);\n  this.hub.register(this);\n};\n\n/**\n * Provide a textual description of this port.\n * @method toString\n * @return {String} the description of this port.\n */\nfdom.port.Manager.prototype.toString = function() {\n  return \"[Local Controller]\";\n};\n\n/**\n * Process messages sent to this port.\n * The manager, or 'control' destination handles several types of messages,\n * identified by the request property.  The actions are:\n * 1. debug. Prints the message to the console.\n * 2. link. Creates a link between the source and a provided destination port.\n * 3. port. Creates a link between the source and a described port type.\n * 4. delegate. Routes a defined set of control messages to another location.\n * 5. resource. Registers the source as a resource resolver.\n * 6. core. Generates a core provider for the requester.\n * 7. close. Tears down routes involing the requesting port.\n * 8. unlink. Tears down a route from the requesting port.\n * @method onMessage\n * @param {String} flow The source identifier of the message.\n * @param {Object} message The received message.\n */\nfdom.port.Manager.prototype.onMessage = function(flow, message) {\n  var reverseFlow = this.controlFlows[flow], origin;\n  if (!reverseFlow) {\n    fdom.debug.warn(\"Unknown message source: \" + flow);\n    return;\n  }\n  origin = this.hub.getDestination(reverseFlow);\n\n  if (this.delegate && reverseFlow !== this.delegate && this.toDelegate[flow]) {\n    // Ship off to the delegee\n    this.emit(this.delegate, {\n      type: 'Delegation',\n      request: 'handle',\n      quiet: true,\n      flow: flow,\n      message: message\n    });\n    return;\n  }\n\n  if (message.request === 'debug') {\n    if (this.config.debug) {\n      fdom.debug.print(message);\n    }\n    return;\n  }\n\n  if (message.request === 'link') {\n    this.createLink(origin, message.name, message.to, message.overrideDest);\n  } else if (message.request === 'port') {\n    if (message.exposeManager) {\n      message.args = this;\n    }\n    this.createLink(origin, message.name,\n        new fdom.port[message.service](message.args));\n  } else if (message.request === 'bindport') {\n    this.createLink({id: message.id},\n                    'custom' + message.port,\n                    new fdom.port[message.service](message.args),\n                    'default',\n                    true);\n  } else if (message.request === 'delegate') {\n    // Initate Delegation.\n    if (this.delegate === null) {\n      this.delegate = reverseFlow;\n    }\n    this.toDelegate[message.flow] = true;\n    this.emit('delegate');\n  } else if (message.request === 'resource') {\n    fdom.resources.addResolver(message.args[0]);\n    fdom.resources.addRetriever(message.service, message.args[1]);\n  } else if (message.request === 'core') {\n    if (this.core && reverseFlow === this.delegate) {\n      (new this.core()).onMessage(origin, message.message);\n      return;\n    }\n    this.getCore(function(to, core) {\n      this.hub.onMessage(to, {\n        type: 'core',\n        core: core\n      });\n    }.bind(this, reverseFlow));\n  } else if (message.request === 'close') {\n    this.destroy(origin);\n  } else if (message.request === 'unlink') {\n    this.removeLink(origin, message.to);\n  } else {\n    fdom.debug.warn(\"Unknown control request: \" + message.request);\n    fdom.debug.log(JSON.stringify(message));\n    return;\n  }\n};\n\n/**\n * Get the port messages will be routed to given its id.\n * @method getPort\n * @param {String} portId The ID of the port.\n * @returns {fdom.Port} The port with that ID.\n */\nfdom.port.Manager.prototype.getPort = function(portId) {\n  return this.hub.getDestination(this.controlFlows[portId]);\n};\n\n/**\n * Set up a port with the hub.\n * @method setup\n * @param {Port} port The port to register.\n */\nfdom.port.Manager.prototype.setup = function(port) {\n  if (!port.id) {\n    fdom.debug.warn(\"Refusing to setup unidentified port \");\n    return false;\n  }\n\n  if(this.controlFlows[port.id]) {\n    fdom.debug.warn(\"Refusing to re-initialize port \" + port.id);\n    return false;\n  }\n\n  if (!this.config.global) {\n    this.once('config', this.setup.bind(this, port));\n    return;\n  }\n\n  this.hub.register(port);\n  var flow = this.hub.install(this, port.id, \"control\"),\n      reverse = this.hub.install(port, this.id, port.id);\n  this.controlFlows[port.id] = flow;\n  this.dataFlows[port.id] = [reverse];\n  this.reverseFlowMap[flow] = reverse;\n  this.reverseFlowMap[reverse] = flow;\n\n  if (port.lineage) {\n    this.emit('moduleAdd', {id: port.id, lineage: port.lineage});\n  }\n  \n  this.hub.onMessage(flow, {\n    type: 'setup',\n    channel: reverse,\n    config: this.config\n  });\n\n  return true;\n};\n\n/**\n * Tear down a port on the hub.\n * @method destroy\n * @apram {Port} port The port to unregister.\n */\nfdom.port.Manager.prototype.destroy = function(port) {\n  if (!port.id) {\n    fdom.debug.warn(\"Unable to tear down unidentified port\");\n    return false;\n  }\n\n  if (port.lineage) {\n    this.emit('moduleRemove', {id: port.id, lineage: port.lineage});\n  }\n\n  // Remove the port.\n  delete this.controlFlows[port.id];\n\n  // Remove associated links.\n  var i;\n  for (i = this.dataFlows[port.id].length - 1; i >= 0; i -= 1) {\n    this.removeLink(port, this.dataFlows[port.id][i]);\n  }\n\n  // Remove the port.\n  delete this.dataFlows[port.id];\n  this.hub.deregister(port);\n};\n\n/**\n * Create a link between two ports.  Links are created in both directions,\n * and a message with those capabilities is sent to the source port.\n * @method createLink\n * @param {Port} port The source port.\n * @param {String} name The flow for messages from destination to port.\n * @param {Port} destiantion The destination port.\n * @param {String} [destName] The flow name for messages to the destination.\n * @param {Boolean} [toDest] Tell the destination rather than source about the link.\n */\nfdom.port.Manager.prototype.createLink = function(port, name, destination, destName, toDest) {\n  if (!this.config.global) {\n    this.once('config', this.createLink.bind(this, port, name, destination, destName));\n    return;\n  }\n  \n  if (!this.controlFlows[port.id]) {\n    fdom.debug.warn('Unwilling to link from non-registered source.');\n    return;\n  }\n\n  if (!this.controlFlows[destination.id]) {\n    if(this.setup(destination) === false) {\n      fdom.debug.warn('Could not find or setup destination.');\n      return;\n    }\n  }\n  var outgoingName = destName || 'default',\n      outgoing = this.hub.install(port, destination.id, outgoingName),\n      reverse;\n\n  // Recover the port so that listeners are installed.\n  destination = this.hub.getDestination(outgoing);\n  reverse = this.hub.install(destination, port.id, name);\n\n  this.reverseFlowMap[outgoing] = reverse;\n  this.dataFlows[port.id].push(outgoing);\n  this.reverseFlowMap[reverse] = outgoing;\n  this.dataFlows[destination.id].push(reverse);\n\n  if (toDest) {\n    this.hub.onMessage(this.controlFlows[destination.id], {\n      type: 'createLink',\n      name: outgoingName,\n      channel: reverse,\n      reverse: outgoing\n    });\n  } else {\n    this.hub.onMessage(this.controlFlows[port.id], {\n      name: name,\n      type: 'createLink',\n      channel: outgoing,\n      reverse: reverse\n    });\n  }\n};\n\n/**\n * Remove a link between to ports. The reverse link will also be removed.\n * @method removeLink\n * @param {Port} port The source port.\n * @param {String} name The flow to be removed.\n */\nfdom.port.Manager.prototype.removeLink = function(port, name) {\n  var reverse = this.hub.getDestination(name),\n      rflow = this.reverseFlowMap[name],\n      i;\n\n  if (!reverse || !rflow) {\n    fdom.debug.warn(\"Could not find metadata to remove flow: \" + name);\n    return;\n  }\n\n  if (this.hub.getDestination(rflow).id !== port.id) {\n    fdom.debug.warn(\"Source port does not own flow \" + name);\n    return;\n  }\n\n  // Notify ports that a channel is closing.\n  i = this.controlFlows[port.id];\n  if (i) {\n    this.hub.onMessage(i, {\n      type: 'close',\n      channel: name\n    });\n  }\n  i = this.controlFlows[reverse.id];\n  if (i) {\n    this.hub.onMessage(i, {\n      type: 'close',\n      channel: rflow\n    });\n  }\n\n  // Uninstall the channel.\n  this.hub.uninstall(port, name);\n  this.hub.uninstall(reverse, rflow);\n\n  delete this.reverseFlowMap[name];\n  delete this.reverseFlowMap[rflow];\n  this.forgetFlow(reverse.id, rflow);\n  this.forgetFlow(port.id, name);\n};\n\n/**\n * Forget the flow from id with a given name.\n * @method forgetFlow\n * @private\n * @param {String} id The port ID of the source.\n * @param {String} name The flow name.\n */\nfdom.port.Manager.prototype.forgetFlow = function(id, name) {\n  var i;\n  if (this.dataFlows[id]) {\n    for (i = 0; i < this.dataFlows[id].length; i += 1) {\n      if (this.dataFlows[id][i] === name) {\n        this.dataFlows[id].splice(i, 1);\n        break;\n      }\n    }\n  }\n};\n\n/**\n * Get the core freedom.js API active on the current hub.\n * @method getCore\n * @private\n * @param {Function} cb Callback to fire with the core object.\n */\nfdom.port.Manager.prototype.getCore = function(cb) {\n  if (this.core) {\n    cb(this.core);\n  } else {\n    fdom.apis.getCore('core', this).then(function(core) {\n      this.core = core;\n      cb(this.core);\n    }.bind(this));\n  }\n};\n\n","/*globals fdom:true */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * The external Port face of a module on a hub.\n * @class Module\n * @extends Port\n * @param {String} manifestURL The manifest this module loads.\n * @param {String[]} creator The lineage of creation for this module.\n * @constructor\n */\nfdom.port.Module = function(manifestURL, manifest, creator) {\n  this.config = {};\n  this.id = manifestURL + Math.random();\n  this.manifestId = manifestURL;\n  this.manifest = manifest;\n  this.lineage = [this.manifestId].concat(creator);\n  this.externalPortMap = {};\n  this.internalPortMap = {};\n  this.started = false;\n\n  fdom.util.handleEvents(this);\n};\n\n/**\n * Receive a message for the Module.\n * @method onMessage\n * @param {String} flow The origin of the message.\n * @param {Object} message The message received.\n */\nfdom.port.Module.prototype.onMessage = function(flow, message) {\n  if (flow === 'control') {\n    if (message.type === 'setup') {\n      this.controlChannel = message.channel;\n      fdom.util.mixin(this.config, message.config);\n      this.emit(this.controlChannel, {\n        type: 'Core Provider',\n        request: 'core'\n      });\n      this.start();\n      return;\n    } else if (message.type === 'createLink' && message.channel) {\n      this.externalPortMap[message.name] = message.channel;\n      if (this.internalPortMap[message.name] === undefined) {\n        this.internalPortMap[message.name] = false;\n      }\n      this.emit(message.channel, {\n        type: 'default channel announcement',\n        channel: message.reverse\n      });\n      return;\n    } else if (message.core) {\n      this.core = new message.core();\n      this.emit('core', message.core);\n      return;\n    } else if (message.type === 'close') {\n      // Closing channel.\n      if (message.channel === 'control') {\n        this.stop();\n      }\n      this.deregisterFlow(message.channel, false);\n    } else {\n      this.port.onMessage(flow, message);\n    }\n  } else {\n    if ((this.externalPortMap[flow] === false ||\n        !this.externalPortMap[flow])&& message.channel) {\n      //console.log('handling channel announcement for ' + flow);\n      this.externalPortMap[flow] = message.channel;\n      if (this.internalPortMap[flow] === undefined) {\n        this.internalPortMap[flow] = false;\n\n        // New incoming connection attempts should get routed to modInternal.\n        if (this.manifest.provides && this.modInternal) {\n          this.port.onMessage(this.modInternal, {\n            type: 'Connection',\n            channel: flow\n          });\n        } else if (this.manifest.provides) {\n          this.once('modInternal', function(flow) {\n            this.port.onMessage(this.modInternal,{\n              type: 'Connection',\n              channel: flow\n            });\n          }.bind(this, flow));\n        // First connection retains legacy mapping as 'default'.\n        } else if (!this.externalPortMap['default'] && message.channel) {\n          this.externalPortMap['default'] = message.channel;\n          this.once('internalChannelReady', function(flow) {\n            this.internalPortMap[flow] = this.internalPortMap['default'];\n          }.bind(this, flow));\n        }\n      }\n      return;\n    } else if (!this.started) {\n      this.once('start', this.onMessage.bind(this, flow, message));\n    } else {\n      if (this.internalPortMap[flow] === false) {\n        this.once('internalChannelReady', this.onMessage.bind(this, flow, message));\n      } else if (!this.internalPortMap[flow]) {\n        fdom.debug.error('Unexpected message from ' + flow);\n        return;\n      } else {\n        this.port.onMessage(this.internalPortMap[flow], message);\n      }\n    }\n  }\n};\n\n/**\n * Clean up after a flow which is no longer used / needed.\n * @method deregisterFLow\n * @param {String} flow The flow to remove mappings for.\n * @param {Boolean} internal If the flow name is the internal identifier.\n * @returns {Boolean} Whether the flow was successfully deregistered.\n * @private\n */\nfdom.port.Module.prototype.deregisterFlow = function(flow, internal) {\n  var key,\n      map = internal ? this.internalPortMap : this.externalPortMap;\n  // TODO: this is inefficient, but seems less confusing than a 3rd\n  // reverse lookup map.\n  for (key in map) {\n    if (map[key] === flow) {\n      if (internal) {\n        this.emit(this.controlChannel, {\n          type: 'Channel Teardown',\n          request: 'unlink',\n          to: this.externalPortMap[key]\n        });\n      } else {\n        this.port.onMessage('control', {\n          type: 'close',\n          channel: this.internalPortMap[key]\n        });\n      }\n      delete this.externalPortMap[key];\n      delete this.internalPortMap[key];\n      return true;\n    }\n  }\n  return false;\n};\n\n/**\n * Attempt to start the module once the remote freedom context\n * exists.\n * @method start\n * @private\n */\nfdom.port.Module.prototype.start = function() {\n  if (this.started || this.port) {\n    return false;\n  }\n  if (this.controlChannel) {\n    this.loadLinks();\n    this.port = new fdom.link[this.config.portType](this.manifestId);\n    // Listen to all port messages.\n    this.port.on(this.emitMessage.bind(this));\n    // Tell the local port to ask us for help.\n    this.port.onMessage('control', {\n      channel: 'control',\n      config: this.config\n    });\n\n    // Tell the remote location to delegate debugging.\n    this.port.onMessage('control', {\n      type: 'Redirect',\n      request: 'delegate',\n      flow: 'debug'\n    });\n    this.port.onMessage('control', {\n      type: 'Redirect',\n      request: 'delegate',\n      flow: 'core'\n    });\n    \n    // Tell the container to instantiate the counterpart to this external view.\n    this.port.onMessage('control', {\n      type: 'Environment Configuration',\n      request: 'port',\n      name: 'ModInternal',\n      service: 'ModuleInternal',\n      exposeManager: true\n    });\n  }\n};\n\n/**\n * Stop the module when it is no longer needed, and tear-down state.\n * @method stop\n * @private\n */\nfdom.port.Module.prototype.stop = function() {\n  if (!this.started) {\n    return;\n  }\n  if (this.port) {\n    this.port.off();\n    this.port.onMessage('control', {\n      type: 'close',\n      channel: 'control'\n    });\n    delete this.port;\n  }\n  this.started = false;\n};\n\n/**\n * Textual Description of the Port\n * @method toString\n * @return {String} The description of this Port.\n */\nfdom.port.Module.prototype.toString = function() {\n  return \"[Module \" + this.manifest.name +\"]\";\n};\n\n/**\n * Intercept messages as they arrive from the module,\n * mapping them between internal and external flow names.\n * @method emitMessage\n * @param {String} name The destination the module wants to send to.\n * @param {Object} message The message to send.\n * @private\n */\nfdom.port.Module.prototype.emitMessage = function(name, message) {\n  if (this.internalPortMap[name] === false && message.channel) {\n    this.internalPortMap[name] = message.channel;\n    this.emit('internalChannelReady');\n    return;\n  }\n  // Terminate debug redirection requested in start().\n  if (name === 'control') {\n    if (message.flow === 'debug' && message.message) {\n      fdom.debug.format(message.message.severity,\n          this.toString(),\n          message.message.msg);\n    } else if (message.flow === 'core' && message.message) {\n      if (!this.core) {\n        this.once('core', this.emitMessage.bind(this, name, message));\n        return;\n      }\n      if (message.message.type === 'register') {\n        message.message.reply = this.port.onMessage.bind(this.port, 'control');\n        this.externalPortMap[message.message.id] = false;\n      }\n      this.core.onMessage(this, message.message);\n    } else if (message.name === 'ModInternal' && !this.modInternal) {\n      this.modInternal = message.channel;\n      this.port.onMessage(this.modInternal, {\n        type: 'Initialization',\n        id: this.manifestId,\n        appId: this.id,\n        manifest: this.manifest,\n        lineage: this.lineage,\n        channel: message.reverse\n      });\n      this.emit('modInternal');\n    } else if (message.type === 'createLink') {\n      // A design decision was that the default channel is\n      // overridden when acting as a provider.\n      if (this.manifest.provides &&\n          this.manifest.provides.indexOf(message.name) === 0) {\n        this.internalPortMap['default'] = message.channel;\n      }\n\n      this.internalPortMap[message.name] = message.channel;\n      this.port.onMessage(message.channel, {\n        type: 'channel announcement',\n        channel: message.reverse\n      });\n      this.emit('internalChannelReady');\n    } else if (message.type === 'close') {\n      this.deregisterFlow(message.channel, true);\n    }\n  } else if (name === 'ModInternal' && message.type === 'ready' && !this.started) {\n    this.started = true;\n    this.emit('start');\n  } else if (name === 'ModInternal' && message.type === 'resolve') {\n    fdom.resources.get(this.manifestId, message.data).then(function(id, data) {\n      this.port.onMessage(this.modInternal, {\n        type: 'resolve response',\n        id: id,\n        data: data\n      });\n    }.bind(this, message.id), function() {\n      fdom.debug.warn('Error Resolving URL for Module.');\n    });\n  } else {\n    this.emit(this.externalPortMap[name], message);\n  }\n  return false;\n};\n\n/**\n * Request the external routes used by this module.\n * @method loadLinks\n * @private\n */\nfdom.port.Module.prototype.loadLinks = function() {\n  var i, channels = ['default'], name, dep,\n      finishLink = function(dep, provider) {\n        dep.getInterface().provideAsynchronous(provider);\n      };\n  if (this.manifest.permissions) {\n    for (i = 0; i < this.manifest.permissions.length; i += 1) {\n      name = this.manifest.permissions[i];\n      if (channels.indexOf(name) < 0 && name.indexOf('core.') === 0) {\n        channels.push(name);\n        dep = new fdom.port.Provider(fdom.apis.get(name).definition);\n        fdom.apis.getCore(name, this).then(finishLink.bind(this, dep));\n\n        this.emit(this.controlChannel, {\n          type: 'Core Link to ' + name,\n          request: 'link',\n          name: name,\n          to: dep\n        });\n      }\n    }\n  }\n  if (this.manifest.dependencies) {\n    fdom.util.eachProp(this.manifest.dependencies, function(desc, name) {\n      if (channels.indexOf(name) < 0) {\n        channels.push(name);\n      }\n      fdom.resources.get(this.manifestId, desc.url).then(function (url) {\n        this.config.policy.get(this.lineage, url).then(function(dep) {\n          this.emit(this.controlChannel, {\n            type: 'Link to ' + name,\n            request: 'link',\n            name: name,\n            overrideDest: name + '.' + this.id,\n            to: dep\n          });\n        }.bind(this));\n        fdom.resources.getContents(url).then(this.updateEnv.bind(this, name));\n      }.bind(this));\n    }.bind(this));\n  }\n  // Note that messages can be synchronous, so some ports may already be bound.\n  for (i = 0; i < channels.length; i += 1) {\n    this.externalPortMap[channels[i]] = this.externalPortMap[channels[i]] || false;\n    this.internalPortMap[channels[i]] = false;\n  }\n};\n\n/**\n * Update the module environment with information about a dependent manifest.\n * @method updateEnv\n * @param {String} dep The dependency\n * @param {Object} manifest The manifest of the dependency\n */\nfdom.port.Module.prototype.updateEnv = function(dep, manifest) {\n  if (!manifest) {\n    return;\n  }\n  if (!this.modInternal) {\n    this.once('modInternal', this.updateEnv.bind(this, dep, manifest));\n  }\n  // Decide if/what other properties should be exported.\n  // Keep in sync with ModuleInternal.updateEnv\n  var metadata = {\n    name: manifest.name,\n    icon: manifest.icon,\n    description: manifest.description\n  };\n  \n  this.port.onMessage(this.modInternal, {\n    type: 'manifest',\n    name: dep,\n    manifest: metadata\n  });\n};\n\nfdom.port.Module.prototype.serialize = function() {\n  return JSON.serialize({\n    manifestId: this.manifestId,\n    externalPortMap: this.externalPortMap,\n    internalPortMap: this.internalPortMap,\n    manifest: this.manifest,\n    controlChannel: this.controlChannel\n  });\n};\n","/*globals fdom:true, Promise */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * The internal logic for module setup, which makes sure the public\n * facing exports have appropriate properties, and load user scripts.\n * @class ModuleInternal\n * @extends Port\n * @param {Port} manager The manager in this module to use for routing setup.\n * @constructor\n */\nfdom.port.ModuleInternal = function(manager) {\n  this.config = {};\n  this.manager = manager;\n  this.manifests = {};\n  \n  this.id = 'ModuleInternal-' + Math.random();\n  this.pendingPorts = 0;\n  this.requests = {};\n  this.defaultProvider = null;\n\n  fdom.util.handleEvents(this);\n};\n\n/**\n * Message handler for this port.\n * This port only handles two messages:\n * The first is its setup from the manager, which it uses for configuration.\n * The second is from the module controller (fdom.port.Module), which provides\n * the manifest info for the module.\n * @method onMessage\n * @param {String} flow The detination of the message.\n * @param {Object} message The message.\n */\nfdom.port.ModuleInternal.prototype.onMessage = function(flow, message) {\n  if (flow === 'control') {\n    if (!this.controlChannel && message.channel) {\n      this.controlChannel = message.channel;\n      fdom.util.mixin(this.config, message.config);\n    }\n  } else if (flow === 'default' && !this.appId) {\n    // Recover the ID of this module:\n    this.port = this.manager.hub.getDestination(message.channel);\n    this.externalChannel = message.channel;\n    this.appId = message.appId;\n    this.lineage = message.lineage;\n\n    var objects = this.mapProxies(message.manifest);\n\n    this.updateEnv(message.manifest);\n    this.once('start', this.loadScripts.bind(this, message.id,\n        message.manifest.app.script));\n    this.loadLinks(objects);\n  } else if (flow === 'default' && this.requests[message.id]) {\n    this.requests[message.id](message.data);\n    delete this.requests[message.id];\n  } else if (flow === 'default' && message.type === 'manifest') {\n    this.updateManifest(message.name, message.manifest);\n  } else if (flow === 'default' && message.type === 'Connection') {\n    // Multiple connections can be made to the default provider.\n    if (this.defaultProvider) {\n      this.manager.createLink(this.defaultProvider, message.channel,\n                              this.port, message.channel);\n    }\n  }\n};\n\n/**\n * Get a textual description of this Port.\n * @method toString\n * @return {String} a description of this Port.\n */\nfdom.port.ModuleInternal.prototype.toString = function() {\n  return \"[Module Environment Helper]\";\n};\n\n/**\n * Attach the manifest of the active module to the externally visible namespace.\n * @method updateEnv\n * @param {Object} manifest The manifest of the module.\n * @private\n */\nfdom.port.ModuleInternal.prototype.updateEnv = function(manifest) {\n  // Decide if/what other properties should be exported.\n  // Keep in sync with Module.updateEnv\n  var exp = this.config.global.freedom, metadata = {\n    name: manifest.name,\n    icon: manifest.icon,\n    description: manifest.description\n  };\n\n  if (exp) {\n    exp.manifest = metadata;\n  }\n};\n\n/**\n * Attach a proxy to the externally visible namespace.\n * @method attach\n * @param {String} name The name of the proxy.\n * @param {Proxy} proxy The proxy to attach.\n * @param {String} api The API the proxy implements.\n * @private.\n */\nfdom.port.ModuleInternal.prototype.attach = function(name, proxy, api) {\n  var exp = this.config.global.freedom;\n\n  if (!exp[name]) {\n    exp[name] = proxy.getProxyInterface();\n    if (api) {\n      exp[name].api = api;\n    }\n    if (this.manifests[name]) {\n      exp[name].manifest = this.manifests[name];\n    }\n  }\n\n  this.pendingPorts -= 1;\n  if (this.pendingPorts === 0) {\n    this.emit('start');\n  }\n};\n\n/**\n * Request a set of proxy interfaces, and bind them to the external\n * namespace.\n * @method loadLinks\n * @param {Object[]} items Descriptors of the proxy ports to load.\n * @private\n */\nfdom.port.ModuleInternal.prototype.loadLinks = function(items) {\n  var i, proxy, provider, core, api;\n  for (i = 0; i < items.length; i += 1) {\n    api = undefined;\n    if (items[i].def) {\n      api = items[i].def.name;\n      if (items[i].provides) {\n        proxy = new fdom.port.Provider(items[i].def.definition);\n        if (!this.defaultProvider) {\n          this.defaultProvider = proxy;\n        }\n      } else {\n        proxy = new fdom.port.Proxy(fdom.proxy.ApiInterface.bind({},\n            items[i].def.definition));\n      }\n    } else {\n      proxy = new fdom.port.Proxy(fdom.proxy.EventInterface);\n    }\n    \n    proxy.once('start', this.attach.bind(this, items[i].name, proxy, api));\n    this.manager.createLink(this.port, items[i].name, proxy);\n    this.pendingPorts += 1;\n  }\n  \n  // Allow resolution of files by parent.\n  fdom.resources.addResolver(function(manifest, url, resolve) {\n    var id = Math.random();\n    this.requests[id] = resolve;\n    this.emit(this.externalChannel, {\n      type: 'resolve',\n      id: id,\n      data: url\n    });\n    return true;\n  }.bind(this));\n\n  // Attach Core.\n  this.pendingPorts += 1;\n\n  core = fdom.apis.get('core').definition;\n  provider = new fdom.port.Provider(core);\n  this.manager.getCore(function(CoreProv) {\n    new CoreProv(this.manager).setId(this.lineage);\n    provider.getInterface().provideAsynchronous(CoreProv);\n  }.bind(this));\n\n  this.emit(this.controlChannel, {\n    type: 'Link to core',\n    request: 'link',\n    name: 'core',\n    to: provider\n  });\n\n  proxy = new fdom.port.Proxy(fdom.proxy.ApiInterface.bind({}, core));\n  this.manager.createLink(provider, 'default', proxy);\n  this.attach('core', proxy);\n\n  if (this.pendingPorts === 0) {\n    this.emit('start');\n  }\n};\n\n/**\n * Update the exported manifest of a dependency.\n * Sets it internally if not yet exported, or attaches the property if it\n * is loaded after the module has started (we don't delay start to retreive\n * the manifest of the dependency.)\n * @method updateManifest\n * @param {String} name The Dependency\n * @param {Object} manifest The manifest of the dependency\n */\nfdom.port.ModuleInternal.prototype.updateManifest = function(name, manifest) {\n  var exp = this.config.global.freedom;\n\n  if (exp[name]) {\n    exp[name].manifest = manifest;\n  } else {\n    this.manifests[name] = manifest;\n  }\n};\n\n/**\n * Determine which proxy ports should be exposed by this module.\n * @method mapProxies\n * @param {Object} manifest the module JSON manifest.\n * @return {Object[]} proxy descriptors defined in the manifest.\n */\nfdom.port.ModuleInternal.prototype.mapProxies = function(manifest) {\n  var proxies = [], seen = ['core'], i, obj;\n  \n  if (manifest.permissions) {\n    for (i = 0; i < manifest.permissions.length; i += 1) {\n      obj = {\n        name: manifest.permissions[i],\n        def: undefined\n      };\n      obj.def = fdom.apis.get(obj.name);\n      if (seen.indexOf(obj.name) < 0 && obj.def) {\n        proxies.push(obj);\n        seen.push(obj.name);\n      }\n    }\n  }\n  \n  if (manifest.dependencies) {\n    fdom.util.eachProp(manifest.dependencies, function(desc, name) {\n      obj = {\n        name: name\n      };\n      if (seen.indexOf(name) < 0) {\n        if (desc.api) {\n          obj.def = fdom.apis.get(desc.api);\n        }\n        proxies.push(obj);\n        seen.push(name);\n      }\n    });\n  }\n  \n  if (manifest.provides) {\n    for (i = 0; i < manifest.provides.length; i += 1) {\n      obj = {\n        name: manifest.provides[i],\n        def: undefined,\n        provides: true\n      };\n      obj.def = fdom.apis.get(obj.name);\n      if (seen.indexOf(obj.name) < 0 && obj.def) {\n        proxies.push(obj);\n        seen.push(obj.name);\n      }\n    }\n  }\n\n  return proxies;\n};\n\n/**\n * Load external scripts into this namespace.\n * @method loadScripts\n * @param {String} from The URL of this modules's manifest.\n * @param {String[]} scripts The URLs of the scripts to load.\n */\nfdom.port.ModuleInternal.prototype.loadScripts = function(from, scripts) {\n  var i = 0,\n      safe = true,\n      importer = function importScripts(script, resolve) {\n        this.config.global.importScripts(script);\n        resolve();\n      }.bind(this),\n      urls = [],\n      outstanding = 0,\n      load = function(url) {\n        urls.push(url);\n        outstanding -= 1;\n        if (outstanding === 0) {\n          if (safe) {\n            this.emit(this.externalChannel, {\n              type: 'ready'\n            });\n            this.tryLoad(importer, urls);\n          } else {\n            this.tryLoad(importer, urls).then(function() {\n              this.emit(this.externalChannel, {\n                type: 'ready'\n              });\n            }.bind(this));\n          }\n        }\n      }.bind(this);\n\n  if (!this.config.global.importScripts) {\n    safe = false;\n    importer = function(url, resolve) {\n      var script = this.config.global.document.createElement('script');\n      script.src = url;\n      script.addEventListener('load', resolve, true);\n      this.config.global.document.body.appendChild(script);\n    }.bind(this);\n  }\n\n  if (typeof scripts === 'string') {\n    outstanding = 1;\n    fdom.resources.get(from, scripts).then(load);\n  } else {\n    outstanding = scripts.length;\n    for (i = 0; i < scripts.length; i += 1) {\n      fdom.resources.get(from, scripts[i]).then(load);\n    }\n  }\n};\n\n/**\n * Attempt to load resolved scripts into the namespace.\n * @method tryLoad\n * @private\n * @param {Function} importer The actual import function\n * @param {String[]} urls The resoved URLs to load.\n * @returns {Promise} completion of load\n */\nfdom.port.ModuleInternal.prototype.tryLoad = function(importer, urls) {\n  var i,\n      promises = [];\n  try {\n    for (i = 0; i < urls.length; i += 1) {\n      promises.push(new Promise(importer.bind({}, urls[i])));\n    }\n  } catch(e) {\n    fdom.debug.warn(e.stack);\n    fdom.debug.error(\"Error loading \" + urls[i], e);\n    fdom.debug.error(\"If the stack trace is not useful, see https://\" +\n        \"github.com/UWNetworksLab/freedom/wiki/Debugging-Script-Parse-Errors\");\n  }\n  return Promise.all(promises);\n};\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * A freedom port for a user-accessable provider.\n * @class Provider\n * @extends Port\n * @uses handleEvents\n * @param {Object} def The interface of the provider.\n * @contructor\n */\nfdom.port.Provider = function(def) {\n  this.id = fdom.port.Proxy.nextId();\n  fdom.util.handleEvents(this);\n  \n  this.definition = def;\n  this.mode = fdom.port.Provider.mode.synchronous;\n  this.channels = {};\n  this.iface = null;\n  this.providerCls = null;\n  this.providerInstances = {};\n};\n\n/**\n * Provider modes of operation.\n * @property mode\n * @static\n * @type number\n */\nfdom.port.Provider.mode = {\n  synchronous: 0,\n  asynchronous: 1,\n  promises: 2\n};\n\n/**\n * Receive external messages for the provider.\n * @method onMessage\n * @param {String} source the source identifier of the message.\n * @param {Object} message The received message.\n */\nfdom.port.Provider.prototype.onMessage = function(source, message) {\n  if (source === 'control' && message.reverse) {\n    this.channels[message.name] = message.channel;\n    this.emit(message.channel, {\n      type: 'channel announcement',\n      channel: message.reverse\n    });\n    this.emit('start');\n  } else if (source === 'control' && message.type === 'setup') {\n    this.controlChannel = message.channel;\n  } else if (source === 'control' && message.type === 'close') {\n    if (message.channel === this.controlChannel) {\n      delete this.controlChannel;\n    }\n    this.close();\n  } else {\n    if (!this.channels[source] && message.channel) {\n      this.channels[source] = message.channel;\n      this.emit('start');\n      return;\n    } else if(!this.channels[source]) {\n      fdom.debug.warn('Message from unconfigured source: ' + source);\n      return;\n    }\n\n    if (message.type === 'close' && message.to) {\n      delete this.providerInstances[source][message.to];\n    } else if (message.to && this.providerInstances[source] &&\n               this.providerInstances[source][message.to]) {\n      message.message.to = message.to;\n      this.providerInstances[source][message.to](message.message);\n    } else if (message.to && message.message &&\n        message.message.type === 'construct') {\n      var args = fdom.proxy.portableToMessage(\n          this.definition.constructor ? this.definition.constructor.value : [],\n          message.message);\n      if (!this.providerInstances[source]) {\n        this.providerInstances[source] = {};\n      }\n      this.providerInstances[source][message.to] = this.getProvider(source, message.to, args);\n    } else {\n      fdom.debug.warn(this.toString() + ' dropping message ' +\n          JSON.stringify(message));\n    }\n  }\n};\n\n/**\n * Close / teardown the flow this provider terminates.\n * @method close\n */\nfdom.port.Provider.prototype.close = function() {\n  if (this.controlChannel) {\n    this.emit(this.controlChannel, {\n      type: 'Provider Closing',\n      request: 'close'\n    });\n    delete this.controlChannel;\n  }\n  this.emit('close');\n\n  this.providerInstances = {};\n  this.emitChannel = null;\n};\n\n/**\n * Get an interface to expose externally representing this port.\n * Providers are registered with the port using either\n * provideSynchronous or provideAsynchronous depending on the desired\n * return interface.\n * @method getInterface\n * @return {Object} The external interface of this Provider.\n */\nfdom.port.Provider.prototype.getInterface = function() {\n  if (this.iface) {\n    return this.iface;\n  } else {\n    this.iface = {\n      provideSynchronous: function(prov) {\n        this.providerCls = prov;\n        this.mode = fdom.port.Provider.mode.synchronous;\n      }.bind(this),\n      provideAsynchronous: function(prov) {\n        this.providerCls = prov;\n        this.mode = fdom.port.Provider.mode.asynchronous;\n      }.bind(this),\n      providePromises: function(prov) {\n        this.providerCls = prov;\n        this.mode = fdom.port.Provider.mode.promises;\n      }.bind(this),\n      close: function() {\n        this.close();\n      }.bind(this)\n    };\n\n    fdom.util.eachProp(this.definition, function(prop, name) {\n      switch(prop.type) {\n      case \"constant\":\n        Object.defineProperty(this.iface, name, {\n          value: fdom.proxy.recursiveFreezeObject(prop.value),\n          writable: false\n        });\n        break;\n      }\n    }.bind(this));\n\n    return this.iface;\n  }\n};\n\n/**\n * Create a function that can be used to get interfaces from this provider from\n * a user-visible point.\n * @method getProxyInterface\n */\nfdom.port.Provider.prototype.getProxyInterface = function() {\n  var func = function(p) {\n    return p.getInterface();\n  }.bind({}, this);\n\n  func.close = function(iface) {\n    if (iface) {\n      fdom.util.eachProp(this.ifaces, function(candidate, id) {\n        if (candidate === iface) {\n          this.teardown(id);\n          this.emit(this.emitChannel, {\n            type: 'close',\n            to: id\n          });\n          return true;\n        }\n      }.bind(this));\n    } else {\n      // Close the channel.\n      this.close();\n    }\n  }.bind(this);\n\n  func.onClose = function(iface, handler) {\n    if (typeof iface === 'function' && handler === undefined) {\n      // Add an on-channel-closed handler.\n      this.once('close', iface);\n      return;\n    }\n\n    fdom.util.eachProp(this.ifaces, function(candidate, id) {\n      if (candidate === iface) {\n        if (this.handlers[id]) {\n          this.handlers[id].push(handler);\n        } else {\n          this.handlers[id] = [handler];\n        }\n        return true;\n      }\n    }.bind(this));\n  }.bind(this);\n\n  return func;\n};\n\n/**\n * Get a new instance of the registered provider.\n * @method getProvider\n * @param {String} source The port this instance is interactign with.\n * @param {String} identifier the messagable address for this provider.\n * @param {Array} args Constructor arguments for the provider.\n * @return {Function} A function to send messages to the provider.\n */\nfdom.port.Provider.prototype.getProvider = function(source, identifier, args) {\n  if (!this.providerCls) {\n    fdom.debug.warn('Cannot instantiate provider, since it is not provided');\n    return null;\n  }\n\n  var events = {},\n      dispatchEvent,\n      BoundClass,\n      instance;\n\n  fdom.util.eachProp(this.definition, function(prop, name) {\n    if (prop.type === 'event') {\n      events[name] = prop;\n    }\n  });\n\n  dispatchEvent = function(src, ev, id, name, value) {\n    if (ev[name]) {\n      var streams = fdom.proxy.messageToPortable(ev[name].value, value);\n      this.emit(this.channels[src], {\n        type: 'message',\n        to: id,\n        message: {\n          name: name,\n          type: 'event',\n          text: streams.text,\n          binary: streams.binary\n        }\n      });\n    }\n  }.bind(this, source, events, identifier);\n\n  // this is all to say: new providerCls(dispatchEvent, args[0], args[1],...)\n  BoundClass = this.providerCls.bind.apply(this.providerCls,\n      [this.providerCls, dispatchEvent].concat(args || []));\n  instance = new BoundClass();\n\n  return function(port, src, msg) {\n    if (msg.action === 'method') {\n      if (typeof this[msg.type] !== 'function') {\n        fdom.debug.warn(\"Provider does not implement \" + msg.type + \"()!\");\n        return;\n      }\n      var prop = port.definition[msg.type],\n          args = fdom.proxy.portableToMessage(prop.value, msg),\n          ret = function(src, msg, prop, resolve, reject) {\n            var streams = fdom.proxy.messageToPortable(prop.ret, resolve);\n            this.emit(this.channels[src], {\n              type: 'method',\n              to: msg.to,\n              message: {\n                to: msg.to,\n                type: 'method',\n                reqId: msg.reqId,\n                name: msg.type,\n                text: streams.text,\n                binary: streams.binary,\n                error: reject\n              }\n            });\n          }.bind(port, src, msg, prop);\n      if (!Array.isArray(args)) {\n        args = [args];\n      }\n      if (port.mode === fdom.port.Provider.mode.synchronous) {\n        try {\n          ret(this[msg.type].apply(this, args));\n        } catch(e) {\n          ret(undefined, e.message);\n        }\n      } else if (port.mode === fdom.port.Provider.mode.asynchronous) {\n        this[msg.type].apply(instance, args.concat(ret));\n      } else if (port.mode === fdom.port.Provider.mode.promises) {\n        this[msg.type].apply(this, args).then(ret, ret.bind({}, undefined));\n      }\n    }\n  }.bind(instance, this, source);\n};\n\n/**\n * Get a textual description of this port.\n * @method toString\n * @return {String} the description of this port.\n */\nfdom.port.Provider.prototype.toString = function() {\n  if (this.emitChannel) {\n    return \"[Provider \" + this.emitChannel + \"]\";\n  } else {\n    return \"[unbound Provider]\";\n  }\n};\n","/*globals fdom:true */\n/*jslint indent:2, white:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.port = fdom.port || {};\n\n/**\n * A freedom port for a user-accessable proxy.\n * @class Proxy\n * @extends Port\n * @uses handleEvents\n * @param {Object} interfaceCls The proxy interface exposed by this proxy.\n * @constructor\n */\nfdom.port.Proxy = function(interfaceCls) {\n  this.id = fdom.port.Proxy.nextId();\n  this.interfaceCls = interfaceCls;\n  fdom.util.handleEvents(this);\n  \n  this.ifaces = {};\n  this.closeHandlers = {};\n  this.errorHandlers = {};\n  this.emits = {};\n};\n\n/**\n * Receive incoming messages for this proxy.\n * @method onMessage\n * @param {String} source The source of the message.\n * @param {Object} message The received message.\n */\nfdom.port.Proxy.prototype.onMessage = function(source, message) {\n  if (source === 'control' && message.reverse) {\n    this.emitChannel = message.channel;\n    this.emit(this.emitChannel, {\n      type: 'channel announcement',\n      channel: message.reverse\n    });\n    this.emit('start');\n  } else if (source === 'control' && message.type === 'setup') {\n    this.controlChannel = message.channel;\n  } else if (source === 'control' && message.type === 'close') {\n    delete this.controlChannel;\n    this.doClose();\n  } else {\n    if (!this.emitChannel && message.channel) {\n      this.emitChannel = message.channel;\n      this.emit('start');\n      return;\n    }\n    if (message.type === 'close' && message.to) {\n      this.teardown(message.to);\n      return;\n    }\n    if (message.type === 'error') {\n      this.error(message.to, message.message);\n      return;\n    }\n    if (message.to) {\n      if (this.emits[message.to]) {\n        this.emits[message.to]('message', message.message);\n      } else {\n        fdom.debug.warn('Could not deliver message, no such interface: ' + message.to);\n      }\n    } else {\n      var msg = message.message;\n      fdom.util.eachProp(this.emits, function(iface) {\n        iface('message', message.message);\n      });\n    }\n  }\n};\n\n/**\n * Create a proxy.Interface associated with this proxy.\n * An interface is returned, which is supplied with important control of the\n * proxy via constructor arguments: (bound below in getInterfaceConstructor)\n * \n * onMsg: function(binder) sets the function to call when messages for this\n *    interface arrive on the channel,\n * emit: function(msg) allows this interface to emit messages,\n * id: string is the Identifier for this interface.\n * @method getInterface\n */\nfdom.port.Proxy.prototype.getInterface = function() {\n  var Iface = this.getInterfaceConstructor(),\n      args = Array.prototype.slice.call(arguments, 0);\n  Iface = Iface.bind.apply(Iface, [Iface].concat(args));\n  return new Iface();\n};\n\n/**\n * Create a function that can be used to get interfaces from this proxy from\n * a user-visible point.\n * @method getProxyInterface\n */\nfdom.port.Proxy.prototype.getProxyInterface = function() {\n  var func = function(p) {\n    var args = Array.prototype.slice.call(arguments, 1);\n    return p.getInterface(args);\n  }.bind({}, this);\n\n  func.close = function(iface) {\n    if (iface) {\n      fdom.util.eachProp(this.ifaces, function(candidate, id) {\n        if (candidate === iface) {\n          this.teardown(id);\n          this.emit(this.emitChannel, {\n            type: 'close',\n            to: id\n          });\n          return true;\n        }\n      }.bind(this));\n    } else {\n      // Close the channel.\n      this.doClose();\n    }\n  }.bind(this);\n\n  func.onClose = function(iface, handler) {\n    if (typeof iface === 'function' && handler === undefined) {\n      // Add an on-channel-closed handler.\n      this.once('close', iface);\n      return;\n    }\n\n    fdom.util.eachProp(this.ifaces, function(candidate, id) {\n      if (candidate === iface) {\n        if (this.closeHandlers[id]) {\n          this.closeHandlers[id].push(handler);\n        } else {\n          this.closeHandlers[id] = [handler];\n        }\n        return true;\n      }\n    }.bind(this));\n  }.bind(this);\n\n  func.onError = function(iface, handler) {\n    if (typeof iface === 'function' && handler === undefined) {\n      this.on('error', iface);\n      return;\n    }\n    fdom.util.eachProp(this.ifaces, function(candidate, id) {\n      if (candidate === iface) {\n        if (this.errorHandlers[id]) {\n          this.errorHandlers[id].push(handler);\n        } else {\n          this.errorHandlers[id] = [handler];\n        }\n        return true;\n      }\n    }.bind(this));\n  }.bind(this);\n  \n  return func;\n};\n\n/**\n * Provides a bound class for creating a proxy.Interface associated\n * with this proxy. This partial level of construction can be used\n * to allow the proxy to be used as a provider for another API.\n * @method getInterfaceConstructor\n * @private\n */\nfdom.port.Proxy.prototype.getInterfaceConstructor = function() {\n  var id = fdom.port.Proxy.nextId();\n  return this.interfaceCls.bind({}, function(id, obj, binder) {\n    this.ifaces[id] = obj;\n    this.emits[id] = binder;\n  }.bind(this, id), this.doEmit.bind(this, id));\n};\n\n/**\n * Emit a message on the channel once setup is complete.\n * @method doEmit\n * @private\n * @param {String} to The ID of the flow sending the message.\n * @param {Object} msg The message to emit\n * @param {Boolean} all Send message to all recipients.\n */\nfdom.port.Proxy.prototype.doEmit = function(to, msg, all) {\n  if (all) {\n    to = false;\n  }\n  if (this.emitChannel) {\n    this.emit(this.emitChannel, {to: to, type:'message', message: msg});\n  } else {\n    this.once('start', this.doEmit.bind(this, to, msg));\n  }\n};\n\n/**\n * Teardown a single interface of this proxy.\n * @method teardown\n * @param {String} id The id of the interface to tear down.\n */\nfdom.port.Proxy.prototype.teardown = function(id) {\n  delete this.emits[id];\n  if (this.closeHandlers[id]) {\n    fdom.util.eachProp(this.closeHandlers[id], function(prop) {\n      prop();\n    });\n  }\n  delete this.ifaces[id];\n  delete this.closeHandlers[id];\n  delete this.errorHandlers[id];\n};\n\n/**\n * Handle a message error reported to this proxy.\n * @method error\n * @param {String?} id The id of the interface where the error occured.\n * @param {Object} message The message which failed, if relevant.\n */\nfdom.port.Proxy.prototype.error = function(id, message) {\n  if (id && this.errorHandlers[id]) {\n    fdom.util.eachProp(this.errorHandlers[id], function(prop) {\n      prop(message);\n    });\n  } else if (!id) {\n    this.emit('error', message);\n  }\n};\n\n\n/**\n * Close / teardown the flow this proxy terminates.\n * @method doClose\n */\nfdom.port.Proxy.prototype.doClose = function() {\n  if (this.controlChannel) {\n    this.emit(this.controlChannel, {\n      type: 'Channel Closing',\n      request: 'close'\n    });\n  }\n\n  fdom.util.eachProp(this.emits, function(emit, id) {\n    this.teardown(id);\n  }.bind(this));\n\n  this.emit('close');\n  this.off();\n\n  this.emitChannel = null;\n};\n\n/**\n * Get the textual description of this port.\n * @method toString\n * @return The description of this port.\n */\nfdom.port.Proxy.prototype.toString = function() {\n  if (this.emitChannel) {\n    return \"[Proxy \" + this.emitChannel + \"]\";\n  } else {\n    return \"[unbound Proxy]\";\n  }\n};\n\n/**\n * Get the next ID for a proxy channel.\n * @method nextId\n * @static\n * @private\n */\nfdom.port.Proxy.nextId = function() {\n  if (!fdom.port.Proxy.id) {\n    fdom.port.Proxy.id = 1;\n  }\n  return (fdom.port.Proxy.id += 1);\n};\n","/*globals fdom:true, XMLHttpRequest, Promise */\n/*jslint indent:2,white:true,node:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\n\n/**\n * The Resource registry for FreeDOM.  Used to look up requested Resources,\n * and provide lookup and migration of resources.\n * @Class Resource\n * @constructor\n */\nvar Resource = function() {\n  this.files = {};\n  this.resolvers = [this.httpResolver, this.nullResolver];\n  this.contentRetrievers = {\n    'http': this.xhrRetriever,\n    'https': this.xhrRetriever,\n    'chrome-extension': this.xhrRetriever,\n    'resource': this.xhrRetriever,\n    'chrome': this.xhrRetriever,\n    'file': this.xhrRetriever,\n    'manifest': this.manifestRetriever\n  };\n};\n\n/**\n * Resolve a resurce URL requested from a module.\n * @method get\n * @param {String} manifest The canonical address of the module requesting.\n * @param {String} url The resource to get.\n * @returns {Promise} A promise for the resource address.\n */\nResource.prototype.get = function(manifest, url) {\n  var key = JSON.stringify([manifest, url]);\n  \n  return new Promise(function(resolve, reject) {\n    if (this.files[key]) {\n      resolve(this.files[key]);\n    } else {\n      this.resolve(manifest, url).then(function(key, resolve, address) {\n        this.files[key] = address;\n        //fdom.debug.log('Resolved ' + key + ' to ' + address);\n        resolve(address);\n      }.bind(this, key, resolve), reject);\n    }\n  }.bind(this));\n};\n\n/**\n * Get the contents of a resource.\n * @method getContents\n * @param {String} url The resource to read.\n * @returns {Promise} A promise for the resource contents.\n */\nResource.prototype.getContents = function(url) {\n  return new Promise(function(resolve, reject) {\n    var prop;\n    if (!url) {\n      fdom.debug.warn(\"Asked to get contents of undefined URL.\");\n      return reject();\n    }\n    for (prop in this.contentRetrievers) {\n      if (this.contentRetrievers.hasOwnProperty(prop)) {\n        if (url.indexOf(prop + \"://\") === 0) {\n          return this.contentRetrievers[prop](url, resolve, reject);\n        }\n      }\n    }\n    reject();\n  }.bind(this));\n};\n\n/**\n * Resolve a resource using known resolvers. Unlike get, resolve does\n * not cache resolved resources.\n * @method resolve\n * @private\n * @param {String} manifest The module requesting the resource.\n * @param {String} url The resource to resolve;\n * @returns {Promise} A promise for the resource address.\n */\nResource.prototype.resolve = function(manifest, url) {\n  return new Promise(function(resolve, reject) {\n    var promises = [];\n    if (url === undefined) {\n      return reject();\n    }\n    fdom.util.eachReverse(this.resolvers, function(resolver) {\n      promises.push(new Promise(resolver.bind({}, manifest, url)));\n    }.bind(this));\n    //TODO this would be much cleaner if Promise.any existed\n    Promise.all(promises).then(function(values) {\n      for (var i=0; i<values.length; i++) {\n        if (typeof values[i] !== 'undefined' &&\n            values[i] !== false) {\n          resolve(values[i]);\n          return;\n        }\n      }\n      reject('No resolvers to handle this url: '+JSON.stringify([manifest, url]));\n    });\n  }.bind(this));\n};\n\n/**\n * Register resolvers: code that knows how to get resources\n * needed by the runtime. A resolver will be called with four\n * arguments: the absolute manifest of the requester, the\n * resource being requested, and a resolve / reject pair to\n * fulfill a promise.\n * @method addResolver\n * @param {Function} resolver The resolver to add.\n */\nResource.prototype.addResolver = function(resolver) {\n  this.resolvers.push(resolver);\n};\n\n/**\n * Register retrievers: code that knows how to load resources\n * needed by the runtime. A retriever will be called with a URL\n * to retrieve with a protocol that it is able to handle.\n * @method addRetriever\n * @param {String} proto The protocol to register for.\n * @param {Function} retriever The retriever to add.\n */\nResource.prototype.addRetriever = function(proto, retriever) {\n  if (this.contentRetrievers[proto]) {\n    fdom.debug.warn(\"Unwilling to override file retrieval for \" + proto);\n    return;\n  }\n  this.contentRetrievers[proto] = retriever;\n};\n\n/**\n * Determine if a URL is an absolute URL of a given Scheme.\n * @method hasScheme\n * @static\n * @private\n * @param {String[]} protocols Whitelisted protocols\n * @param {String} URL the URL to match.\n * @returns {Boolean} If the URL is an absolute example of one of the schemes.\n */\nResource.hasScheme = function(protocols, url) {\n  var i;\n  for (i = 0; i < protocols.length; i += 1) {\n    if (url.indexOf(protocols[i] + \"://\") === 0) {\n      return true;\n    }\n  }\n  return false;\n};\n\n/**\n * Resolve URLs which can be accessed using standard HTTP requests.\n * @method httpResolver\n * @private\n * @param {String} manifest The Manifest URL.\n * @param {String} url The URL to resolve.\n * @param {Function} resolve The promise to complete.\n * @param {Function} reject The promise to reject.\n * @returns {Boolean} True if the URL could be resolved.\n */\nResource.prototype.httpResolver = function(manifest, url, resolve, reject) {\n  var protocols = [\"http\", \"https\", \"chrome\", \"chrome-extension\", \"resource\", \"file\"],\n      dirname, protocolIdx, pathIdx, path, base;\n  if (Resource.hasScheme(protocols, url)) {\n    resolve(url);\n    return true;\n  }\n  \n  if (!manifest) {\n    resolve(false);\n    return false;\n  }\n  if (Resource.hasScheme(protocols, manifest) &&\n      url.indexOf(\"://\") === -1) {\n    dirname = manifest.substr(0, manifest.lastIndexOf(\"/\"));\n    protocolIdx = dirname.indexOf(\"://\");\n    pathIdx = protocolIdx + 3 + dirname.substr(protocolIdx + 3).indexOf(\"/\");\n    path = dirname.substr(pathIdx);\n    base = dirname.substr(0, pathIdx);\n    if (url.indexOf(\"/\") === 0) {\n      resolve(base + url);\n    } else {\n      resolve(base + path + \"/\" + url);\n    }\n    return true;\n  }\n  resolve(false);\n  return false;\n};\n\n/**\n * Resolve URLs which are self-describing.\n * @method nullResolver\n * @private\n * @param {String} manifest The Manifest URL.\n * @param {String} url The URL to resolve.\n * @param {Function} resolve The promise to complete.\n * @param {Function} reject The promise to reject.\n * @returns {Boolean} True if the URL could be resolved.\n */\nResource.prototype.nullResolver = function(manifest, url, resolve, reject) {\n  var protocols = [\"manifest\", \"data;base64\"];\n  if (Resource.hasScheme(protocols, url)) {\n    resolve(url);\n    return true;\n  }\n  resolve(false);\n  return false;\n};\n\n/**\n * Retrieve manifest content from a self-descriptive manifest url.\n * These urls are used to reference a manifest without requiring subsequent,\n * potentially non-CORS requests.\n * @method manifestRetriever\n * @private\n * @param {String} manifest The Manifest URL\n * @param {Function} resolve The promise to complete.\n * @param {Function} reject The promise to reject.\n */\nResource.prototype.manifestRetriever = function(manifest, resolve, reject) {\n  var data;\n  try {\n    data = manifest.substr(11);\n    JSON.parse(data);\n    resolve(data);\n  } catch(e) {\n    console.warn(\"Invalid manifest URL referenced:\" + manifest);\n    reject();\n  }\n};\n\n/**\n * Retrieve resource contents using an XHR request.\n * @method xhrRetriever\n * @private\n * @param {String} url The resource to fetch.\n * @param {Function} resolve The promise to complete.\n * @param {Function} reject The promise to reject.\n */\nResource.prototype.xhrRetriever = function(url, resolve, reject) {\n  var ref = new XMLHttpRequest();\n  ref.addEventListener('readystatechange', function(resolve, reject) {\n    if (ref.readyState === 4 && ref.responseText) {\n      resolve(ref.responseText);\n    } else if (ref.readyState === 4) {\n      console.warn(\"Failed to load file \" + url + \": \" + ref.status);\n      reject(ref.status);\n    }\n  }.bind({}, resolve, reject), false);\n  ref.overrideMimeType('application/json');\n  ref.open(\"GET\", url, true);\n  ref.send();\n};\n\n/**\n * Defines fdom.resources as a singleton registry for file management.\n */\nfdom.resources = new Resource();\n","/*globals fdom:true, crypto, freedomcfg, WebKitBlobBuilder, Blob, URL */\n/*globals webkitURL, Uint8Array */\n/*jslint indent:2,white:true,browser:true,sloppy:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\n\n/**\n * Utility method used within the freedom Library.\n * @class util\n * @static\n */\nfdom.util = {};\n\n\n/**\n * Helper function for iterating over an array backwards. If the func\n * returns a true value, it will break out of the loop.\n * @method eachReverse\n * @static\n */\nfdom.util.eachReverse = function(ary, func) {\n  if (ary) {\n    var i;\n    for (i = ary.length - 1; i > -1; i -= 1) {\n      if (ary[i] && func(ary[i], i, ary)) {\n        break;\n      }\n    }\n  }\n};\n\n/**\n * @method hasProp\n * @static\n */\nfdom.util.hasProp = function(obj, prop) {\n  return Object.prototype.hasOwnProperty.call(obj, prop);\n};\n\n/**\n * Cycles over properties in an object and calls a function for each\n * property value. If the function returns a truthy value, then the\n * iteration is stopped.\n * @method eachProp\n * @static\n */\nfdom.util.eachProp = function(obj, func) {\n  var prop;\n  for (prop in obj) {\n    if (obj.hasOwnProperty(prop)) {\n      if (func(obj[prop], prop)) {\n        break;\n      }\n    }\n  }\n};\n\n/**\n * Simple function to mix in properties from source into target,\n * but only if target does not already have a property of the same name.\n * This is not robust in IE for transferring methods that match\n * Object.prototype names, but the uses of mixin here seem unlikely to\n * trigger a problem related to that.\n * @method mixin\n * @static\n */\nfdom.util.mixin = function(target, source, force) {\n  if (source) {\n    fdom.util.eachProp(source, function (value, prop) {\n      if (force || !fdom.util.hasProp(target, prop)) {\n        target[prop] = value;\n      }\n    });\n  }\n  return target;\n};\n\n/**\n * Get a unique ID.\n * @method getId\n * @static\n */\nfdom.util.getId = function() {\n  var guid = 'guid',\n      domain = 12,\n      buffer;\n  if (typeof crypto === 'object') {\n    buffer = new Uint8Array(domain);\n    crypto.getRandomValues(buffer);\n    fdom.util.eachReverse(buffer, function(n) {\n      guid += '-' + n;\n    });\n  } else {\n    while (domain > 0) {\n      guid += '-' + Math.ceil(255 * Math.random());\n      domain -= 1;\n    }\n  }\n\n  return guid;\n};\n\n/**\n * Add 'on' and 'emit' methods to an object, which act as a light weight\n * event handling structure.\n * @class handleEvents\n * @static\n */\nfdom.util.handleEvents = function(obj) {\n  var eventState = {\n    multiple: {},\n    maybemultiple: [],\n    single: {},\n    maybesingle: []\n  }, filter, push;\n\n  /**\n   * Filter a list based on a predicate. The list is filtered in place, with\n   * selected items removed and returned by the function.\n   * @method\n   * @param {Array} list The list to filter\n   * @param {Function} predicate The method to run on each item.\n   * @returns {Array} Selected items\n   */\n  filter = function(list, predicate) {\n    var ret = [], i;\n\n    if (!list || !list.length) {\n      return [];\n    }\n\n    for (i = list.length - 1; i >= 0; i -= 1) {\n      if (predicate(list[i])) {\n        ret.push(list.splice(i, 1));\n      }\n    }\n    return ret;\n  };\n\n  /**\n   * Enqueue a handler for a specific type.\n   * @method\n   * @param {String} to The queue ('single' or 'multiple') to queue on.\n   * @param {String} type The type of event to wait for.\n   * @param {Function} handler The handler to enqueue.\n   */\n  push = function(to, type, handler) {\n    if (typeof type === 'function') {\n      this['maybe' + to].push([type, handler]);\n    } else if (this[to][type]) {\n      this[to][type].push(handler);\n    } else {\n      this[to][type] = [handler];\n    }\n  };\n\n  /**\n   * Register a method to be executed when an event of a specific type occurs.\n   * @method on\n   * @param {String|Function} type The type of event to register against.\n   * @param {Function} handler The handler to run when the event occurs.\n   */\n  obj.on = push.bind(eventState, 'multiple');\n\n  /**\n   * Register a method to be execute the next time an event occurs.\n   * @method once\n   * @param {String|Function} type The type of event to wait for.\n   * @param {Function} handler The handler to run the next time a matching event\n   *     is raised.\n   */\n  obj.once = push.bind(eventState, 'single');\n\n  /**\n   * Emit an event on this object.\n   * @method emit\n   * @param {String} type The type of event to raise.\n   * @param {Object} data The payload of the event.\n   */\n  obj.emit = function(type, data) {\n    var i, queue;\n    if (this.multiple[type]) {\n      for (i = 0; i < this.multiple[type].length; i += 1) {\n        if (this.multiple[type][i](data) === false) {\n          return;\n        }\n      }\n    }\n    if (this.single[type]) {\n      queue = this.single[type];\n      this.single[type] = [];\n      for (i = 0; i < queue.length; i += 1) {\n        queue[i](data);\n      }\n    }\n    for (i = 0; i < this.maybemultiple.length; i += 1) {\n      if (this.maybemultiple[i][0](type, data)) {\n        this.maybemultiple[i][1](data);\n      }\n    }\n    for (i = this.maybesingle.length - 1; i >= 0; i -= 1) {\n      if (this.maybesingle[i][0](type, data)) {\n        queue = this.maybesingle.splice(i, 1);\n        queue[0][1](data);\n      }\n    }\n  }.bind(eventState);\n\n  /**\n   * Remove an event handler\n   * @method off\n   * @param {String} type The type of event to remove.\n   * @param {Function?} handler The handler to remove.\n   */\n  obj.off = function(type, handler) {\n    if (!type) {\n      this.multiple = {};\n      this.maybemultiple = [];\n      this.single = {};\n      this.maybesingle = [];\n      return;\n    }\n\n    if (typeof type === 'function') {\n      filter(this.maybesingle, function(item) {\n        return item[0] === type && (!handler || item[1] === handler);\n      });\n      filter(this.maybemultiple, function(item) {\n        return item[0] === type && (!handler || item[1] === handler);\n      });\n    }\n\n    if (!handler) {\n      delete this.multiple[type];\n      delete this.single[type];\n    } else {\n      filter(this.multiple[type], function(item) {\n        return item === handler;\n      });\n      filter(this.single[type], function(item) {\n        return item === handler;\n      });\n    }\n  }.bind(eventState);\n};\n\n/**\n * When run without a window, or specifically requested.\n * Note: Declaration can be redefined in forceModuleContext below.\n * @method isModuleContext\n * @for util\n * @static\n */\n/*!@preserve StartModuleContextDeclaration*/\nfdom.util.isModuleContext = function() {\n  return (typeof document === 'undefined');\n};\n\n/**\n * Provide a version of src where the 'isModuleContext' function will return\n * true. Used for creating module contexts which may not be able to determine\n * that they need to start up in that mode by themselves.\n * @method forceModuleContext\n * @static\n */\nfdom.util.forceModuleContext = function(src) {\n  var definition = \"function () { return true; }\",\n      idx = src.indexOf('StartModuleContextDeclaration'),\n      funcidx = src.indexOf('function', idx),\n      source,\n      blob;\n  if (idx === -1 || funcidx === -1) {\n    fdom.debug.error('Unable to force mode, source is in unexpected condition.');\n    return;\n  }\n  source = src.substr(0, funcidx) +  definition + ' || ' +\n      src.substr(funcidx);\n  blob = fdom.util.getBlob(source, 'text/javascript');\n  return fdom.util.getURL(blob);\n};\n\n/**\n * Get a Blob object of a string.\n * Polyfills implementations which don't have a current Blob constructor, like\n * phantomjs.\n * @method getBlob\n * @static\n */\nfdom.util.getBlob = function(data, type) {\n  if (typeof Blob !== 'function' && typeof WebKitBlobBuilder !== 'undefined') {\n    var builder = new WebKitBlobBuilder();\n    builder.append(data);\n    return builder.getBlob(type);\n  } else {\n    return new Blob([data], {type: type});\n  }\n};\n\n/**\n * Get a URL of a blob object for inclusion in a frame.\n * Polyfills implementations which don't have a current URL object, like\n * phantomjs.\n * @method getURL\n * @static\n */\nfdom.util.getURL = function(blob) {\n  if (typeof URL !== 'object' && typeof webkitURL !== 'undefined') {\n    return webkitURL.createObjectURL(blob);\n  } else {\n    return URL.createObjectURL(blob);\n  }\n};\n\n/**\n * When running in a priviledged context, honor a global\n * 'freedomcfg' function to allow registration of additional API providers.\n * @method advertise\n * @param {Boolean} force Advertise even if not in a priviledged context.\n * @static\n */\nfdom.util.advertise = function(force) {\n  // TODO: Determine a better mechanism than this whitelisting.\n  if (typeof location !== 'undefined') {\n    if ((location.protocol === 'chrome-extension:' ||\n        location.protocol === 'chrome:' ||\n        location.protocol === 'resource:' || force) &&\n        typeof freedomcfg !== \"undefined\") {\n      freedomcfg(fdom.apis.register.bind(fdom.apis));\n    }\n  } else if (force && typeof freedomcfg !== \"undefined\") {\n    freedomcfg(fdom.apis.register.bind(fdom.apis));\n  }\n};\n\n/**\n * Find all scripts on the given page.\n * @method scripts\n * @static\n */\nfdom.util.scripts = function(global) {\n  return global.document.getElementsByTagName('script');\n};\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.link = fdom.link || {};\n\n/**\n * A port providing message transport between two freedom contexts in the same namespace.\n * Note that using a direct link does not provide the isolation that freedom.js\n * encourages. To that end it should be limited to a method for testing and not\n * used in production without some serious though about the implications of that decision.\n * @class Link.Direct\n * @extends Port\n * @uses handleEvents\n * @constructor\n */\nfdom.link.Direct = function() {\n  fdom.Link.call(this);\n};\n\n/**\n * Start this port.\n * @method start\n * @private\n */\nfdom.link.Direct.prototype.start = function() {\n  if (this.config.moduleContext) {\n    this.config.global.directLink.other = this;\n    this.other = this.config.global.directLink;\n    this.other.emit('started');\n  } else {\n    this.config.global.directLink = this;\n\n    // Keep fdom.debug connected to parent hub.\n    var debug = fdom.debug,\n        child = fdom.setup(this.config.global, undefined, {\n      isModule: true,\n      portType: 'Direct'\n    });\n    fdom.debug = debug;\n    this.config.global.freedom = child;\n  }\n};\n\n/**\n * Stop this port by deleting the frame.\n * @method stop\n * @private\n */\nfdom.link.Direct.prototype.stop = function() {\n  if (this === this.config.global.directLink) {\n    delete this.config.global.directLink;\n  }\n  delete this.other;\n};\n\n/**\n * Get the textual description of this port.\n * @method toString\n * @return {String} the description of this port.\n */\nfdom.link.Direct.prototype.toString = function() {\n  return \"[Direct\" + this.id + \"]\";\n};\n\n/**\n * Receive messages from the hub to this port.\n * Received messages will be emitted from the other side of the port.\n * @method deliverMessage\n * @param {String} flow the channel/flow of the message.\n * @param {Object} message The Message.\n */\nfdom.link.Direct.prototype.deliverMessage = function(flow, message) {\n  if (this.other) {\n    /* //- For Debugging Purposes -\n    if (this === this.config.global.directLink) {\n      console.warn('->[' + flow + '] ' + JSON.stringify(message));\n    } else {\n      console.warn('<-[' + flow + '] ' + JSON.stringify(message));\n    }\n    */\n    if (flow === 'control') {\n      flow = this.other.controlChannel;\n    }\n    setTimeout(this.other.emit.bind(this.other, flow, message), 0);\n  } else {\n    this.once('started', this.onMessage.bind(this, flow, message));\n  }\n};\n\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.link = fdom.link || {};\n\n/**\n * A port providing message transport between two freedom contexts via iFrames.\n * @class link.Frame\n * @extends Link\n * @uses handleEvents\n * @constructor\n */\nfdom.link.Frame = function() {\n  fdom.Link.call(this);\n};\n\n/**\n * Start this port by listening or creating a frame.\n * @method start\n * @private\n */\nfdom.link.Frame.prototype.start = function() {\n  if (this.config.moduleContext) {\n    this.config.global.DEBUG = true;\n    this.setupListener();\n    this.src = 'in';\n  } else {\n    this.setupFrame();\n    this.src = 'out';\n  }\n};\n\n/**\n * Stop this port by deleting the frame.\n * @method stop\n * @private\n */\nfdom.link.Frame.prototype.stop = function() {\n  // Function is determined by setupListener or setupFrame as appropriate.\n};\n\n/**\n * Get the textual description of this port.\n * @method toString\n * @return {String} the description of this port.\n */\nfdom.link.Frame.prototype.toString = function() {\n  return \"[Frame\" + this.id + \"]\";\n};\n\n/**\n * Set up a global listener to handle incoming messages to this\n * freedom.js context.\n * @method setupListener\n */\nfdom.link.Frame.prototype.setupListener = function() {\n  var onMsg = function(msg) {\n    if (msg.data.src !== 'in') {\n      this.emitMessage(msg.data.flow, msg.data.message);\n    }\n  }.bind(this);\n  this.obj = this.config.global;\n  this.obj.addEventListener('message', onMsg, true);\n  this.stop = function() {\n    this.obj.removeEventListener('message', onMsg, true);\n    delete this.obj;\n  };\n  this.emit('started');\n};\n\n/**\n * Set up an iFrame with an isolated freedom.js context inside.\n * @method setupFrame\n */\nfdom.link.Frame.prototype.setupFrame = function() {\n  var frame, onMsg;\n  frame = this.makeFrame(this.config.src, this.config.inject);\n  \n  if (!document.body) {\n    document.appendChild(document.createElement(\"body\"));\n  }\n  document.body.appendChild(frame);\n\n  onMsg = function(frame, msg) {\n    if (!this.obj) {\n      this.obj = frame;\n      this.emit('started');\n    }\n    if (msg.data.src !== 'out') {\n      this.emitMessage(msg.data.flow, msg.data.message);\n    }\n  }.bind(this, frame.contentWindow);\n\n  frame.contentWindow.addEventListener('message', onMsg, true);\n  this.stop = function() {\n    frame.contentWindow.removeEventListener('message', onMsg, true);\n    if (this.obj) {\n      delete this.obj;\n    }\n    frame.src = \"about:blank\";\n    document.body.removeChild(frame);\n  };\n};\n\n/**\n * Make frames to replicate freedom isolation without web-workers.\n * iFrame isolation is non-standardized, and access to the DOM within frames\n * means that they are insecure. However, debugging of webworkers is\n * painful enough that this mode of execution can be valuable for debugging.\n * @method makeFrame\n */\nfdom.link.Frame.prototype.makeFrame = function(src, inject) {\n  var frame = document.createElement('iframe'),\n      extra = '',\n      loader,\n      blob;\n  // TODO(willscott): add sandboxing protection.\n\n  // TODO(willscott): survive name mangling.\n  src = src.replace('portType: \"Worker\"', 'portType: \"Frame\"');\n  if (inject) {\n    extra = '<script src=\"' + inject + '\" onerror=\"' +\n      'throw new Error(\\'Injection of ' + inject +' Failed!\\');' +\n      '\"></script>';\n  }\n  loader = '<html>' + extra + '<script src=\"' +\n      fdom.util.forceModuleContext(src) + '\"></script></html>';\n  blob = fdom.util.getBlob(loader, 'text/html');\n  frame.src = fdom.util.getURL(blob);\n\n  return frame;\n};\n\n/**\n * Receive messages from the hub to this port.\n * Received messages will be emitted from the other side of the port.\n * @method deliverMessage\n * @param {String} flow the channel/flow of the message.\n * @param {Object} message The Message.\n */\nfdom.link.Frame.prototype.deliverMessage = function(flow, message) {\n  if (this.obj) {\n    //fdom.debug.log('message sent to worker: ', flow, message);\n    this.obj.postMessage({\n      src: this.src,\n      flow: flow,\n      message: message\n    }, '*');\n  } else {\n    this.once('started', this.onMessage.bind(this, flow, message));\n  }\n};\n\n","/*globals fdom:true, Worker */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.link = fdom.link || {};\n\n/**\n * A port providing message transport between two freedom contexts via Worker.\n * @class Worker\n * @extends Port\n * @uses handleEvents\n * @constructor\n */\nfdom.link.Worker = function(id) {\n  if (id) {\n    this.manifest = id.substr(id.lastIndexOf('/') + 1);\n  }\n  fdom.Link.call(this);\n};\n\n/**\n * Start this port by listening or creating a worker.\n * @method start\n * @private\n */\nfdom.link.Worker.prototype.start = function() {\n  if (this.config.moduleContext) {\n    this.setupListener();\n  } else {\n    this.setupWorker();\n  }\n};\n\n/**\n * Stop this port by destroying the worker.\n * @method stop\n * @private\n */\nfdom.link.Worker.prototype.stop = function() {\n  // Function is determined by setupListener or setupFrame as appropriate.\n};\n\n/**\n * Get the textual description of this port.\n * @method toString\n * @return {String} the description of this port.\n */\nfdom.link.Worker.prototype.toString = function() {\n  return \"[Worker\" + this.id + \"]\";\n};\n\n/**\n * Set up a global listener to handle incoming messages to this\n * freedom.js context.\n * @method setupListener\n */\nfdom.link.Worker.prototype.setupListener = function() {\n  var onMsg = function(msg) {\n    this.emitMessage(msg.data.flow, msg.data.message);\n  }.bind(this);\n  this.obj = this.config.global;\n  this.obj.addEventListener('message', onMsg, true);\n  this.stop = function() {\n    this.obj.removeEventListener('message', onMsg, true);\n    delete this.obj;\n  };\n  this.emit('started');\n};\n\n/**\n * Set up a worker with an isolated freedom.js context inside.\n * @method setupWorker\n */\nfdom.link.Worker.prototype.setupWorker = function() {\n  var worker, blob;\n  if (typeof (window.Blob) !== typeof (Function)) {\n    worker = new Worker(this.config.source);\n  } else {\n    blob = new window.Blob([this.config.src], {type: 'text/javascript'});\n    worker = new Worker(window.URL.createObjectURL(blob) + '#' + this.manifest);\n  }\n  worker.addEventListener('error', function(err) {\n    fdom.debug.error(err, this.toString());\n  }, true);\n  worker.addEventListener('message', function(worker, msg) {\n    if (!this.obj) {\n      this.obj = worker;\n      this.emit('started');\n    }\n    this.emitMessage(msg.data.flow, msg.data.message);\n  }.bind(this, worker), true);\n  this.stop = function() {\n    worker.stop();\n    if (this.obj) {\n      delete this.obj;\n    }\n  };\n};\n\n/**\n * Receive messages from the hub to this port.\n * Received messages will be emitted from the other side of the port.\n * @method deliverMessage\n * @param {String} flow the channel/flow of the message.\n * @param {Object} message The Message.\n */\nfdom.link.Worker.prototype.deliverMessage = function(flow, message) {\n  if (flow === 'control' && message.type === 'close' &&\n      message.channel === 'control') {\n    this.stop();\n  } else {\n    if (this.obj) {\n      //fdom.debug.log('message sent to worker: ', flow, message);\n      this.obj.postMessage({\n        flow: flow,\n        message: message\n      });\n    } else {\n      this.once('started', this.onMessage.bind(this, flow, message));\n    }\n  }\n};\n\n","/*globals fdom:true, Blob, ArrayBuffer, DataView, Promise */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.proxy = fdom.proxy || {};\n\nfdom.proxy.ApiInterface = function(def, onMsg, emit) {\n  var inflight = {},\n      events = null,\n      emitter = null,\n      reqId = 0,\n      args = arguments;\n\n  fdom.util.eachProp(def, function(prop, name) {\n    switch(prop.type) {\n    case 'method':\n      this[name] = function() {\n        // Note: inflight should be registered before message is passed\n        // in order to prepare for synchronous in-window pipes.\n        var thisReq = reqId,\n            promise = new Promise(function(resolve, reject) {\n              inflight[thisReq] = {\n                resolve:resolve,\n                reject:reject,\n                template: prop.ret\n              };\n            }),\n            streams = fdom.proxy.messageToPortable(prop.value, arguments);\n        reqId += 1;\n        emit({\n          action: 'method',\n          type: name,\n          reqId: thisReq,\n          text: streams.text,\n          binary: streams.binary\n        });\n        return promise;\n      };\n      break;\n    case 'event':\n      if(!events) {\n        fdom.util.handleEvents(this);\n        emitter = this.emit;\n        delete this.emit;\n        events = {};\n      }\n      events[name] = prop;\n      break;\n    case 'constant':\n      Object.defineProperty(this, name, {\n        value: fdom.proxy.recursiveFreezeObject(prop.value),\n        writable: false\n      });\n      break;\n    }\n  }.bind(this));\n\n  onMsg(this, function(type, msg) {\n    if (type === 'close') {\n      this.off();\n      delete this.inflight;\n      return;\n    }\n    if (!msg) {\n      return;\n    }\n    if (msg.type === 'method') {\n      if (inflight[msg.reqId]) {\n        var resolver = inflight[msg.reqId],\n            template = resolver.template;\n        delete inflight[msg.reqId];\n        if (msg.error) {\n          resolver.reject(msg.error);\n        } else {\n          resolver.resolve(fdom.proxy.portableToMessage(template, msg));\n        }\n      } else {\n        fdom.debug.warn('Dropped response message with id ' + msg.reqId);\n      }\n    } else if (msg.type === 'event') {\n      if (events[msg.name]) {\n        emitter(msg.name, fdom.proxy.portableToMessage(events[msg.name].value,\n                msg));\n      }\n    }\n  }.bind(this));\n\n  args = fdom.proxy.messageToPortable(\n      def.constructor ? def.constructor.value : [],\n      Array.prototype.slice.call(args, 3));\n\n  emit({\n    type: 'construct',\n    text: args.text,\n    binary: args.binary\n  });\n};\n\n/**\n * Convert a structured data structure into a message stream conforming to\n * a template and an array of binary data elements.\n * @static\n * @method messageToPortable\n * @param {Object} template The template to conform to\n * @param {Object} value The instance of the data structure to confrom\n * @return {{text: Object, binary: Array}} Separated data streams.\n */\nfdom.proxy.messageToPortable = function(template, value) {\n  var externals = [],\n      message = fdom.proxy.conform(template, value, externals, true);\n  return {\n    text: message,\n    binary: externals\n  };\n};\n\n/**\n * Convert Structured Data streams into a data structure conforming to a\n * template.\n * @static\n * @method portableToMessage\n * @param {Object} template The template to conform to\n * @param {{text: Object, binary: Array}} streams The streams to conform\n * @return {Object} The data structure matching the template.\n */\nfdom.proxy.portableToMessage = function(template, streams) {\n  return fdom.proxy.conform(template, streams.text, streams.binary, false);\n};\n\n/**\n * Force a collection of values to look like the types and length of an API\n * template.\n * @static\n * @method conform\n * @param {Object} template The template to conform to\n * @param {Object} from The value to conform\n * @param {Array} externals Listing of binary elements in the template\n * @param {Boolean} Whether to to separate or combine streams.\n */\nfdom.proxy.conform = function(template, from, externals, separate) {\n  /* jshint -W086 */\n  if (typeof(from) === 'function') {\n    //from = undefined;\n    //throw \"Trying to conform a function\";\n    return undefined;\n  } else if (typeof(from) === 'undefined' || template === undefined) {\n    return undefined;\n  } else if (from === null) {\n    return null;\n  }\n  switch(template) {\n  case 'string':\n    return String('') + from;\n  case 'number':\n    return Number(1) * from;\n  case 'boolean':\n    return Boolean(from === true);\n  case 'object':\n    // TODO(willscott): Allow removal if sandboxing enforces this.\n    if (typeof from === 'undefined') {\n      return undefined;\n    } else {\n      return JSON.parse(JSON.stringify(from));\n    }\n  case 'blob':\n    if (separate) {\n      if (from instanceof Blob) {\n        externals.push(from);\n        return externals.length - 1;\n      } else {\n        fdom.debug.warn('conform expecting Blob, sees ' + (typeof from));\n        externals.push(new Blob([]));\n        return externals.length - 1;\n      }\n    } else {\n      return externals[from];\n    }\n  case 'buffer':\n    if (separate) {\n      externals.push(fdom.proxy.makeArrayBuffer(from));\n      return externals.length - 1;\n    } else {\n      return fdom.proxy.makeArrayBuffer(externals[from]);\n    }\n  case 'proxy':\n    return from;\n  }\n  var val, i;\n  if (Array.isArray(template) && from !== undefined) {\n    val = [];\n    i = 0;\n    if (template.length === 2 && template[0] === 'array') {\n      //console.log(\"template is array, value is \" + JSON.stringify(value));\n      for (i = 0; i < from.length; i += 1) {\n        val.push(fdom.proxy.conform(template[1], from[i], externals,\n                                    separate));\n      }\n    } else {\n      for (i = 0; i < template.length; i += 1) {\n        if (from[i] !== undefined) {\n          val.push(fdom.proxy.conform(template[i], from[i], externals,\n                                      separate));\n        } else {\n          val.push(undefined);\n        }\n      }\n    }\n    return val;\n  } else if (typeof template === 'object' && from !== undefined) {\n    val = {};\n    fdom.util.eachProp(template, function(prop, name) {\n      if (from[name] !== undefined) {\n        val[name] = fdom.proxy.conform(prop, from[name], externals, separate);\n      }\n    });\n    return val;\n  }\n  fdom.debug.warn('Unknown template type: ' + template);\n};\n\n/**\n * Make a thing into an Array Buffer\n * @static\n * @method makeArrayBuffer\n * @param {Object} thing\n * @return {ArrayBuffer} An Array Buffer\n */\nfdom.proxy.makeArrayBuffer = function(thing) {\n  if (!thing) {\n    return new ArrayBuffer(0);\n  }\n\n  if (thing instanceof ArrayBuffer) {\n    return thing;\n  } else if (thing.constructor.name === \"ArrayBuffer\" &&\n      typeof thing.prototype === \"undefined\") {\n    // Workaround for webkit origin ownership issue.\n    // https://github.com/UWNetworksLab/freedom/issues/28\n    return new DataView(thing).buffer;\n  } else {\n    fdom.debug.warn('expecting ArrayBuffer, but saw ' +\n        (typeof thing) + ': ' + JSON.stringify(thing));\n    return new ArrayBuffer(0);\n  }\n};\n\n/**\n * Recursively traverse a [nested] object and freeze its keys from being\n * writable. Note, the result can have new keys added to it, but existing ones\n * cannot be  overwritten. Doesn't do anything for arrays or other collections.\n *\n * @method recursiveFreezeObject\n * @static\n * @param {Object} obj - object to be frozen\n * @return {Object} obj\n **/\nfdom.proxy.recursiveFreezeObject = function(obj) {\n  var k, ret = {};\n  if (typeof obj !== 'object') {\n    return obj;\n  }\n  for (k in obj) {\n    if (obj.hasOwnProperty(k)) {\n      Object.defineProperty(ret, k, {\n        value: fdom.proxy.recursiveFreezeObject(obj[k]),\n        writable: false,\n        enumerable: true\n      });\n    }\n  }\n  return ret;\n};\n","/*globals fdom:true */\n/*jslint indent:2, white:true, node:true, sloppy:true, browser:true */\nif (typeof fdom === 'undefined') {\n  fdom = {};\n}\nfdom.proxy = fdom.proxy || {};\n\nfdom.proxy.EventInterface = function(onMsg, emit) {\n  fdom.util.handleEvents(this);\n  \n  onMsg(this, function(emit, type, msg) {\n    emit(msg.type, msg.message);\n  }.bind(this, this.emit));\n\n  this.emit = function(emitter, type, msg) {\n    emitter({type: type, message: msg}, true);\n  }.bind({}, emit);\n};\n","/*globals fdom:true */\n/*jslint indent:2,sloppy:true */\n\nfdom.apis.set(\"core\", {\n  'createChannel': {type: \"method\", value: [], ret: {\n    channel: \"proxy\",\n    identifier: \"string\"\n  }},\n  'bindChannel': {type: \"method\", value: [\"string\"], ret: \"proxy\"},\n  'getId': {type: \"method\", value: [], ret: [\"array\", \"string\"]}\n});\n\nfdom.apis.set(\"core.view\", {\n  'open': {type: \"method\", value: [\"string\", {\n    'file': \"string\",\n    'code': \"string\"\n  }]},\n  'show': {type: \"method\", value: []},\n  'close': {type: \"method\", value: []},\n  'postMessage': {type: \"method\", value: [\"object\"]},\n\n  'message': {type: \"event\", value: \"object\"},\n  'onClose': {type: \"event\", value: []}\n});\n\nfdom.apis.set(\"core.storage\", {\n  'keys': {type: \"method\", value: [], ret: [\"array\", \"string\"]},\n  'get': {type: \"method\", value: [\"string\"], ret: \"string\"},\n  'set': {type: \"method\", value: [\"string\", \"string\"], ret: \"string\"},\n  'remove': {type: \"method\", value: [\"string\"], ret: \"string\"},\n  'clear': {type: \"method\", value: []}\n});\n\n// A TCP Socket.\nfdom.apis.set(\"core.tcpsocket\", {\n  // Sockets may be constructed bound to a pre-existing id, as in the case of\n  // interacting with a socket accpeted by a server.  If no Id is specified, a\n  // new socket will be created, which can be either connect'ed or listen'ed.\n  'constructor': {\n    value: [\"number\"]\n  },\n\n  // Get info about a socket.  Tells you whether the socket is active and\n  // available host information.\n  'getInfo': {\n    type: \"method\",\n    value: [],\n    ret: {\n      \"connected\": \"boolean\",\n      \"localAddress\": \"string\",\n      \"localPort\": \"number\",\n      \"peerAddress\": \"string\",\n      \"peerPort\": \"number\"\n    }\n  },\n\n  // Close a socket. Will Fail if the socket is not connected or already\n  // closed.\n  'close': {\n    type: \"method\",\n    value: [],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n\n  // Receive notification that the socket has disconnected.\n  'onDisconnect': {type: \"event\", value: {\n    \"errcode\": \"string\",\n    \"message\": \"string\"\n  }},\n  \n  // Connect to a host and port.\n  // Fails with an error if connection fails.\n  'connect': {\n    type: \"method\",\n    value: [\"string\", \"number\"],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n  \n  // Write buffer data to a socket.\n  // Fails with an error if write fails.\n  'write': {\n    type: \"method\",\n    value: [\"buffer\"],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n\n  // Receive data on a connected socket.\n  'onData': {\n    type: \"event\",\n    value: {\"data\": \"buffer\"}\n  },\n\n  // Listen as a server at a specified host and port.\n  // After calling listen the client should listen for 'onConnection' events.\n  // Fails with an error if errors occur while binding or listening.\n  'listen': {\n    type: \"method\",\n    value: [\"string\", \"number\"],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n\n  // Receive a connection.\n  // The socket parameter may be used to construct a new socket.\n  // Host and port information provide information about the remote peer.\n  'onConnection': {type: \"event\", value: {\n    \"socket\": \"number\",\n    \"host\": \"string\",\n    \"port\": \"number\"\n  }}\n});\n\n// A UDP socket.\n// Generally, to use you just need to call bind() at which point onData\n// events will start to flow. Note that bind() should only be called\n// once per instance.\nfdom.apis.set('core.udpsocket', {\n  // Creates a socket, binds it to an interface and port and listens for\n  // messages, dispatching each message as on onData event.\n  // Returns an integer, with zero meaning success and any other value\n  // being implementation-dependant.\n  'bind': {\n    type: 'method',\n    value: [\n      // Interface (address) on which to bind.\n      'string',\n      // Port on which to bind.\n      'number'\n    ],\n    ret: 'number'\n  },\n\n  // Retrieves the state of the socket.\n  // Returns an object with the following properties:\n  //  - localAddress: the socket's local address, if bound\n  //  - localPort: the socket's local port, if bound\n  'getInfo': {type: 'method', value: [], ret: {\n    'localAddress': 'string',\n    'localPort': 'number'\n  }},\n\n  // Sends data to a server.\n  // The socket must be bound.\n  // Returns an integer indicating the number of bytes written, with no\n  // guarantee that the remote side received the data.\n  'sendTo': {\n    type: 'method',\n    value: [\n      // Data to send.\n      'buffer',\n      // Destination address.\n      'string',\n      // Destination port.\n      'number'\n    ],\n    ret: 'number'\n  },\n\n  // Releases all resources associated with this socket.\n  // No-op if the socket is not bound.\n  'destroy': {type: 'method', value: []},\n\n  // Called once for each message received on this socket, once it's\n  // been successfully bound.\n  'onData': {\n    type: 'event',\n    value: {\n      // Zero means success, any other value is implementation-dependent.\n      'resultCode': 'number',\n      // Address from which data was received.\n      'address': 'string',\n      // Port from which data was received.\n      'port': 'number',\n      // Data received.\n      'data': 'buffer'\n    }\n  }\n});\n\nfdom.apis.set(\"core.runtime\", {\n  'createApp': {type: \"method\", value: [\"string\", \"proxy\"]},\n  'resolve': {type: \"method\", value: [\"string\", \"string\"]},\n  'needFile': {type: 'event', value: [\"string\", \"string\"]}\n});\n\nfdom.apis.set('core.echo', {\n  'setup': {type: \"method\", value: [\"string\"]},\n  'send': {type: \"method\", value: [\"string\"]},\n  'message': {type: \"event\", value: \"string\"}\n});\n\n\nfdom.apis.set('core.peerconnection', {\n  // Setup the link to the peer and options for this peer connection.\n  'setup': {\n    type: \"method\",\n    value: [\n      // The freedom.js channel identifier used to setup a signalling chanel.\n      \"string\",\n      // The peerName, used debugging and console messages.\n      \"string\",\n      // The list of STUN servers to use.\n      // The format of a single entry is stun:HOST:PORT, where HOST\n      // and PORT are a stun server hostname and port, respectively.\n      [\"array\", \"string\"]\n    ]\n  },\n\n  // Send a message to the peer.\n  'send': {type: \"method\", value: [{\n    // Data channel id. If provided, will be used as the channel label.\n    // The behavior is undefined if the channel label doesn't exist.\n    \"channelLabel\": \"string\",\n    // One of the bellow should be defined; this is the data to send.\n    \"text\": \"string\",\n    \"binary\": \"blob\",\n    \"buffer\": \"buffer\"\n  }]},\n\n  // Called when we get a message from the peer.\n  'onReceived': {type: \"event\", value: {\n    // The label/id of the data channel.\n    \"channelLabel\": \"string\",\n    // One the below will be specified.\n    \"text\": \"string\",\n    \"binary\": \"blob\",\n    \"buffer\": \"buffer\"\n  }},\n\n  // Open the data channel with this label.\n  'openDataChannel': {type: \"method\", value: [\"string\"]},\n  // Close the data channel with this label.\n  'closeDataChannel': {type: \"method\", value: [\"string\"]},\n\n  // A channel with this id has been opened.\n  'onOpenDataChannel': {type: \"event\", value: {\"channelId\": \"string\"}},\n  // The channale with this id has been closed.\n  'onCloseDataChannel': {type: \"event\", value: {\"channelId\": \"string\"}},\n\n  // Returns the number of bytes that have queued using \"send\", but not\n  // yet sent out. Currently just exposes:\n  // http://www.w3.org/TR/webrtc/#widl-RTCDataChannel-bufferedAmount\n  \"getBufferedAmount\": {type: \"method\",\n                        value: [\"string\"],\n                        ret: \"number\"},\n\n  // Close the peer connection.\n  'close': {type: \"method\", value: []},\n  // The peer connection has been closed.\n  'onClose': {type: \"event\", value: {}}\n});\n\nfdom.apis.set(\"core.websocket\", {\n  // Constructs new websocket. Errors in construction are passed on\n  // through the onError event.\n  'constructor': {value:\n    // URL to connect through\n    [\"string\",\n    // Protocols\n    [\"array\", \"string\"]]},\n  // Send the data to the other side of this connection. Only one of\n  // the entries in the dictionary that is passed will be sent.\n  'send': {\n    type: \"method\",\n    value: [{\n      \"text\": \"string\",\n      \"binary\": \"blob\",\n      \"buffer\": \"buffer\"\n    }],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n  'getReadyState': {\n    type: \"method\",\n    value: [],\n    // 0 -> CONNECTING\n    // 1 -> OPEN\n    // 2 -> CLOSING\n    // 3 -> CLOSED\n    ret: \"number\"\n  },\n  \"getBufferedAmount\": {type: \"method\",\n                        value: [\"string\"],\n                        ret: \"number\"},\n  'close': {\n    type: \"method\",\n    // The first argument is a status code from\n    // https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent\n    value: [\"number\", \"string\"],\n    err: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n  'onMessage': {\n    type: 'event',\n    // The data will be stored in one of the keys,\n    // corresponding with the type received\n    value: {\n      \"text\": \"string\",\n      \"binary\": \"blob\",\n      \"buffer\": \"buffer\"\n    }\n  },\n  'onOpen': {\n    type: 'event',\n    value: []\n  },\n  'onError': {\n    type: 'event',\n    value: {\n      \"errcode\": \"string\",\n      \"message\": \"string\"\n    }\n  },\n  'onClose': {\n    type: 'event',\n    // Values given by WebSockets spec:\n    // http://www.w3.org/TR/websockets/#closeevent\n    value: {\n      \"code\": \"number\",\n      \"reason\": \"string\",\n      \"wasClean\": \"boolean\"\n    }\n  }\n});\n","/*globals fdom:true */\n/*jslint indent:2,sloppy:true */\n/**\n * SOCIAL API\n *\n * API for connecting to social networks and messaging of users.\n * An instance of a social provider encapsulates a single user logging into\n * a single network.\n *\n * The semantics of some properties are defined by the specific provider, eg\n * - Edges in the social network (who is on your roster)\n * - Reliable message passing (or unreliable)\n * - In-order message delivery (or out of order)\n * - Persistent clientId - Whether your clientId changes between logins when\n *    connecting from the same device\n *\n * A <client_state>, used in this API, is defined as:\n * - Information related to a specific device or client of a user\n * - Use cases: \n *   - Returned on changes for friends or my instance in 'onClientState'\n *   - Returned in a global list from 'getClients'\n * {\n *   // Mandatory\n *   'userId': 'string',    // Unique ID of user (e.g. alice@gmail.com)\n *   'clientId': 'string',  // Unique ID of client\n *                          // (e.g. alice@gmail.com/Android-23nadsv32f)\n *   'status': 'string',    // Status of the client. 'STATUS' member.\n *   'timestamp': 'number'  // Timestamp of the last seen time of this device.\n * }\n * \n * A <user_profile>, used in this API, is defined as:\n * - Information related to a specific user (profile information)\n * - Use cases:\n *   - Returned on changes for friends or myself in 'onUserProfile'\n *   - Returned in a global list from 'getUsers'\n * {\n *   // Mandatory\n *   'userId': 'string',    // Unique ID of user (e.g. alice@gmail.com)\n *   'timestamp': 'number'  // Timestamp of last change to the profile\n *   // Optional\n *   'name': 'string',      // Name (e.g. Alice)\n *   'url': 'string',       // Homepage URL\n *   'imageData': 'string', // URI of a profile image.\n * }\n **/\n\nfdom.apis.set('social', {\n  /** \n   * error codes and default messages that may be returned on failures.\n   */\n  'ERRCODE': {type: 'constant', value: {\n    /** GENERAL **/\n    'SUCCESS': 'Success!',\n    // Unknown\n    'UNKNOWN': 'Unknown error',\n    // User is currently offline\n    'OFFLINE': 'User is currently offline',\n\n    /** LOGIN **/\n    // Error authenticating to the server (e.g. invalid credentials)\n    'LOGIN_BADCREDENTIALS': 'Error authenticating with server',\n    // Error with connecting to the server\n    'LOGIN_FAILEDCONNECTION': 'Error connecting to server',\n    // User is already logged in\n    'LOGIN_ALREADYONLINE': 'User is already logged in',\n\n    /** SENDMESSAGE **/\n    // Message sent to invalid destination (e.g. not in user's roster)\n    'SEND_INVALIDDESTINATION': 'Message sent to an invalid destination'\n  }},\n  \n  /**\n   * List of possible statuses for <client_state>.status\n   **/\n  'STATUS': {type: 'constant', value: {\n    // Not logged in\n    'OFFLINE': 'OFFLINE',\n    // This client runs the same freedom.js app as you and is online\n    'ONLINE': 'ONLINE',\n    // This client is online, but does not run the same app (chat client)\n    // (i.e. can be useful to invite others to your freedom.js app)\n    'ONLINE_WITH_OTHER_APP': 'ONLINE_WITH_OTHER_APP'\n  }},\n\n  /**\n   * Log into the network (See below for parameters)\n   * e.g. social.login(Object options)\n   *\n   * @method login\n   * @param {Object} loginOptions - See below\n   * @return {Object} <client_state>\n   **/\n  'login': {\n    type: 'method',\n    value: [{\n      // Optional\n      'agent': 'string',         // Name of the application\n      'version': 'string',       // Version of application\n      'url': 'string',           // URL of application\n      'interactive': 'boolean',  // Allow user interaction from provider.\n                                 // If not set, interpreted as true.\n      'rememberLogin': 'boolean' // Cache login credentials, if not set,\n                                 // interpreted as true.\n    }],\n    ret: {                       // <client_state>, defined above.\n      'userId': 'string',\n      'clientId': 'string',\n      'status': 'string',\n      'timestamp': 'number'\n    },\n    err: {\n      'errcode': 'string',\n      'message': 'string'\n    }\n  },\n\n  /**\n   * Clears cached credentials of the provider.\n   *\n   * @method clearCachedCredentials\n   * @return nothing\n   **/\n  'clearCachedCredentials': {type: 'method', value: []},\n\n  /**\n   * Get <client_state>s that have been observed.\n   * The providers <client_state> may be in this list\n   * getClients may not represent an entire roster, since it may not be\n   * enumerable.\n   * \n   * @method getClients\n   * @return {Object} { \n   *    'clientId1': <client_state>,\n   *    'clientId2': <client_state>,\n   *     ...\n   * } List of <client_state>s indexed by clientId\n   *   On failure, rejects with an error code.\n   **/\n  'getClients': {\n    type: 'method',\n    value: [],\n    ret: 'object',\n    err: {\n      'errcode': 'string',\n      'message': 'string'\n    }\n  },\n\n  /**\n   * Get <user_profile>s that have been observed.\n   * The providers <user_profile> may be in this list\n   * getUsers may not represent an entire roster, since it may not be\n   * enumerable.\n   *\n   * @method getUsers\n   * @return {Object} { \n   *    'userId1': <user_profile>,\n   *    'userId2': <user_profile>,\n   *     ...\n   * } List of <user_profile>s indexed by userId\n   *   On failure, rejects with an error code.\n   **/\n  'getUsers': {\n    type: 'method',\n    value: [],\n    ret: 'object',\n    err: {\n      'errcode': 'string',\n      'message': 'string'\n    }\n  },\n\n  /** \n   * Send a message.\n   * Destination may be a userId or a clientId. If it is a userId, all clients\n   * for that user should receive the message.\n   * \n   * @method sendMessage\n   * @param {String} destination_id The userId or clientId to send to\n   * @param {String} message The message to send.\n   * @return nothing\n   *  On failure, rejects with an error code\n   **/\n  'sendMessage': {\n    type: 'method',\n    value: ['string', 'string'],\n    err: {\n      'errcode': 'string',\n      'message': 'string'\n    }\n  },\n\n  /**\n   * Logout of the network\n   * \n   * @method logout\n   * @return nothing\n   *  On failure, rejects with an error code\n   **/\n  'logout': {\n    type: 'method',\n    value: [],\n    err: {\n      'errcode': 'string',\n      'message': 'string'\n    }\n  },\n\n  /**\n   * Receive an incoming message.\n   **/\n  'onMessage': {type: 'event', value: {\n    'from': {               // <client_state>, defined above.\n      'userId': 'string',\n      'clientId': 'string',\n      'status': 'string',\n      'timestamp': 'number'\n    },\n    'message': 'string'     // message contents\n  }},\n\n  /**\n   * Receive a change to a <user_profile>.\n   **/\n  'onUserProfile': {type: 'event', value: { // <user_profile>, defined above.\n    'userId': 'string',\n    'timestamp': 'number',\n    'name': 'string',\n    'url': 'string',\n    'imageData': 'string'\n  }},\n\n  /**\n   * Receive a change to a <client_state>.\n   **/\n  'onClientState': {type: 'event', value: { // <client_state>, defined above.\n    'userId': 'string',\n    'clientId': 'string',\n    'status': 'string',\n    'timestamp': 'number'\n  }}\n});\n\n","/*globals fdom:true */\r\n/*jslint indent:2,sloppy:true */\r\n/**\r\n * STORAGE API\r\n *\r\n * API for Persistent Storage\r\n * Exposes a key-value get/put interface\r\n **/\r\nfdom.apis.set(\"storage\", {\r\n  /** \r\n   * List of scopes that can preferred when accessing storage.\r\n  **/\r\n  'scope': {type: 'constant', value: {\r\n    // Storage should only last while the app is active.\r\n    'SESSION': 0,\r\n    // Storage should be limited to host the app is bound to.\r\n    'DEVICE_LOCAL': 1,\r\n    // Storage should be synchronized between user devices.\r\n    'USER_LOCAL': 2,\r\n    // Storage should be synchronized across users.\r\n    'SHARED': 3\r\n  }},\r\n\r\n  /**\r\n   * Create a storage provider.\r\n   * @param {Object} options\r\n   *    scope {storage.scope} The preferred storage scope.\r\n   * @constructor\r\n   */\r\n  'constructor': { value: [{\r\n    'scope': 'number'\r\n  }]},\r\n\r\n  /**\r\n   * Fetch an array of all keys\r\n   * e.g. storage.keys() => [string]\r\n   *\r\n   * @method keys\r\n   * @return an array with all keys in the store \r\n   **/\r\n  'keys': {type: \"method\", value: [], ret: [\"array\", \"string\"]},\r\n\r\n  /**\r\n   * Fetch a value for a key\r\n   * e.g. storage.get(String key) => string\r\n   *\r\n   * @method get\r\n   * @param {String} key - key to fetch\r\n   * @return {String} Returns a string with the value, null if doesn't exist\r\n   **/\r\n  'get': {type: \"method\", value: [\"string\"], ret: \"string\"},\r\n\r\n  /**\r\n   * Sets a value to a key\r\n   * e.g. storage.set(String key, String value)\r\n   *\r\n   * @method set\r\n   * @param {String} key - key of value to set\r\n   * @param {String} value - value\r\n   * @return {String} previous value of key if there was one.\r\n   **/\r\n  'set': {type: \"method\", value: [\"string\", \"string\"], ret: \"string\"},\r\n  \r\n  /**\r\n   * Removes a single key\r\n   * e.g. storage.remove(String key)\r\n   *\r\n   * @method remove\r\n   * @param {String} key - key to remove\r\n   * @return {String} previous value of key if there was one.\r\n   **/\r\n  'remove': {type: \"method\", value: [\"string\"], ret: \"string\"},\r\n  \r\n  /**\r\n   * Removes all data from storage\r\n   * e.g. storage.clear()\r\n   *\r\n   * @method clear\r\n   * @return nothing\r\n   **/\r\n  'clear': {type: \"method\", value: []}\r\n\r\n});\r\n","/*globals fdom:true */\n/*jslint indent:2,sloppy:true */\n/**\n * TRANSPORT API\n *\n * API for peer-to-peer communication\n * Useful for sending large binary data between instances\n **/\nfdom.apis.set(\"transport\", {\n  /**\n   * Prepare a P2P connection with initialization parameters\n   * Takes in a signalling pathway (freedom.js channel), which is used\n   * by the transport provider to send/receive signalling messages\n   * to the other side of the P2P connection for setup.\n   *\n   * @method setup\n   * @param {string} name - give this connection a name for logging\n   * @param {proxy} channel - signalling channel\n   * @return nothing.\n   **/\n  'setup': {type: \"method\", value: [\"string\", \"proxy\"]},\n\n  /**\n   * Send binary data to the peer\n   * All data is labelled with a string tag\n   * Any data sent with the same tag is sent in order,\n   * but there is no guarantees between tags\n   *\n   * @method send\n   * @param {string} tag\n   * @param {buffer} data\n   * @return nothing\n   **/\n  'send': {type: \"method\", value: [\"string\", \"buffer\"]},\n\n  /**\n   * Close the connection. Any data queued for sending, or in the\n   * process of sending, may be dropped. If the state of the promse of\n   * the send method is \"pending\" then the data for that send call may\n   * be sending or queued.\n   * \n   * @method close\n   * @return nothing\n   **/\n  'close': {type: \"method\", value: []},\n\n  /**\n   * Event on incoming data (ArrayBuffer)\n   **/\n  'onData': {type: \"event\", value: {\n    \"tag\": \"string\",\n    \"data\": \"buffer\"\n  }},\n\n  /**\n   * Event on successful closing of the connection\n   **/\n  'onClose': {type: \"event\", value: []}\n});\n","/*globals fdom:true */\n/*jslint indent:2,white:true,sloppy:true,sub:true */\n\n\n/**\n * Core freedom services available to all modules.\n * Created by a local manager in response to a 'core' request.\n * @Class Core_unprivileged\n * @constructor\n * @param {Port.Manager} manager The manager this core is connected with.\n * @private\n */\nvar Core_unprivileged = function(manager, postMessage) {\n  this.manager = manager;\n};\n\nCore_unprivileged.unboundChannels = {};\n\nCore_unprivileged.contextId = undefined;\n\n/**\n * Create a custom channel.\n * Returns the structure {channel: fdom.proxy.Deferred, identifier: Object},\n * where the identifier can be 'redeemed' by another module or provider using\n * bind channel, at which point the deferred object will resolve with a channel\n * between the two endpoints.\n * @method createChannel\n * @params {Function} continuation Method to call with the cosntructed structure.\n */\nCore_unprivileged.prototype.createChannel = function(continuation) {\n  var proxy = new fdom.port.Proxy(fdom.proxy.EventInterface),\n      id = fdom.util.getId(),\n      chan = this.getChannel(proxy);\n  this.manager.setup(proxy);\n\n  if (this.manager.delegate && this.manager.toDelegate['core']) {\n    this.manager.emit(this.manager.delegate, {\n      type: 'Delegation',\n      request: 'handle',\n      flow: 'core',\n      message: {\n        type: 'register',\n        id: id\n      }\n    });\n  }\n  Core_unprivileged.unboundChannels[id] = {\n    local: true,\n    proxy: proxy\n  };\n\n  proxy.once('start', this.getChannel.bind(this, proxy));\n\n  continuation({\n    channel: chan,\n    identifier: id\n  });\n};\n\nCore_unprivileged.prototype.getChannel = function(proxy) {\n  var iface = proxy.getProxyInterface(),\n      chan = iface();\n  chan.close = iface.close;\n  chan.onClose = iface.onClose;\n  iface.onClose(chan, function() {\n    proxy.doClose();\n  });\n  return chan;\n};\n\n/**\n * Receive a message from another core instance.\n * Note: Core_unprivileged is not registered on the hub. it is a provider,\n *     as it's location and name would indicate. This function is called by\n *     port-app to relay messages up to higher levels.  More generally, the\n *     messages emitted by the core to 'this.manager.emit(this.mananage.delegate'\n *     Should be onMessaged to the controlling core.\n * @param {String} source The source of the message.\n * @param {Object} msg The messsage from an isolated core provider.\n */\nCore_unprivileged.prototype.onMessage = function(source, msg) {\n  if (msg.type === 'register') {\n    Core_unprivileged.unboundChannels[msg.id] = {\n      remote: true,\n      resolve: msg.reply,\n      source: source\n    };\n  } else if (msg.type === 'clear') {\n    delete Core_unprivileged.unboundChannels[msg.id];\n  } else if (msg.type === 'bind') {\n    if (Core_unprivileged.unboundChannels[msg.id]) {\n      this.bindChannel(msg.id, function() {}, source);\n    }\n  }\n};\n\n/**\n * Bind a custom channel.\n * Creates a proxy interface to the custom channel, which will be bound to\n * the proxy obtained through an earlier createChannel call.\n * channel to a proxy.\n * @method bindChannel\n * @param {Object} identifier An identifier obtained through createChannel.\n * @param {Function} continuation A function to be called with the proxy.\n */\nCore_unprivileged.prototype.bindChannel = function(identifier, continuation, source) {\n  var toBind = Core_unprivileged.unboundChannels[identifier],\n      newSource = !source;\n\n  // when bindChannel is called directly, source will be undefined.\n  // When it is propogated by onMessage, a source for binding will already exist.\n  if (newSource) {\n    fdom.debug.log('making local proxy for core binding');\n    source = new fdom.port.Proxy(fdom.proxy.EventInterface);\n    this.manager.setup(source);\n  }\n\n  // If this is a known identifier and is in the same context, binding is easy.\n  if (toBind && toBind.local) {\n    fdom.debug.log('doing local binding with ' + source);\n    this.manager.createLink(source, identifier, toBind.proxy, 'default');\n    delete Core_unprivileged.unboundChannels[identifier];\n    if (this.manager.delegate && this.manager.toDelegate['core']) {\n      this.manager.emit(this.manager.delegate, {\n        type: 'Delegation',\n        request: 'handle',\n        flow: 'core',\n        message: {\n          type: 'clear',\n          id: identifier\n        }\n      });\n    }\n  } else if (toBind && toBind.remote) {\n    fdom.debug.log('doing remote binding downward');\n    this.manager.createLink(\n        source,\n        newSource ? 'default' : identifier,\n        toBind.source,\n        identifier);\n    toBind.resolve({\n      type: 'Bind Channel',\n      request:'core',\n      flow: 'core',\n      message: {\n        type: 'bind',\n        id: identifier\n      }\n    });\n    delete Core_unprivileged.unboundChannels[identifier];\n  } else if (this.manager.delegate && this.manager.toDelegate['core']) {\n    fdom.debug.warn('delegating bind request for unseen ID:' + identifier);\n    this.manager.emit(this.manager.delegate, {\n      type: 'Delegation',\n      request: 'handle',\n      flow: 'core',\n      message: {\n        type: 'bind',\n        id: identifier\n      }\n    });\n    source.once('start', function(p, cb) {\n      cb(this.getChannel(p));\n    }.bind(this, source, continuation));\n    this.manager.createLink(source,\n        'default',\n        this.manager.hub.getDestination(this.manager.delegate),\n        identifier);\n    delete Core_unprivileged.unboundChannels[identifier];\n    return;\n  } else {\n    fdom.debug.warn('Asked to bind unknown channel: ' + identifier);\n    fdom.debug.log(Core_unprivileged.unboundChannels);\n    continuation();\n    return;\n  }\n\n  if (source.getInterface) {\n    continuation(this.getChannel(source));\n  } else {\n    continuation();\n  }\n};\n\n/**\n * Get the ID of the current freedom.js context.  Provides an\n * array of module URLs, the lineage of the current context.\n * When not in an application context, the ID is the lineage\n * of the current View.\n * @method getId\n * @param {Function} callback The function called with ID information.\n */\nCore_unprivileged.prototype.getId = function(callback) {\n  // TODO: make sure contextID is properly frozen.\n  callback(Core_unprivileged.contextId);\n};\n\n/**\n * Set the ID of the current freedom.js context.\n * @method setId\n * @private\n * @param {String[]} id The lineage of the current context.\n */\nCore_unprivileged.prototype.setId = function(id) {\n  Core_unprivileged.contextId = id;\n};\n\nfdom.apis.register(\"core\", Core_unprivileged);\n","/*globals fdom:true, console */\n/*jslint indent:2,white:true,sloppy:true */\n\n/**\n * A minimal provider implementing the core.echo interface for interaction with\n * custom channels.  Primarily used for testing the robustness of the custom\n * channel implementation.\n * @Class Echo_unprivileged\n * @constructor\n * @param {Module} mod The module creating this provider.\n */\nvar Echo_unprivileged = function(mod, dispatchEvent) {\n  fdom.debug.log('Echo Created!');\n  this.mod = mod;\n  this.dispatchEvent = dispatchEvent;\n  fdom.util.handleEvents(this);\n\n  // The Core object for managing channels.\n  this.mod.once('core', function(Core) {\n    this.core = new Core();\n  }.bind(this));\n  this.mod.emit(this.mod.controlChannel, {\n    type: 'core request delegated to echo',\n    request: 'core'\n  });\n};\n\n/**\n * Setup the provider to echo on a specific proxy. Subsequent messages\n * From the custom channel bound here will be re-emitted as a message\n * from the provider.  Subsequent messages to the provider will be\n * emitted on the bound channel.\n * @param {Object} proxy The identifier for the custom channel to bind.\n * @param {Function} continuation Function to call when setup is complete.\n * @method setup\n */\nEcho_unprivileged.prototype.setup = function(proxy, continuation) {\n  continuation();\n  if (!this.core) {\n    this.dispatchEvent('message', 'no core available to setup proxy with at echo');\n    return;\n  }\n\n  this.core.bindChannel(proxy, function(chan) {\n    if (this.chan) {\n      this.chan.close();\n    }\n    this.chan = chan;\n    this.chan.onClose(function() {\n      delete this.chan;\n    }.bind(this));\n    this.dispatchEvent('message', 'channel bound to echo');\n    this.chan.on('message', function(m) {\n      this.dispatchEvent('message', 'from custom channel: ' + m);\n    }.bind(this));\n  }.bind(this));\n};\n\n/**\n * Send a message to the bound custom channel.\n * @param {String} str The string to send.\n * @param {Function} continuation Function to call when sending is complete.\n * @method send\n */\nEcho_unprivileged.prototype.send = function(str, continuation) {\n  continuation();\n  if (this.chan) {\n    this.chan.emit('message', str);\n  } else {\n    this.dispatchEvent('message', 'no channel available');\n  }\n};\n\nfdom.apis.register(\"core.echo\", Echo_unprivileged);\n","/*globals freedom:true, fdom, WebSocket, console*/\n/*jslint sloppy:true*/\n\n/**\n * A WebSocket core provider.\n * @param {port.Module} module The Module requesting this provider\n * @param {Function} dispatchEvent Function to dispatch events.\n * @param {String} url The Remote URL to connect with.\n * @param {String[]} protocols SubProtocols to open.\n * @param {WebSocket?} socket An alternative socket class to use.\n */\nvar WS = function (module, dispatchEvent, url, protocols, socket) {\n  var WSImplementation = socket || WebSocket;\n\n  this.dispatchEvent = dispatchEvent;\n  try {\n    if (protocols) {\n      this.websocket = new WSImplementation(url, protocols);\n    } else {\n      this.websocket = new WSImplementation(url);\n    }\n  } catch (e) {\n    var error = {};\n    if (e instanceof SyntaxError) {\n      error.errcode = 'SYNTAX';\n    } else {\n      error.errcode = e.name;\n    }\n    error.message = e.message;\n    dispatchEvent('onError', error);\n    return;\n  }\n\n  this.websocket.onopen = this.onOpen.bind(this);\n  this.websocket.onclose = this.onClose.bind(this);\n  this.websocket.onmessage = this.onMessage.bind(this);\n  this.websocket.onerror = this.onError.bind(this);\n};\n\nWS.prototype.send = function(data, continuation) {\n  var toSend = data.text || data.binary || data.buffer;\n  var errcode, message;\n\n  if (toSend) {\n    try {\n      this.websocket.send(toSend);\n    } catch (e) {\n      if (e instanceof SyntaxError) {\n        errcode = \"SYNTAX\";\n      } else {\n        errcode = \"INVALID_STATE\";\n      }\n      message = e.message;\n    }\n  } else {\n    errcode = \"BAD_SEND\";\n    message = \"No text, binary, or buffer data found.\";\n  }\n\n  if (errcode) {\n    continuation(undefined, {\n      errcode: errcode,\n      message: message\n    });\n  } else {\n    continuation();\n  }\n};\n\nWS.prototype.getReadyState = function(continuation) {\n  continuation(this.websocket.readyState);\n};\n\nWS.prototype.getBufferedAmount = function(continuation) {\n  continuation(this.websocket.bufferedAmount);\n};\n\nWS.prototype.close = function(code, reason, continuation) {\n  try {\n    if (code && reason) {\n      this.websocket.close(code, reason);\n    } else {\n      this.websocket.close();\n    }\n    continuation();\n  } catch (e) {\n    var errorCode;\n    if (e instanceof SyntaxError) {\n      errorCode = \"SYNTAX\";\n    } else {\n      errorCode = \"INVALID_ACCESS\";\n    }\n    continuation(undefined,{\n      errcode: errorCode,\n      message: e.message\n    });\n  }\n};\n\nWS.prototype.onOpen = function(event) {\n  this.dispatchEvent('onOpen');\n};\n\nWS.prototype.onMessage = function(event) {\n  var data = {};\n  if (event.data instanceof ArrayBuffer) {\n    data.buffer = data;\n  } else if (event.data instanceof Blob) {\n    data.binary = data;\n  } else if (typeof event.data === 'string') {\n    data.text = event.data;\n  }\n  this.dispatchEvent('onMessage', data);\n};\n\nWS.prototype.onError = function(event) {\n  // Nothing to pass on\n  // See: http://stackoverflow.com/a/18804298/300539\n  this.dispatchEvent('onError');\n};\n\nWS.prototype.onClose = function(event) {\n  this.dispatchEvent('onClose',\n                     {code: event.code,\n                      reason: event.reason,\n                      wasClean: event.wasClean});\n};\n\nfdom.apis.register('core.websocket', WS);\n","/*globals fdom, document */\r\n/*jslint indent:2,sloppy:true */\r\n/**\r\n * A FreeDOM view is provided as a core service for displaying some UI.\r\n * Implementation is currently designed as a sandboxed iFrame that the\r\n * browser treats as a 'null' origin, whose sendMessage channel is\r\n * given to the provider.\r\n * @Class View_unprivileged\r\n * @constructor\r\n * @private\r\n * @param {App} app The application creating this provider.\r\n */\r\nvar View_unprivileged = function (app, dispatchEvent) {\r\n  this.dispatchEvent = dispatchEvent;\r\n  this.host = null;\r\n  this.win = null;\r\n  this.app = app;\r\n  fdom.util.handleEvents(this);\r\n};\r\n\r\n/**\r\n * Ask for this view to open a specific location, either a File relative to\r\n * the loader, or an explicit code location.\r\n * @method open\r\n * @param {String} name The identifier of the view. Used to choose attachment.\r\n * @param {Object} what What UI to load.\r\n * @param {Function} continuation Function to call when view is loaded.\r\n */\r\nView_unprivileged.prototype.open = function (name, what, continuation) {\r\n  this.host = document.createElement(\"div\");\r\n  this.host.style.width = \"100%\";\r\n  this.host.style.height = \"100%\";\r\n  this.host.style.display = \"relative\";\r\n\r\n  var container = document.body,\r\n    config = this.app.manifest.views,\r\n    root,\r\n    frame;\r\n  if (config && config[name] && document.getElementById(name)) {\r\n    container = document.getElementById(name);\r\n  }\r\n\r\n  container.appendChild(this.host);\r\n  root = this.host;\r\n  // TODO(willscott): Support shadow root as available.\r\n  // if (this.host['webkitCreateShadowRoot']) {\r\n  //   root = this.host['webkitCreateShadowRoot']();\r\n  // }\r\n  frame = document.createElement(\"iframe\");\r\n  frame.setAttribute(\"sandbox\", \"allow-scripts allow-forms\");\r\n  if (what.file) {\r\n    fdom.resources.get(this.app.manifestId, what.file).then(function (fname) {\r\n      this.finishOpen(root, frame, fname, continuation);\r\n    }.bind(this));\r\n  } else if (what.code) {\r\n    this.finishOpen(root, frame, \"data:text/html;charset=utf-8,\" + what.code, continuation);\r\n  } else {\r\n    continuation(false);\r\n  }\r\n};\r\n\r\nView_unprivileged.prototype.finishOpen = function (root, frame, src, continuation) {\r\n  frame.src = src;\r\n  frame.style.width = \"100%\";\r\n  frame.style.height = \"100%\";\r\n  frame.style.border = \"0\";\r\n  frame.style.background = \"transparent\";\r\n  root.appendChild(frame);\r\n\r\n  this.app.config.global.addEventListener('message', this.onMessage.bind(this), true);\r\n\r\n  this.win = frame;\r\n  continuation({});\r\n};\r\n\r\nView_unprivileged.prototype.show = function (continuation) {\r\n  continuation();\r\n};\r\n\r\nView_unprivileged.prototype.postMessage = function (args, continuation) {\r\n  this.win.contentWindow.postMessage(args, '*');\r\n  continuation();\r\n};\r\n\r\nView_unprivileged.prototype.close = function (continuation) {\r\n  if (this.host) {\r\n    this.host.parentNode.removeChild(this.host);\r\n    this.host = null;\r\n  }\r\n  if (this.win) {\r\n    this.app.config.global.removeEventListener('message', this.onMessage.bind(this), true);\r\n    this.win = null;\r\n  }\r\n  continuation();\r\n};\r\n\r\nView_unprivileged.prototype.onMessage = function (m) {\r\n  if (m.source === this.win.contentWindow) {\r\n    this.dispatchEvent('message', m.data);\r\n  }\r\n};\r\n\r\nfdom.apis.register(\"core.view\", View_unprivileged);\r\n","/*globals chrome,fdom:true,console*/\n/*jslint indent:2,white:true,sloppy:true */\n\n/**\n * A storage provider using chrome's local extension storage pool.\n * @constructor\n */\nvar Storage_chrome = function(channel, dispatch) {\n  this.dispatchEvents = dispatch;\n  this.channel = channel;\n};\n\nStorage_chrome.prototype.keys = function(continuation) {\n  chrome.storage.local.get(null, function(data) {\n    var keys = [], item;\n    for (item in data) {\n      if (data.hasOwnProperty(item)) {\n        keys.push(item);\n      }\n    }\n    continuation(keys);\n  });\n};\n\nStorage_chrome.prototype.get = function(key, continuation) {\n  try {\n    // console.log('storage_chrome: looking up ' + key);\n    var val = chrome.storage.local.get(key, function(k, cb, items) {\n      cb(items[k]);\n    }.bind({}, key, continuation));\n  } catch(e) {\n    continuation(null);\n  }\n};\n\nStorage_chrome.prototype.set = function(key, value, continuation) {\n  // console.log('storage_chrome: saving ' + key);\n  var diff = {};\n  diff[key] = value;\n  chrome.storage.local.set(diff, continuation);\n};\n\nStorage_chrome.prototype.remove = function(key, continuation) {\n  // console.log('storage_chrome: removing ' + key);\n  chrome.storage.local.remove(key, continuation);\n};\n\nStorage_chrome.prototype.clear = function(continuation) {\n  // console.log('storage_chrome: clear all');\n  chrome.storage.local.clear(continuation);\n};\n\n/** REGISTER PROVIDER **/\nif (typeof fdom !== 'undefined') {\n  fdom.apis.register(\"core.storage\", Storage_chrome);\n}\n","/*globals chrome,fdom:true,console,Promise*/\n/*jslint indent:2,white:true,sloppy:true */\n/**\n * A freedom.js interface to Chrome sockets\n * @constructor\n * @private\n * @param {fdom.Port} channel the module creating this provider.\n * @param {Function} dispatchEvent Method for emitting events.\n * @param {number?} id A pre-existing socket Id for the socket.\n */\nvar Socket_chrome = function(channel, dispatchEvent, id) {\n  console.warn(id);\n  this.dispatchEvent = dispatchEvent;\n  this.id = id || undefined;\n  if (this.id) {\n    this.read();\n  }\n};\n\n/**\n * Get Information about the socket.\n * @method getInfo\n * @return {Object} connection and address information about the socket.\n */\nSocket_chrome.prototype.getInfo = function(continuation) {\n  if (this.id) {\n    chrome.socket.getInfo(this.id, continuation);\n  } else {\n    continuation({\n      connected: false\n    });\n  }\n};\n\n/**\n * Connect to a designated location and begin reading.\n * @method connect\n * @param {String} hostname The host or ip to connect to.\n * @param {number} port The port to connect on.\n * @param {Function} cb Function to call with completion or error.\n */\nSocket_chrome.prototype.connect = function(hostname, port, cb) {\n  if (this.id) {\n    cb(undefined, {\n      \"errcode\": \"ALREADY_CONNECTED\",\n      \"message\": \"Cannot Connect Existing Socket\"\n    });\n    return;\n  }\n  chrome.socket.create('tcp', {}, function(createInfo) {\n    this.id = createInfo.socketId;\n    chrome.socket.connect(this.id, hostname, port, function (result) {\n      if (result < 0) {\n        cb(undefined, {\n          \"errcode\": \"CONNECTION_FAILED\",\n          \"message\": \"Chrome Connection Failed: \" +\n              Socket_chrome.ERROR_MAP[result]\n        });\n      } else {\n        cb();\n      }\n      this.read();\n    }.bind(this));\n  }.bind(this));\n};\n\nSocket_chrome.prototype.write = function(data, cb) {\n  if (!this.id) {\n    cb(undefined, {\n      \"errcode\": \"SOCKET_CLOSED\",\n      \"message\": \"Cannot Write on Closed Socket\"\n    });\n    return;\n  }\n  chrome.socket.write(this.id, data, cb);\n};\n\n\n// Error codes are at:\n// https://code.google.com/p/chromium/codesearch#\n//     chromium/src/net/base/net_error_list.h\nSocket_chrome.ERROR_MAP = {\n  '-1': 'IO_PENDING',\n  '-2': 'FAILED',\n  '-3': 'ABORTED',\n  '-4': 'INVALID_ARGUMENT',\n  '-5': 'INVALID_HANDLE',\n  '-7': 'TIMED_OUT',\n  '-13': 'OUT_OF_MEMORY',\n  '-15': 'SOCKET_NOT_CONNECTED',\n  '-21': 'NETWORK_CHANGED',\n  '-23': 'SOCKET_IS_CONNECTED',\n  '-100': 'CONNECTION_CLOSED',\n  '-101': 'CONNECTION_RESET',\n  '-102': 'CONNECTION_REFUSED',\n  '-103': 'CONNECTION_ABORTED',\n  '-104': 'CONNECTION_FAILED',\n  '-105': 'NAME_NOT_RESOLVED',\n  '-106': 'INTERNET_DISCONNECTED'\n};\n\n/*\n * Read data on a socket in an event loop until the socket is closed or an\n * error occurs.\n * @method read\n * @private\n */\nSocket_chrome.prototype.read = function() {\n  var loop;\n  loop = function() {\n    return this.doRead()\n    .then(this.checkReadResult.bind(this))\n    .then(function(data) {\n      this.dispatchEvent('onData', {\n        data: data\n      });\n    }.bind(this))\n    .then(loop);\n  }.bind(this);\n  \n  loop().then(null, function(err) {\n    console.warn('Read Error [' + this.id + ']: ' + err.message);\n    this.dispatchEvent('onDisconnect', {\n      errcode: \"READ_ERROR\",\n      message: err.message\n    });\n  }.bind(this));\n};\n\n/**\n * Return a promise based on a chrome.read call.\n * @method doRead\n * @private\n */\nSocket_chrome.prototype.doRead = function() {\n  return new Promise(function(resolve) {\n    chrome.socket.read(this.id, null, resolve);\n  }.bind(this));\n};\n\n/**\n * Check the result code of a read - if non-positive, reject\n * the promise, otherwise pass along.\n * @method checkReadResult\n * @private\n * @param {ChromeReadInfo} readInfo The result of a chrome.socket.read call\n */\nSocket_chrome.prototype.checkReadResult = function(readInfo) {\n  var code = readInfo.resultCode;\n  if (code === 0) {\n    return Promise.reject(new Error('remotely closed.'));\n  } else if (code < 0) {\n    return Promise.reject(new Error(Socket_chrome.ERROR_MAP[String(code)] ||\n        code));\n  } else {\n    return Promise.resolve(readInfo.data);\n  }\n};\n\n/**\n * Listen on a socket to accept new clients.\n * @method listen\n * @param {String} address the address to listen on\n * @param {number} port the port to listen on\n * @param {Function} callback Callback to call when listening has occured.\n */\nSocket_chrome.prototype.listen = function(address, port, callback) {\n  if (this.id) {\n    callback(undefined, {\n      errcode: \"ALREADY_CONNECTED\",\n      message: \"Cannot Listen on existing socket.\"\n    });\n    return;\n  }\n  chrome.socket.create('tcp', {}, function(createInfo) {\n    this.id = createInfo.socketId;\n    chrome.socket.listen(this.id, address, port, null,\n        this.accept.bind(this, callback));\n  }.bind(this));\n};\n\nSocket_chrome.prototype.accept = function(callback, result) {\n  var acceptCallback;\n\n  if (result !== 0) {\n    callback(undefined, {\n      errcode: \"CONNECTION_FAILURE\",\n      message: \"Chrome Listen failed: \" +\n          Socket_chrome.ERROR_MAP[result]\n    });\n    return;\n  } else {\n    callback();\n  }\n\n  // Begin accepting on the listening socket.\n  acceptCallback = function(acceptInfo) {\n    if (acceptInfo.resultCode === 0) {\n      chrome.socket.getInfo(acceptInfo.socketId, function(info) {\n        this.dispatchEvent('onConnection', {\n          socket: acceptInfo.socketId,\n          host: info.peerAddress,\n          port: info.peerPort\n        });\n      }.bind(this));\n      chrome.socket.accept(this.id, acceptCallback);\n    // -15 is socket_not_connected.\n    } else if (acceptInfo.resultCode !== -15) {\n      console.warn('Failed to accept ' + this.id + ': ' +\n          acceptInfo.resultCode);\n    } else {\n      chrome.socket.accept(this.id, acceptCallback);\n    }\n  }.bind(this);\n\n  chrome.socket.accept(this.id, acceptCallback);\n};\n\n/**\n * Close and Destroy a socket\n * @method close\n * @param {Function} continuation Function to call once socket is destroyed.\n */\nSocket_chrome.prototype.close = function(continuation) {\n  if (this.id) {\n    chrome.socket.disconnect(this.id);\n    chrome.socket.destroy(this.id);\n    delete this.id;\n    continuation();\n  } else {\n    continuation(undefined, {\n      \"errcode\": \"SOCKET_CLOSED\",\n      \"message\": \"Socket Already Closed\"\n    });\n  }\n};\n\n/** REGISTER PROVIDER **/\nif (typeof fdom !== 'undefined') {\n  fdom.apis.register(\"core.tcpsocket\", Socket_chrome);\n}\n","/*globals chrome,fdom:true,console,Promise*/\n/*jslint indent:2,white:true,sloppy:true */\n/**\n * A freedom.js interface to Chrome sockets\n * @constructor\n * @private\n * @param {fdom.Port} channel the module creating this provider.\n * @param {Function} dispatchEvent Method for emitting events.\n */\nvar UdpSocket_chrome = function(channel, dispatchEvent) {\n  this.dispatchEvent = dispatchEvent;\n  this.id = undefined;\n};\n\n\n/**\n * Bind the UDP Socket to a specific host and port.\n * If no addres is specified, 0.0.0.0 will be used.\n * If no port is specified, a local port will be chosen.\n * @param {String?} address The interface to bind on.\n * @param {number?} port The port to bind on\n * @param {Function} continuation A function to call after binding.\n */\nUdpSocket_chrome.prototype.bind = function(address, port, continuation) {\n  chrome.socket.create('udp', {}, function(createResult) {\n    this.id = createResult.socketId;\n    chrome.socket.bind(this.id, address, port, function(bindResult) {\n      if (bindResult >= 0) {\n        continuation(bindResult);\n        this.read();\n      } else {\n        continuation(undefined, {\n          errcode: \"BIND_FAILED\",\n          message: \"Failed to Bind: \" + bindResult\n        });\n      }\n    }.bind(this));\n  }.bind(this));\n};\n\n/**\n * Get Information about the socket.\n * @method getInfo\n * @return {Object} connection and address information about the socket.\n */\nUdpSocket_chrome.prototype.getInfo = function(continuation) {\n  if (this.id) {\n    chrome.socket.getInfo(this.id, continuation);\n  } else {\n    continuation({\n      connected: false\n    });\n  }\n};\n\n/**\n * Read from the socket until an error occurs.\n * @method read\n * @private\n */\nUdpSocket_chrome.prototype.read = function() {\n  chrome.socket.recvFrom(this.id, null, function(recvFromInfo) {\n    if (recvFromInfo.resultCode < 0) {\n      console.warn('Failed to read from ' + this.id + ': ' +\n          recvFromInfo.resultCode);\n      return;\n    }\n\n    this.dispatchEvent('onData', {\n      resultCode: recvFromInfo.resultCode,\n      address: recvFromInfo.address,\n      port: recvFromInfo.port,\n      data: recvFromInfo.data\n    });\n    this.read();\n  }.bind(this));\n};\n\n/**\n * Send data on this socket to a host and port.\n * @method sendTo\n * @param {ArrayBuffer} data The data to send.\n * @param {String} address The destination address\n * @param {number} port The destination port\n * @param {Function} cb A function to call after writing completes.\n */\nUdpSocket_chrome.prototype.sendTo = function(data, address, port, cb) {\n  if (!this.id) {\n    cb(undefined, {\n      \"errcode\": \"SOCKET_CLOSED\",\n      \"message\": \"Cannot Write on Closed Socket\"\n    });\n    return;\n  }\n\n  chrome.socket.sendTo(this.id, data, address, port, function(writeInfo) {\n    cb(writeInfo.bytesWritten);\n  });\n};\n\n/**\n * Destroy a UDP socket.\n * @method destroy\n * @param {Function} continuation Function to call after socket destroyed.\n */\nUdpSocket_chrome.prototype.destroy = function(continuation) {\n  if (this.id && this.id !== 'INVALID') {\n    chrome.socket.destroy(this.id);\n    this.id = 'INVALID';\n    continuation();\n  } else {\n    continuation(undefined, {\n      \"errcode\": \"SOCKET_CLOSED\",\n      \"message\": \"Socket Already Closed\"\n    });\n  }\n};\n\n/** REGISTER PROVIDER **/\nif (typeof fdom !== 'undefined') {\n  fdom.apis.register(\"core.udpsocket\", UdpSocket_chrome);\n}\n"]}